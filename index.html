<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplikasi OSCE D3 Kebidanan</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    #rubric-difficulty-chart { max-height: 500px; width: 100% !important; height: auto !important; }
    :root{--primary-color:#D94689;--secondary-color:#C23A79;--success-color:#198754;--warning-color:#ffc107;--danger-color:#dc3545;--info-color:#0dcaf0;--background-color:#FFF0F5;--card-bg-color:#ffffff;--text-color:#333;--heading-color:#212529;--shadow-color:rgba(217,70,137,0.15);--font-family:'Poppins',sans-serif}body{background-color:var(--background-color);font-family:var(--font-family);color:var(--text-color)}.navbar{background:linear-gradient(90deg,var(--primary-color),#F06292);box-shadow:0 4px 12px var(--shadow-color)}.navbar-brand{font-weight:700;font-size:1.5rem}.nav-link{font-weight:500;transition:color .3s ease}.nav-link i{margin-right:8px}.nav-item .nav-link.active{background-color:rgba(255,255,255,0.2);border-radius:5px}.page{display:none;animation:fadeIn .5s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.page.active{display:block}.card{border:none;border-radius:12px;box-shadow:0 6px 20px var(--shadow-color);overflow:hidden;transition:transform .2s ease}.card:hover{transform:translateY(-3px)}.card-header{background-color:var(--card-bg-color);border-bottom:1px solid #e0e0e0;font-size:1.2rem;font-weight:600;color:var(--heading-color);padding:1rem 1.5rem}.card-header i{margin-right:10px;color:var(--primary-color)}.stat-card{background-color:var(--card-bg-color);border-left:5px solid var(--primary-color);padding:1.25rem}.stat-card .stat-icon{font-size:2.5rem;opacity:.3}.stat-card .stat-value{font-size:2rem;font-weight:700;color:var(--heading-color)}.stat-card .stat-label{font-weight:500;color:#6c757d}.stat-card.border-success{border-left-color:var(--success-color)}.stat-card.border-warning{border-left-color:var(--warning-color)}.stat-card.border-danger{border-left-color:var(--danger-color)}.table-hover tbody tr:hover{background-color:#f1f1f1}.modal-header{background-color:var(--primary-color);color:white}.modal-header .btn-close{filter:invert(1) grayscale(100%) brightness(200%)}#syncModal .modal-body{text-align:center}.spinner-border{width:3rem;height:3rem}#timer-display{font-size:2rem;font-weight:700;letter-spacing:2px}.timer-warning{color:var(--warning-color)!important}.timer-danger{color:var(--danger-color)!important}
    #login-page{display:flex;align-items:center;justify-content:center;min-height:100vh;background-color:#fce4ec}#app-container{display:none}
    @media (max-width: 767px) { .rubric-item .btn-check + .btn-outline-primary { padding: 0.5rem 0.9rem; font-size: 1.1rem; } }
    .live-monitor-card .card-body { padding: 1rem; } .live-monitor-card .countdown { font-size: 1.5rem; font-weight: 700; }
    /* Styles for About Developer Page */
    #page-about-developer { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to right, #fce4ec, #fff0f5); color: #333; padding: 2rem 0; }
    #page-about-developer .container-about { max-width: 900px; margin: 0 auto; background: white; padding: 25px; box-shadow: 0 0 20px rgba(0,0,0,0.1); border-radius: 15px; }
    #page-about-developer .profile-photo { width: 140px; height: 140px; object-fit: cover; border-radius: 50%; display: block; margin: 0 auto 20px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    #page-about-developer h1, #page-about-developer h2 { color: #ad1457; text-align: center; }
    #page-about-developer h1 { font-family: 'Poppins', sans-serif; }
    #page-about-developer ul { padding-left: 20px; list-style-position: inside; }
    #page-about-developer ul li { margin-bottom: 8px; }
    #page-about-developer a { color: #880e4f; text-decoration: none; font-weight: 500; }
    #page-about-developer a:hover { text-decoration: underline; }
    #page-about-developer .contact-box { margin-top: 20px; background: #f8bbd0; padding: 15px; border-left: 5px solid #ec407a; border-radius: 10px; }
    #page-about-developer .footer-about { text-align: center; margin-top: 40px; font-size: 14px; color: #888; }
    /* Star rating for feedback */
    .star-rating { unicode-bidi: bidi-override; color: #ccc; font-size: 2rem; direction: rtl; text-align: center; }
    .star-rating > span { display: inline-block; position: relative; width: 1.1em; }
    .star-rating > span:hover:before, .star-rating > span:hover ~ span:before { content: "\2605"; position: absolute; color: #ffc107; }
    .star-rating > input:checked ~ span:before { content: "\2605"; position: absolute; color: #ffc107; }
    .text-purple { color: #ab47bc !important; }
</style>

<!-- ================================================================= -->
<!-- DATA DARI FILE JSON DISEMATKAN DI SINI (JIKA PERLU) -->
<!-- ================================================================= -->

</head>
<body>

<div id="login-page">
    <div class="card shadow-lg" style="width: 22rem;">
        <div class="card-body p-4 text-center">
            <!-- Tambahkan logo di sini -->
            
<h4 class="card-title mb-1">
    <i class="fas fa-stethoscope text-primary"></i> Midwife OSCE Management
</h4>
<div class="text-muted" style="margin-top: -4px;">
    <i class="fas fa-female text-pink me-1"></i>
    <strong>‚ù§Ô∏èMOM‚ù§Ô∏è</strong>
    <i class="fas fa-female text-pink me-1"></i>
</div>

            <p class="text-muted mb-4">Silakan login untuk melanjutkan</p>
            <form id="login-form">
                <div class="mb-3 text-start">
                    <label for="username" class="form-label">Username (NIM/NIDN/ID)</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3 text-start">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div id="login-error" class="alert alert-danger d-none" role="alert"></div>
                <button type="submit" class="btn btn-primary w-100 mt-2">Login</button>
            </form>
        </div>
<div class="card-footer text-center py-3" style="background: linear-gradient(90deg, #f8eaf6, #ede7f6); color:#4a148c; font-size:14px; border-top:2px solid #ce93d8;">
    <div> ‚ù§Ô∏è Designed with purpose by ‚ù§Ô∏è</div>
    <div>üå∏<strong>Diyan Maria Kristin, SST, M.Kes</strong>üå∏</div>
    <div><strong>Copyright ¬© 2025 www.masandigital.com</strong></div>
</div>

    </div>
</div>


<div id="app-container">
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
    <a class="navbar-brand" href="#" data-page="page-dashboard"><i class="fas fa-stethoscope"></i> Midwife OSCE</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ms-auto">
    <!-- Admin & Penguji links -->
    <li class="nav-item role-admin"><a class="nav-link active" href="#" data-page="page-dashboard"><i class="fas fa-tachometer-alt"></i> Beranda</a></li>
    <li class="nav-item dropdown role-admin">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown"><i class="fas fa-cogs"></i> Manajemen</a>
        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <li><a class="dropdown-item" href="#" data-page="page-peserta"><i class="fas fa-users"></i> Peserta</a></li>
            <li><a class="dropdown-item" href="#" data-page="page-penguji"><i class="fas fa-user-tie"></i> Penguji</a></li>
            <li><a class="dropdown-item" href="#" data-page="page-station"><i class="fas fa-sitemap"></i> Station</a></li>
        </ul>
    </li>
    <li class="nav-item role-admin role-penguji"><a class="nav-link" href="#" data-page="page-penilaian"><i class="fas fa-clipboard-list"></i> Penilaian</a></li>
    <li class="nav-item role-admin"><a class="nav-link" href="#" data-page="page-hasil"><i class="fas fa-chart-bar"></i> Hasil</a></li>
    <li class="nav-item role-admin"><a class="nav-link" href="#" data-page="page-feedback-summary"><i class="fas fa-comment-dots"></i> Feedback</a></li>
    <li class="nav-item role-penguji d-none">
        <button class="btn btn-info" onclick="pushPengujiScores()"><i class="fas fa-cloud-upload-alt"></i> Kirim Nilai</button>
    </li>
    <!-- Peserta Links -->
    <li class="nav-item role-peserta d-none"><a class="nav-link active" href="#" data-page="page-peserta-dashboard"><i class="fas fa-user-graduate"></i> Dashboard</a></li>
    <li class="nav-item role-peserta d-none"><a class="nav-link" href="#" data-page="page-peserta-hasil"><i class="fas fa-poll-h"></i> Hasil & Umpan Balik</a></li>
    <li class="nav-item role-peserta d-none"><a class="nav-link" href="#" data-page="page-peserta-sertifikat"><i class="fas fa-award"></i> Sertifikat</a></li>

    <!-- Common Links -->
    <li class="nav-item role-all"><a class="nav-link" href="#" data-page="page-about-developer"><i class="fas fa-info-circle"></i>About</a></li>
    <li class="nav-item ms-lg-3">
        <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </li>
    </ul>
    </div>
    </div>
    </nav>
    <div class="container mt-5">
        <div id="page-dashboard" class="page active">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
                <h2 class="h4 mb-0">Dashboard</h2>
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group shadow-sm rounded me-2 role-admin" role="group">
                        <button class="btn btn-primary" onclick="openGenerateScheduleModal()"><i class="fas fa-calendar-alt"></i> Generate Jadwal</button>
                        <button class="btn btn-outline-danger" onclick="clearExamSchedule()"><i class="fas fa-calendar-times"></i> Hapus Jadwal</button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-print"></i> Cetak/Ekspor</button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="printSchedule()"><i class="fas fa-print me-2"></i>Cetak Jadwal Rotasi (PDF/Print)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportScheduleToCSV()"><i class="fas fa-file-csv me-2"></i>Ekspor Jadwal ke CSV/Excel</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="printStudentAttendance()"><i class="fas fa-user-graduate me-2"></i>Cetak Daftar Hadir Peserta</a></li>
                                <li><a class="dropdown-item" href="#" onclick="printExaminerAttendance()"><i class="fas fa-user-check me-2"></i>Cetak Daftar Hadir Penguji</a></li>
                                <li><a class="dropdown-item" href="#" onclick="printExamReport()"><i class="fas fa-file-signature me-2"></i>Cetak Berita Acara Ujian</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="btn-group shadow-sm rounded me-2" role="group">
                        <button class="btn btn-success" onclick="pullFromGoogleSheets()"><i class="fas fa-cloud-download-alt"></i> Tarik Data</button>
                        <button class="btn btn-info" onclick="pushToGoogleSheets()"><i class="fas fa-cloud-upload-alt"></i> Sinkronkan Semua</button>
                    </div>
                    <div class="btn-group shadow-sm rounded" role="group">
                        <button class="btn btn-dark" onclick="backupLocalData()"><i class="fas fa-download"></i> Backup</button>
                        <button class="btn btn-outline-dark" onclick="triggerFileUpload('restore-json-input')"><i class="fas fa-upload"></i> Restore</button>
                    </div>
                    <input type="file" id="restore-json-input" class="d-none" accept=".json" onchange="handleRestoreFile(event)">
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-4 mb-4"><div class="card stat-card shadow-sm"><div class="d-flex justify-content-between align-items-center"><div><div class="stat-value" id="total-peserta">0</div><div class="stat-label">Total Peserta</div></div><i class="fas fa-users stat-icon"></i></div></div></div>
                <div class="col-md-4 mb-4"><div class="card stat-card shadow-sm"><div class="d-flex justify-content-between align-items-center"><div><div class="stat-value" id="total-penguji">0</div><div class="stat-label">Total Penguji</div></div><i class="fas fa-user-tie stat-icon"></i></div></div></div>
                <div class="col-md-4 mb-4"><div class="card stat-card shadow-sm"><div class="d-flex justify-content-between align-items-center"><div><div class="stat-value" id="total-station">0</div><div class="stat-label">Total Station</div></div><i class="fas fa-sitemap stat-icon"></i></div></div></div>
            </div>
            <div class="row mb-4">
                <div class="col-md-4 mb-4"><div class="card stat-card border-success shadow-sm"><div class="d-flex justify-content-between align-items-center"><div><div class="stat-value" id="peserta-selesai">0</div><div class="stat-label">Selesai Ujian (>= 9 Station)</div></div><i class="fas fa-user-check stat-icon text-success"></i></div></div></div>
                <div class="col-md-4 mb-4"><div class="card stat-card border-warning shadow-sm"><div class="d-flex justify-content-between align-items-center"><div><div class="stat-value" id="peserta-sedang">0</div><div class="stat-label">Sedang Ujian</div></div><i class="fas fa-user-clock stat-icon text-warning"></i></div></div></div>
                <div class="col-md-4 mb-4"><div class="card stat-card border-danger shadow-sm"><div class="d-flex justify-content-between align-items-center"><div><div class="stat-value" id="peserta-belum">0</div><div class="stat-label">Belum Ujian</div></div><i class="fas fa-user-times stat-icon text-danger"></i></div></div></div>
            </div>

            <!-- Global Exam Timer -->
            <div class="card mb-4 role-admin">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <span><i class="fas fa-stopwatch text-primary"></i> Timer Ujian Global</span>
                    <span id="dashboard-timer-info" class="text-muted fw-normal small">Menunggu...</span>
                </div>
                <div class="card-body text-center">
                    <!-- Timer Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">Pilih Jenis Timer:</label>
                        <div class="btn-group" role="group" id="timer-type-selector">
                            <input type="radio" class="btn-check" name="timer-type" id="timer-type-rotation" value="rotation" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="timer-type-rotation">Timer per Rotasi</label>

                            <input type="radio" class="btn-check" name="timer-type" id="timer-type-session" value="session" autocomplete="off">
                            <label class="btn btn-outline-primary" for="timer-type-session">Timer per Sesi</label>
                        </div>
                    </div>

                    <!-- Duration Input -->
                    <div class="row justify-content-center mb-3">
                        <div class="col-md-4">
                            <label for="timer-duration-input" class="form-label">Durasi (menit)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="timer-duration-input" value="10" min="1">
                                <span class="input-group-text">menit</span>
                            </div>
                            <small id="timer-duration-suggestion" class="form-text text-muted"></small>
                        </div>
                    </div>

                    <h1 id="dashboard-timer-display" class="display-1 fw-bold my-3" style="font-size: 6rem; letter-spacing: 2px;">00:00</h1>
                    
                    <div class="btn-group shadow-sm" role="group">
                        <button id="btn-timer-start" class="btn btn-success px-4 py-2"><i class="fas fa-play me-2"></i>Mulai</button>
                        <button id="btn-timer-pause" class="btn btn-warning px-4 py-2" disabled><i class="fas fa-pause me-2"></i>Jeda</button>
                        <button id="btn-timer-stop" class="btn btn-danger px-4 py-2" disabled><i class="fas fa-stop me-2"></i>Hentikan & Reset</button>
                    </div>
                </div>
            </div>

            <!-- NEW: Live Exam Monitor -->
            <div class="role-admin">
                <h3 class="mb-3 mt-5"><i class="fas fa-satellite-dish text-danger"></i> Monitor Ujian Langsung <small class="text-muted fs-6 fw-normal">(Refresh otomatis setiap 15 detik)</small></h3>
                <div id="live-monitor-stations" class="row g-4">
                    <div class="col-12 text-center text-muted p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Memuat monitor...</p>
                    </div>
                </div>
                <hr class="my-5">
            </div>

            <div class="row"><div class="col-lg-5 mb-4"><div class="card shadow-sm"><div class="card-header"><i class="fas fa-chart-pie"></i> Status Partisipasi Ujian</div><div class="card-body"><canvas id="statusUjianChart"></canvas></div></div></div><div class="col-lg-7 mb-4"><div class="card shadow-sm"><div class="card-header"><i class="fas fa-chart-bar"></i> Penilaian per Station</div><div class="card-body"><canvas id="penilaianPerStationChart"></canvas></div></div></div></div>
        </div>
        
        <!-- ================================================================= -->
        <!-- NEW: PESERTA PAGES -->
        <!-- ================================================================= -->
        <div id="page-peserta-dashboard" class="page">
            <h2 class="mb-3" id="peserta-welcome-message">Selamat Datang!</h2>
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card stat-card border-primary">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-value" id="peserta-progress-station">0/0</div>
                                <div class="stat-label">Station Selesai</div>
                            </div>
                            <i class="fas fa-tasks stat-icon"></i>
                        </div>
                    </div>
                </div>
                 <div class="col-md-4 mb-4">
                    <div class="card stat-card border-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-value" id="peserta-avg-score">N/A</div>
                                <div class="stat-label">Rata-rata Nilai</div>
                            </div>
                            <i class="fas fa-percentage stat-icon"></i>
                        </div>
                    </div>
                </div>
                 <div class="col-md-4 mb-4">
                    <div class="card stat-card border-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-value" id="peserta-status">...</div>
                                <div class="stat-label">Status Kelulusan</div>
                            </div>
                            <i class="fas fa-award stat-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="peserta-feedback-container" class="mt-4">
                <!-- Feedback Form will be loaded here by JS -->
            </div>

            <div class="card mt-4">
                <div class="card-header"><i class="fas fa-info-circle text-primary"></i> Informasi Penting</div>
                <div class="card-body">
                    <p>Selamat datang di dashboard peserta OSCE.</p>
                    <ul>
                        <li>Gunakan menu navigasi di atas untuk melihat <strong>Hasil & Umpan Balik</strong> detail Anda atau mengunduh <strong>Sertifikat</strong>.</li>
                        <li>Pastikan Anda mengikuti semua stasiun sesuai jadwal yang tertera.</li>
                        <li>Setelah ujian selesai, Anda akan diminta untuk mengisi formulir umpan balik untuk membantu kami meningkatkan kualitas ujian di masa mendatang.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="page-peserta-hasil" class="page">
             <div id="peserta-hasil-content">
                <div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
             </div>
        </div>
        
        <div id="page-peserta-sertifikat" class="page">
            <div class="card">
                <div class="card-header"><i class="fas fa-award text-success"></i> Sertifikat Kelulusan Anda</div>
                <div id="peserta-sertifikat-content" class="card-body text-center p-5">
                    <!-- Content will be loaded by JS -->
                </div>
            </div>
        </div>

        <!-- ================================================================= -->
        <!-- ADMIN/PENGUJI PAGES -->
        <!-- ================================================================= -->
        <div id="page-peserta" class="page">
            <div class="card">
                <div class="card-header"><i class="fas fa-users"></i> Manajemen Daftar Peserta</div>
                <div class="card-body p-4">
                    <form id="form-add-peserta" class="mb-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4"><label class="form-label">NIM Peserta</label><input type="text" id="peserta-nim" class="form-control" placeholder="NIM" required></div>
                            <div class="col-md-4"><label class="form-label">Nama Lengkap</label><input type="text" id="peserta-nama" class="form-control" placeholder="Nama Lengkap" required></div>
                            <div class="col-md-2"><label class="form-label">Password</label><input type="password" id="peserta-password" class="form-control" placeholder="Password"></div>
                            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i> Tambah</button></div>
                        </div>
                        <small class="form-text text-muted">Jika password dikosongkan, akan diatur sama dengan NIM.</small>
                    </form>
                    <div class="d-flex justify-content-end mb-3"><button type="button" class="btn btn-info me-2" onclick="printAllExamCards()"><i class="fas fa-print"></i> Cetak Semua Kartu Ujian</button><button type="button" class="btn btn-success" onclick="triggerFileUpload('import-peserta-csv')"><i class="fas fa-file-csv"></i> Import Peserta dari CSV</button><input type="file" id="import-peserta-csv" class="d-none" accept=".csv" onchange="importCSV('peserta', event)"></div>
                    <div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>NIM</th><th>Nama Lengkap</th><th>Sesi</th><th class="text-center">Aksi</th></tr></thead><tbody id="table-peserta-body"></tbody></table></div>
                </div>
            </div>
        </div>

        <div id="page-penguji" class="page">
            <div class="card"><div class="card-header"><i class="fas fa-user-tie"></i> Manajemen Daftar Penguji</div><div class="card-body p-4"><form id="form-add-penguji" class="mb-4"><div class="row g-3 align-items-center">
                <div class="col-md-3"><input type="text" id="penguji-id" class="form-control" placeholder="NIDN / ID Penguji (Username)" required></div>
                <div class="col-md-4"><input type="text" id="penguji-nama" class="form-control" placeholder="Nama Lengkap" required></div>
                <div class="col-md-3">
                    <select id="penguji-station" class="form-select" required>
                        <option value="" selected disabled>-- Pilih Station --</option>
                    </select>
                </div>
                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i> Tambah</button></div>
            </div></form>
                <div class="d-flex justify-content-end mb-3"><button type="button" class="btn btn-success" onclick="triggerFileUpload('import-penguji-csv')"><i class="fas fa-file-csv"></i> Import Penguji dari CSV</button><input type="file" id="import-penguji-csv" class="d-none" accept=".csv" onchange="importCSV('penguji', event)"></div>
                <div class="table-responsive"><table class="table table-hover align-middle"><thead><tr>
                    <th>ID Penguji (Username)</th>
                    <th>Nama Lengkap</th>
                    <th>Stasiun Ditugaskan</th>
                    <th class="text-center">Aksi</th>
                </tr></thead><tbody id="table-penguji-body"></tbody></table></div></div></div>
        </div>

        <div id="page-station" class="page">
             <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-sitemap"></i> Manajemen Station</span>
                    <button class="btn btn-primary" onclick="openStationModal()"><i class="fas fa-plus-circle"></i> Tambah Station Baru</button>
                </div>
                <div class="card-body p-4" id="station-list-container"></div>
            </div>
        </div>

        <div id="page-penilaian" class="page">
            <div class="card">
                <div class="card-header"><i class="fas fa-edit"></i> Formulir Penilaian OSCE</div>
                <div class="card-body p-4">
                    <div id="schedule-time-info" class="alert alert-info d-none" role="alert"></div>

                    <!-- NEW: Auto-detected participant for Penguji -->
                    <div id="auto-participant-info" class="d-none mb-4">
                        <!-- Content generated by JS -->
                    </div>

                    <!-- REVISED: Manual selection row -->
                    <div id="manual-peserta-selection" class="row mb-4">
                        <div class="col-md-4"><label for="select-penguji" class="form-label fw-bold">Penguji</label><select id="select-penguji" class="form-select"></select></div>
                        <div class="col-md-4">
                            <label for="search-peserta" class="form-label fw-bold">Cari & Pilih Peserta</label>
                            <input type="text" id="search-peserta" class="form-control mb-1" placeholder="Ketik Nama atau NIM...">
                            <select id="select-peserta" class="form-select"></select>
                        </div>
                        <div class="col-md-4"><label for="select-station" class="form-label fw-bold">Station</label><select id="select-station" class="form-select"></select></div>
                    </div>
                    
                    <div id="station-soal-display" class="mb-4"></div>
                    <div id="rubric-preview-container" class="mb-4"></div>
                    <hr>
                    <div id="timer-container" class="text-center mb-4 d-none">
                        <h3 class="mb-1" id="timer-display">00:00</h3>
                        <div class="progress" role="progressbar" style="height: 10px;">
                            <div id="timer-progress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                        <p id="timer-status" class="mt-2 fw-bold d-none"></p>
                    </div>
                    <div id="form-penilaian-rubrik"><div class="text-center text-muted p-5"><i class="fas fa-mouse-pointer fa-3x mb-3"></i><p>Pilih Penguji, Peserta, dan Station untuk memulai.</p></div></div>
                </div>
            </div>
        </div>

        
        <div id="page-hasil" class="page">
            <!-- NEW SUMMARY STATS -->
            <div class="row mb-4">
                <div class="col-md-4 mb-4">
                    <div class="card stat-card border-primary shadow-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-value" id="cohort-average-score">N/A</div>
                                <div class="stat-label">Rata-Rata Nilai Kolektif</div>
                            </div>
                            <i class="fas fa-percentage stat-icon text-primary"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card stat-card border-success shadow-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-value" id="cohort-pass-count">N/A</div>
                                <div class="stat-label">Peserta Lulus (Kolektif)</div>
                            </div>
                            <i class="fas fa-user-check stat-icon text-success"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card stat-card border-danger shadow-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-value" id="cohort-fail-count">N/A</div>
                                <div class="stat-label">Peserta Tdk Lulus (Kolektif)</div>
                            </div>
                            <i class="fas fa-user-times stat-icon text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REORGANIZED: Charts Section -->
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-chart-line text-info"></i> Analitik Nilai per Station</span>
                            <button class="btn btn-outline-secondary btn-sm" onclick="printElement('station-analytics-container', 'Analitik Nilai & Kelulusan per Station')"><i class="fas fa-print"></i> Cetak</button>
                        </div>
                        <div class="card-body" id="station-analytics-container">
                            <canvas id="station-analytics-chart"></canvas>
                            <div id="station-analytics-fallback" class="text-center text-muted p-4 d-none"><p>Belum ada data.</p></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                         <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-tasks text-purple"></i> Analitik Kriteria Rubrik</span>
                            <button class="btn btn-outline-secondary btn-sm" onclick="printElement('rubric-performance-container', 'Analitik Performa per Kriteria Rubrik')"><i class="fas fa-print"></i> Cetak</button>
                        </div>
                        <div class="card-body" id="rubric-performance-container">
                            <canvas id="rubric-performance-chart"></canvas>
                            <div id="rubric-performance-fallback" class="text-center text-muted p-4 d-none"><p>Belum ada data.</p></div>
                        </div>
                    </div>
                </div>
                <!-- NEW: Session Comparison Chart -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-users-cog text-success"></i> Komparasi Nilai per Sesi</span>
                            <button class="btn btn-outline-secondary btn-sm" onclick="printElement('session-comparison-container', 'Komparasi Nilai Rata-rata per Sesi')"><i class="fas fa-print"></i> Cetak</button>
                        </div>
                        <div class="card-body" id="session-comparison-container">
                            <canvas id="session-comparison-chart"></canvas>
                            <div id="session-comparison-fallback" class="text-center text-muted p-4 d-none"><p>Belum ada data sesi ujian untuk dibandingkan.</p></div>
                        </div>
                    </div>
                </div>
                <!-- NEW: Rubric Difficulty Chart -->
                <div class="col-lg-12 mb-4">
                    <div class="card mb-4 h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-chart-bar text-danger"></i> Analisis Kesulitan Kriteria Rubrik (15 Terendah)</span>
                            <button class="btn btn-outline-secondary btn-sm" onclick="printElement('rubric-difficulty-container', 'Analisis Kesulitan Kriteria Rubrik')"><i class="fas fa-print"></i> Cetak</button>
                        </div>
                        <div class="card-body" id="rubric-difficulty-container">
                            <canvas id="rubric-difficulty-chart"></canvas>
                            <div id="rubric-difficulty-fallback" class="text-center text-muted p-4 d-none"><p>Belum ada data untuk menampilkan analisis kesulitan.</p></div>
                        </div>
                    </div>
                </div>

                <!-- Global Performance analysis -->
                <div class="row">
                    <div class="col-lg-7 mb-4">
                        <div class="card h-100">
                            <div class="card-header"><i class="fas fa-globe-asia text-info"></i> Analisis Global Performance (Skala 1-4)</div>
                            <div class="card-body">
                                <div class="row align-items-center h-100">
                                    <div class="col-md-5 d-flex flex-column justify-content-center">
                                        <p class="text-muted small">Rata-rata skor "Global Performance" dari semua peserta yang telah menyelesaikan <strong>minimal 9 station</strong>.</p>
                                        <div class="text-center p-3 bg-light rounded mt-auto">
                                            <h6 class="text-muted mb-1">Rata-Rata GPR</h6>
                                            <p class="h2 fw-bold text-info" id="avg-global-performance">N/A</p>
                                            <small class="d-block">(1: Tdk Lulus, 4: Superior)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-7">
                                        <canvas id="global-performance-chart"></canvas>
                                        <div id="global-performance-fallback" class="text-center text-muted p-4 d-none">
                                            <p>Belum ada cukup data.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5 mb-4">
                        <div class="card h-100">
                            <div class="card-header"><i class="fas fa-tachometer-alt text-success"></i> Konversi GPR ke Skala 100</div>
                            <div class="card-body d-flex flex-column justify-content-center">
                                 <p class="text-muted">Nilai ini mengkonversi rata-rata GPR ke skala 1-100. Dapat digunakan sebagai salah satu referensi untuk Batas Lulus Kolektif (BLK).</p>
                                 <div class="text-center p-4 bg-light rounded mt-3">
                                     <h6 class="text-muted mb-1">Nilai GPR (Skala 100)</h6>
                                     <p class="display-4 fw-bold text-success" id="avg-global-performance-100">N/A</p>
                                     <small class="text-muted">Rumus: (Rata-Rata GPR / 4) * 100</small>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Score vs GPR Correlation Chart -->
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-link text-success"></i> Korelasi Nilai Kolektif vs. Global Performance</span>
                            <button class="btn btn-outline-secondary btn-sm" onclick="printElement('score-vs-gpr-container', 'Korelasi Nilai Kolektif vs. Global Performance')"><i class="fas fa-print"></i> Cetak</button>
                        </div>
                        <div class="card-body" id="score-vs-gpr-container">
                            <canvas id="score-vs-gpr-chart" style="min-height: 400px;"></canvas>
                            <div id="score-vs-gpr-fallback" class="text-center text-muted p-4 d-none">
                                <p>Belum ada cukup data (peserta yang menyelesaikan minimal 9 station valid) untuk menampilkan analisis korelasi.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-trophy text-warning"></i> Peringkat Nilai Terbaik per Station</h4>
                <button class="btn btn-outline-secondary" onclick="printElement('station-ranking-container', 'Peringkat Nilai Terbaik per Station')"><i class="fas fa-print"></i> Cetak Peringkat</button>
            </div>
            <div id="station-ranking-container" class="row mb-5">
                <div class="col-12 text-center text-muted p-4"><p>Belum ada data penilaian untuk ditampilkan.</p></div>
            </div>
            
            <!-- NEW: Remedial Recommendation Section -->
            <div class="card mb-5">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-pills text-info"></i> Rekomendasi Remedial Otomatis</span>
                    <button class="btn btn-outline-secondary" onclick="printElement('remedial-recommendation-container', 'Rekomendasi Remedial Otomatis')"><i class="fas fa-print"></i> Cetak Daftar</button>
                </div>
                <div class="card-body" id="remedial-recommendation-container">
                    <p class="text-muted"><small>Daftar berikut menampilkan peserta yang direkomendasikan untuk mengikuti remedial pada stasiun tertentu. Rekomendasi didasarkan pada skor peserta yang berada di bawah batas lulus yang dihitung menggunakan Metode Borderline (BRM) atau batas lulus yang ditentukan untuk setiap stasiun.</small></p>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>NIM</th>
                                    <th>Nama Peserta</th>
                                    <th>Station yang Memerlukan Remedial</th>
                                </tr>
                            </thead>
                            <tbody id="table-remedial-body">
                                <!-- Content will be generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- [MODIFIED] Card "Rekapitulasi Hasil Ujian Kolektif" -->
            <div class="card mb-5">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <span><i class="fas fa-award text-success"></i> Rekapitulasi Hasil Ujian Kolektif</span>
                    <button id="btn-export-collective-csv" class="btn btn-success btn-sm"><i class="fas fa-file-csv"></i> Ekspor Hasil Kolektif</button>
                </div>
                <div class="card-body">
                    <div class="row align-items-center mb-4">
                        <div class="col-md-5">
                            <label class="form-label fw-bold">Stasiun yang dikecualikan dari perhitungan:</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="excludeStationDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                    Atur Stasiun Pengecualian
                                </button>
                                <div class="dropdown-menu p-2" aria-labelledby="excludeStationDropdownBtn" id="excluded-stations-checklist" style="max-height: 300px; overflow-y: auto;">
                                    <p class="text-muted small mb-1">Pilih stasiun yang tidak dihitung.</p>
                                    <div id="station-checkbox-container"></div>
                                </div>
                            </div>
                            <p class="mb-0 text-muted small mt-2">Dikecualikan: <strong class="text-danger" id="excluded-stations-display">Tidak ada</strong></p>
                        </div>
                        <div class="col-md-7">
                            <label class="form-label fw-bold">Batas Lulus Kolektif:</label>
                            <div class="input-group">
                                <span class="input-group-text">%</span>
                                <input type="number" id="collective-passing-grade" class="form-control" value="75" min="0" max="100">
                                <button class="btn btn-primary" id="apply-collective-grade-btn">Terapkan & Hitung</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>NIM</th>
                                    <th>Nama Peserta</th>
                                    <th class="text-center">Station Dikerjakan (Valid)</th>
                                    <th class="text-center">Rata-Rata Nilai (%)</th>
                                    <th class="text-center">Status Kelulusan</th>
                                </tr>
                            </thead>
                            <tbody id="table-collective-hasil-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card"><div class="card-header"><i class="fas fa-poll"></i> Rekapitulasi Hasil Ujian per Station</div><div class="card-body p-4"><button id="btn-export-csv" class="btn btn-success mb-4"><i class="fas fa-file-csv"></i> Ekspor ke CSV</button><div class="table-responsive"><table class="table table-hover align-middle">
                <thead><tr><th>NIM</th><th>Nama Peserta</th><th>Station Terakhir</th><th>Penguji Terakhir</th><th>Nilai (Skor / Persen)</th><th class="text-center">Aksi</th></tr></thead>
                <tbody id="table-hasil-body"></tbody>
            </table></div></div></div>
        </div>
        
        <!-- NEW: Feedback Summary Page (for Admin) -->
        <div id="page-feedback-summary" class="page">
            <h2 class="mb-4"><i class="fas fa-comment-dots text-primary"></i> Rangkuman Umpan Balik Peserta</h2>
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header"><i class="fas fa-star-half-alt text-warning"></i> Rata-rata Kepuasan per Station</div>
                        <div class="card-body">
                            <canvas id="feedback-rating-chart"></canvas>
                            <div id="feedback-rating-fallback" class="text-center text-muted p-4 d-none"><p>Belum ada data umpan balik untuk ditampilkan.</p></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                     <div class="card h-100">
                        <div class="card-header"><i class="fas fa-user-clock text-info"></i> Status Pengisian Umpan Balik</div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <canvas id="feedback-completion-chart" style="max-height: 250px;"></canvas>
                             <div id="feedback-completion-fallback" class="text-center text-muted p-4 d-none"><p>Belum ada peserta yang menyelesaikan ujian.</p></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header"><i class="fas fa-comments text-success"></i> Komentar Peserta</div>
                <div class="card-body">
                    <div id="feedback-comments-container">
                        <p class="text-muted text-center p-3">Memuat komentar...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-sertifikat-settings" class="page">
            <div class="card">
                <div class="card-header"><i class="fas fa-cog"></i> Pengaturan Umum & Sertifikat</div>
                <div class="card-body p-4">
                    <form id="form-cert-settings">
                        <!-- [NEW] Institution Name Setting -->
                        <h5 class="mb-3">Pengaturan Institusi</h5>
                         <div class="mb-3">
                            <label for="cert-institution-name" class="form-label fw-bold">Nama Institusi</label>
                            <input type="text" id="cert-institution-name" class="form-control" placeholder="Contoh: Program Studi D3 Kebidanan, Poltekkes Kemenkes Kupang">
                            <small class="text-muted">Nama ini akan muncul di semua dokumen cetak (sertifikat, berita acara, dll).</small>
                        </div>
                        <hr>
                        <h5 class="mb-3">Pengaturan Sertifikat</h5>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="cert-format" class="form-label fw-bold">Format Nomor Sertifikat</label>
                                <input type="text" id="cert-format" class="form-control" placeholder="Contoh: UN/KEP-WKB/X/2025">
                                <small class="text-muted">Nomor urut akan ditambahkan secara otomatis di depan format ini.</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="cert-start-number" class="form-label fw-bold">Nomor Awal</label>
                                <input type="number" id="cert-start-number" class="form-control" value="1" min="1">
                            </div>
                        </div>

                        <!-- [NEW] Certificate Background Upload -->
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="cert-background-file" class="form-label fw-bold">Unggah Gambar Latar Sertifikat</label>
                                    <input type="file" id="cert-background-file" class="form-control" accept="image/png, image/jpeg">
                                    <small class="text-muted">Gunakan gambar ukuran A4 Lanskap untuk hasil terbaik. Jika kosong, akan menggunakan background default.</small>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <label class="form-label fw-bold">Pratinjau Latar:</label>
                                <div id="cert-background-preview-container" class="border p-2 bg-light" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                                    <img id="cert-background-preview" src="" alt="Pratinjau Latar" style="max-height: 80px; max-width: 100%; display: none;">
                                    <span id="cert-background-placeholder" class="text-muted">Background Default</span>
                                </div>
                                <button type="button" id="cert-clear-background" class="btn btn-sm btn-outline-danger mt-2 d-none">Hapus Latar</button>
                            </div>
                        </div>

                        <h5 class="mb-3 mt-3">Pengaturan Ujian & Laporan</h5>
                        <div class="mb-3">
                            <label for="cert-exam-date" class="form-label fw-bold">Tanggal Pelaksanaan Ujian</label>
                            <input type="text" id="cert-exam-date" class="form-control" placeholder="Contoh: 25 - 26 Oktober 2025">
                        </div>
                         <div class="mb-3">
                            <label for="cert-venue" class="form-label fw-bold">Tempat/Lokasi Pelaksanaan Ujian</label>
                            <input type="text" id="cert-venue" class="form-control" placeholder="Contoh: Kampus Poltekkes Prodi D3 Kebidanan">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cert-city" class="form-label fw-bold">Kota Penerbitan</label>
                                <input type="text" id="cert-city" class="form-control" placeholder="Contoh: Kupang">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cert-date" class="form-label fw-bold">Tanggal Penerbitan</label>
                                <input type="date" id="cert-date" class="form-control">
                            </div>
                        </div>
                        <hr>
                        <!-- [MODIFIED] Section for Signatories -->
                        <h5 class="mb-3">Pengaturan Penanda Tangan</h5>
                        <div class="row align-items-center">
                             <div class="col-md-6 mb-3">
                                <label for="cert-signature-person" class="form-label fw-bold">Penanda Tangan Sertifikat</label>
                                <select id="cert-signature-person" class="form-select">
                                    <option value="kaprodi">Ketua Prodi</option>
                                    <option value="koordinator">Koordinator OSCE</option>
                                </select>
                             </div>
                             <div class="col-md-6 mb-3">
                                <label for="cert-signature-file" class="form-label fw-bold">Unggah Tanda Tangan Digital</label>
                                <input type="file" id="cert-signature-file" class="form-control" accept="image/png, image/jpeg">
                             </div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <small class="text-muted">Gunakan gambar dengan latar belakang transparan (PNG) untuk hasil terbaik.</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <label class="form-label fw-bold">Pratinjau TTD:</label>
                                <div id="cert-signature-preview-container" class="border p-2 bg-light" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                                    <img id="cert-signature-preview" src="" alt="Pratinjau Tanda Tangan" style="max-height: 80px; max-width: 100%; display: none;">
                                    <span id="cert-signature-placeholder" class="text-muted">Belum ada gambar</span>
                                </div>
                                <button type="button" id="cert-clear-signature" class="btn btn-sm btn-outline-danger mt-2 d-none">Hapus Gambar</button>
                            </div>
                        </div>
                        <hr>
                        <!-- [MODIFIED] More flexible official information -->
                        <h5 class="mb-3">Informasi Pejabat</h5>
                        <div class="row p-3 mb-3 border rounded bg-body-tertiary">
                            <p class="fw-bold mb-2">1. Data Ketua Program Studi <small class="text-muted">(Untuk Berita Acara & Opsi Sertifikat)</small></p>
                            <div class="col-md-4 mb-2">
                                <label for="cert-kaprodi-name" class="form-label">Nama Lengkap & Gelar</label>
                                <input type="text" id="cert-kaprodi-name" class="form-control form-control-sm" placeholder="Nama Ketua Prodi">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="cert-kaprodi-title" class="form-label">Jabatan</label>
                                <input type="text" id="cert-kaprodi-title" class="form-control form-control-sm" placeholder="Contoh: Ketua Program Studi">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="cert-kaprodi-nip" class="form-label">NIP/NIDN</label>
                                <input type="text" id="cert-kaprodi-nip" class="form-control form-control-sm" placeholder="NIP. XXXXXX">
                            </div>
                        </div>
                        <div class="row p-3 border rounded bg-body-tertiary">
                            <p class="fw-bold mb-2">2. Data Koordinator OSCE <small class="text-muted">(Untuk Daftar Hadir & Opsi Sertifikat)</small></p>
                            <div class="col-md-4 mb-2">
                                <label for="cert-koordinator-name" class="form-label">Nama Lengkap & Gelar</label>
                                <input type="text" id="cert-koordinator-name" class="form-control form-control-sm" placeholder="Nama Koordinator">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="cert-koordinator-title" class="form-label">Jabatan</label>
                                <input type="text" id="cert-koordinator-title" class="form-control form-control-sm" placeholder="Contoh: Koordinator OSCE">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="cert-koordinator-nip" class="form-label">NIP/NIDN</label>
                                <input type="text" id="cert-koordinator-nip" class="form-control form-control-sm" placeholder="NIP. XXXXXX">
                            </div>
                        </div>
        
                        <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save"></i> Simpan Pengaturan</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="page-sertifikat-print" class="page">
            <div class="card">
                <div class="card-header"><i class="fas fa-print"></i> Cetak Sertifikat Kelulusan Peserta</div>
                <div class="card-body p-4">
                     <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Tombol cetak akan tersedia untuk semua peserta. Pastikan pengaturan umum telah disimpan dengan benar sebelum mencetak.
                     </div>
                     <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>NIM</th>
                                    <th>Nama Peserta</th>
                                    <th class="text-center">Nilai Rata-rata (%)</th>
                                    <th class="text-center">Status Kelulusan</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="table-sertifikat-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-sertifikat-penguji" class="page">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-user-shield"></i> Cetak Sertifikat Penguji</span>
                    <button class="btn btn-primary" onclick="printAllPengujiCertificates()"><i class="fas fa-print"></i> Cetak Semua Sertifikat</button>
                </div>
                <div class="card-body p-4">
                     <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Pastikan pengaturan umum telah disimpan dengan benar sebelum mencetak.
                     </div>
                     <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID Penguji (Username)</th>
                                    <th>Nama Lengkap</th>
                                    <th>Stasiun Ditugaskan</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="table-sertifikat-penguji-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEWLY ADDED PAGE: LOG SISTEM -->
        <div id="page-log-sistem" class="page">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-history"></i> Log Aktivitas Sistem</span>
                    <button class="btn btn-sm btn-danger" onclick="clearSystemLog()"><i class="fas fa-trash-alt"></i> Bersihkan Log</button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info small"><i class="fas fa-info-circle"></i> Log menampilkan 500 aktivitas terakhir. Aktivitas terbaru berada di paling atas.</div>
                    <div id="log-container" class="list-group" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Log entries will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

<div id="page-about-developer" class="page">
        <div class="container-about">
          <h1>üë®‚Äçüíª Tim Pengembang Aplikas</h1>
          <p style="text-align: center; margin-top: -10px; margin-bottom: 30px; font-style: italic;">Kolaborasi antara konseptor dan developer untuk menciptakan solusi digital yang efektif.</p>

      <!-- ============== PROFIL PERANCANG ALUR APLIKASI ============== -->
      <div class="profile-card">
        <h2>üí° Konseptor & Perancang Aplikasi</h2>
        <p class="role-description">Bertanggung jawab atas ide, alur, dan fungsionalitas aplikasi agar sesuai dengan kebutuhan pengguna.</p>
        
        <p><strong>Nama:</strong> Diyan Maria Kristin, SST, M.Kes</p>
        <p><strong>Jabatan:</strong> Dosen Asisten Ahli</p>
        <p><strong>Institusi:</strong> Poltekkes Kemenkes Kupang, Prodi D3 Kebidanan</p>
        <p><strong>Kontak:</strong> <a href="https://wa.me/6281339728135" target="_blank">+62 813-3972-8135</a></p>
      </div>

      <hr class="profile-separator">

      <!-- ============== PROFIL DEVELOPER ============== -->
      <div class="profile-card">
        <h2>üë®‚Äçüíª Developer & Implementator Teknis</h2>
        <p class="role-description">Bertanggung jawab atas perancangan arsitektur, penulisan kode, dan implementasi teknis dari konsep yang telah dibuat.</p>
        
        <p><strong>Nama:</strong> Septian Andi Prianto</p>
        <p><strong>Institusi:</strong> Prodi D3 Keperawatan Waikabubak, Poltekkes Kemenkes Kupang</p>
    
        <h3>üìû Kontak</h3>
        <ul>
          <li><strong>Nomor HP:</strong> <a href="https://wa.me/6285253470788" target="_blank">0852-5347-0788</a></li>
          <li><strong>Email:</strong> <a href="mailto:masandy.devcode@gmail.com" target="_blank">masandy.devcode@gmail.com</a></li>
          <li><strong>Instagram:</strong> <a href="https://instagram.com/maz_4ndy" target="_blank">@andydevcode</a></li>
          <li><strong>Facebook:</strong> <a href="https://facebook.com/mas4ndy" target="_blank">@mas4ndy</a></li>
          <li><strong>Website:</strong> <a href="https://www.masandigital.com" target="_blank">www.masandigital.com</a></li>
        </ul>
    
        <h3>üõ†Ô∏è Tools & Aplikasi</h3>
        <ul>
          <li><a href="https://cbt-wkb.masandigital.com/" target="_blank">CBT Online Keperawatan</a></li>
          <li><a href="https://bimbel.masandigital.com/" target="_blank">Bimbel Online Keperawatan</a></li>
          <li><a href="https://bimbelbidan.masandigital.com/" target="_blank">Bimbel Online Kebidanan</a></li>
          <li>Aplikasi Peminjaman Alat Lab (Private)</li>
          <li>Aplikasi Peminjaman Alat BMN (Private)</li>
          <li><a href="https://watermarks.netlify.app/" target="_blank">Watermarks Location Generator</a></li>
        </ul>
      </div>

      <!-- ============== KOTAK KONTAK UNTUK KOLABORASI ============== -->
      <div class="contact-box">
        <h3>ü§ù Ingin Bekerja Sama?</h3>
        <p>Untuk kolaborasi, pengembangan sistem, pelatihan, atau kebutuhan digital lainnya ‚Äî jangan ragu untuk menghubungi saya melalui WhatsApp atau email di atas.</p>
      </div>
    
      <div class="footer-about">
        &copy; 2025 Septian Andi Prianto | masandigital.com
          </div>
        </div>
    </div>

    </div>
</div>

<!-- ================================================================= -->
<!-- MODALS SECTION -->
<!-- ================================================================= -->
<div class="modal fade" id="editPesertaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-edit"></i> Edit Data Peserta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-edit-peserta">
                    <input type="hidden" id="edit-peserta-id">
                    <div class="mb-3">
                        <label for="edit-peserta-nim" class="form-label">NIM</label>
                        <input type="text" class="form-control" id="edit-peserta-nim" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-peserta-nama" class="form-label">Nama Lengkap</label>
                        <input type="text" class="form-control" id="edit-peserta-nama" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-peserta-password" class="form-label">Password Baru</label>
                        <input type="password" class="form-control" id="edit-peserta-password" placeholder="Kosongkan jika tidak ingin diubah">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="savePesertaChanges()">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPengujiModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-user-tie"></i> Edit Data Penguji</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-edit-penguji"><input type="hidden" id="edit-penguji-id"><div class="mb-3"><label for="edit-penguji-idPenguji" class="form-label">ID Penguji (Username)</label><input type="text" class="form-control" id="edit-penguji-idPenguji" readonly></div><div class="mb-3"><label for="edit-penguji-nama" class="form-label">Nama Lengkap</label><input type="text" class="form-control" id="edit-penguji-nama" required></div><div class="mb-3"><label for="edit-penguji-station" class="form-label">Stasiun Ditugaskan</label><select id="edit-penguji-station" class="form-select" required></select></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" onclick="savePengujiChanges()">Simpan Perubahan</button></div></div></div></div>

<!-- MODAL FOR EDITING CREDENTIALS -->
<div class="modal fade" id="editCredentialsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-key"></i> Ubah Kredensial Penguji</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-edit-credentials" onsubmit="event.preventDefault(); saveCredentialsChanges();">
                    <input type="hidden" id="edit-credentials-penguji-id">
                    <div class="mb-3">
                        <label for="edit-credentials-nama" class="form-label">Nama Penguji</label>
                        <input type="text" class="form-control" id="edit-credentials-nama" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit-credentials-old-username" class="form-label">Username Saat Ini</label>
                        <input type="text" class="form-control" id="edit-credentials-old-username" readonly>
                    </div>
                    <hr>
                    <p class="text-muted"><small>Kosongkan field di bawah jika tidak ingin mengubahnya.</small></p>
                    <div class="mb-3">
                        <label for="edit-credentials-new-username" class="form-label">Username Baru</label>
                        <input type="text" id="edit-credentials-new-username" class="form-control" placeholder="Biarkan kosong jika tidak berubah">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-credentials-new-password" class="form-label">Password Baru</label>
                            <input type="password" id="edit-credentials-new-password" class="form-control" placeholder="Biarkan kosong jika tidak berubah">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-credentials-confirm-password" class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" id="edit-credentials-confirm-password" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="saveCredentialsChanges()">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="stationModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="stationModalLabel"><i class="fas fa-plus-circle"></i> Tambah Station Baru</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-station"><input type="hidden" id="station-id"><div class="row"><div class="col-md-6 mb-3"><label for="station-name" class="form-label fw-bold">Nama Station</label><input type="text" id="station-name" class="form-control" required></div><div class="col-md-3 mb-3"><label for="station-time" class="form-label fw-bold">Waktu (menit)</label><input type="number" id="station-time" class="form-control" min="0" placeholder="Contoh: 10"></div><div class="col-md-3 mb-3"><label for="station-passing-grade" class="form-label fw-bold">Kelulusan (%)</label><input type="number" id="station-passing-grade" class="form-control" min="0" max="100" placeholder="Contoh: 75"></div></div><div class="mb-3"><label for="station-soal" class="form-label fw-bold">Soal / Skenario OSCE</label><textarea id="station-soal" class="form-control" rows="6" placeholder="Masukkan skenario kasus, instruksi untuk peserta, atau detail tugas untuk station ini..."></textarea></div><h6 class="fw-bold">Rubrik Penilaian</h6><div id="rubric-inputs-container"></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addRubricInput()"><i class="fas fa-plus"></i> Tambah Kriteria</button></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" onclick="saveStation()">Simpan Station</button></div></div></div></div>

<div class="modal fade" id="generateScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calendar-alt"></i> Buat Jadwal Ujian Otomatis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-generate-schedule">
                    <div class="mb-3">
                        <label for="schedule-start-date" class="form-label">Tanggal Mulai Ujian</label>
                        <input type="date" id="schedule-start-date" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="schedule-start-time" class="form-label">Jam Mulai Harian</label>
                            <input type="time" id="schedule-start-time" class="form-control" required value="08:00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="schedule-end-time" class="form-label">Jam Selesai Harian</label>
                            <input type="time" id="schedule-end-time" class="form-control" required value="17:00">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="schedule-duration" class="form-label">Durasi Default per Station (menit)</label>
                        <input type="number" id="schedule-duration" class="form-control" required value="10" min="1">
                        <small class="text-muted">Waktu spesifik yang diatur di tiap station akan diutamakan jika lebih besar.</small>
                    </div>
                    <div class="mb-3">
                        <label for="schedule-break" class="form-label">Jeda Antar Sesi (menit)</label>
                        <input type="number" id="schedule-break" class="form-control" required value="15" min="0">
                    </div>
                    <hr>
                    <h6 class="fw-bold">Pengaturan Istirahat Panjang (ISHOMA)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="schedule-lunch-start" class="form-label">Mulai Jam Istirahat</label>
                            <input type="time" id="schedule-lunch-start" class="form-control" required value="12:00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="schedule-lunch-end" class="form-label">Selesai Jam Istirahat</label>
                            <input type="time" id="schedule-lunch-end" class="form-control" required value="13:00">
                        </div>
                    </div>
                    <small class="text-muted">
                        Setiap sesi yang dijadwalkan tumpang tindih dengan rentang waktu ini akan secara otomatis digeser untuk dimulai setelah jam istirahat selesai.
                    </small>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="generateExamSchedule()">Generate</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="participantDetailModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="participantDetailModalLabel"><i class="fas fa-user-graduate"></i> Detail Hasil Peserta</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="participantDetailModalBody"><div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button><button type="button" class="btn btn-primary" id="print-participant-result-btn"><i class="fas fa-print"></i> Cetak Hasil</button></div></div></div></div>

<div class="modal fade" id="syncModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><div id="sync-status-content"></div></div></div></div></div>

<footer class="text-center text-muted py-4 mt-5">
    <p>¬© 2025. Develop by <a href="#" data-page="page-about-developer" class="text-decoration-none text-muted fw-bold">Mas Andy - masandigital.com</a> <i class="fas fa-heart text-danger"></i>.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// =================================================================
// GLOBAL STATE & CONFIG
// =================================================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFDPBurXh9IOO5wtuyKdXlXICiy2cQ6v_bmIGQRDKyGJF8TR0-2-AIvwJEzSawPI_eSg/exec'; // <-- GANTI URL INI
let initialData = { "peserta": [], "penguji": [], "stations": [], "scores": [], "scheduleParams": {}, "feedback": [], "backupDate": null };

let USER_CREDENTIALS = {
    "admin": "admin123" // Default admin, will be updated from spreadsheet
};

let editPesertaModal, editPengujiModal, stationModal, syncModal, generateScheduleModal, participantDetailModal, editCredentialsModal;
let statusUjianChartInstance, penilaianPerStationChartInstance, stationAnalyticsChartInstance, rubricPerformanceChartInstance, participantProgressChartInstance, globalPerformanceChartInstance, rubricDifficultyChartInstance, sessionComparisonChartInstance, scoreVsGprChartInstance, feedbackRatingChartInstance, feedbackCompletionChartInstance;
let stationTimer = null;
let liveMonitorInterval = null;

// =================================================================
// DASHBOARD GLOBAL TIMER STATE
// =================================================================
let dashboardTimerInterval = null;
let dashboardTimerState = 'stopped'; // 'stopped', 'running', 'paused'
let dashboardTimerEndTime = null;
let dashboardTimerRemaining = 0;
let dashboardTimerInfoText = '';

// =================================================================
// INITIALIZATION & SESSION MANAGEMENT
// =================================================================
document.addEventListener('DOMContentLoaded', function() {
    editPesertaModal = new bootstrap.Modal(document.getElementById('editPesertaModal'));
    editPengujiModal = new bootstrap.Modal(document.getElementById('editPengujiModal'));
    stationModal = new bootstrap.Modal(document.getElementById('stationModal'));
    syncModal = new bootstrap.Modal(document.getElementById('syncModal'));
    generateScheduleModal = new bootstrap.Modal(document.getElementById('generateScheduleModal'));
    participantDetailModal = new bootstrap.Modal(document.getElementById('participantDetailModal'));
    editCredentialsModal = new bootstrap.Modal(document.getElementById('editCredentialsModal'));
    
    document.getElementById('schedule-start-date').valueAsDate = new Date();
    
    checkSession();
    setupEventListeners();
});

function checkSession() {
    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    if (user && user.role) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        initializeData();
        applyRolePermissions(user);
    } else {
        document.getElementById('login-page').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }
}

// =================================================================
// LOGIN & LOGOUT (REVISED AND CORRECTED)
// =================================================================
async function login(event) {
    event.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('login-error');
    const submitButton = document.querySelector('#login-form button[type="submit"]');
    errorDiv.classList.add('d-none');

    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';

    // Try to get the latest data from the server, including results and credentials.
    // This is crucial for the app to work with up-to-date information.
    try {
        showSyncStatus('<div class="spinner-border text-primary" role="status"></div><h4 class="mt-3">Autentikasi & Sinkronisasi...</h4><p class="text-muted">Mengambil data terbaru dari server...</p>');
        await pullDataFromServer({ timeout: 15000 });
        syncModal.hide();
    } catch (pullError) {
        console.warn("Failed to pull data from server during login:", pullError.message);
        showSyncStatus('<div class="spinner-border text-warning" role="status"></div><h4 class="mt-3">Gagal Sinkronisasi</h4><p class="text-muted">Server tidak merespons. Mencoba login dengan data lokal (offline)...</p>', true);
        await new Promise(resolve => setTimeout(resolve, 1500));
        syncModal.hide();
    }

    let user = null;
    let loginSuccess = false;

    // Check credentials against the unified USER_CREDENTIALS object.
    // This object is populated/updated by pullDataFromServer().
    if (USER_CREDENTIALS[username] && USER_CREDENTIALS[username] === password) {
        loginSuccess = true;
        
        // Determine user role after successful login
        if (username === 'admin') {
            user = { role: 'admin' };
        } else {
            // Check if it's an examiner
            const pengujiDetails = getFromStorage('penguji').find(p => p.idPenguji === username);
            if (pengujiDetails) {
                user = { 
                    role: 'penguji', 
                    id: pengujiDetails.id, 
                    idPenguji: pengujiDetails.idPenguji,
                    name: pengujiDetails.nama,
                    assignedStationId: pengujiDetails.assignedStationId 
                };
            } else {
                // If not an examiner, it must be a participant
                const pesertaDetails = getFromStorage('peserta').find(p => p.nim === username);
                if (pesertaDetails) {
                     user = {
                        role: 'peserta',
                        id: pesertaDetails.id,
                        nim: pesertaDetails.nim,
                        name: pesertaDetails.nama
                    };
                }
            }
        }
    }

    // Handle login outcome
    if (loginSuccess && user) {
        sessionStorage.setItem('osce_user', JSON.stringify(user));
        logActivity('LOGIN_SUCCESS', `Username: ${username} (Role: ${user.role})`);
        checkSession();
    } else {
        errorDiv.textContent = 'Username atau password salah.';
        errorDiv.classList.remove('d-none');
    }
    
    submitButton.disabled = false;
    submitButton.innerHTML = 'Login';
}

function logout() {
    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    logActivity('LOGOUT', `User: ${(user ? (user.name || user.role) : 'Sesi berakhir')} telah logout.`);
    sessionStorage.removeItem('osce_user');
    window.location.reload();
}

function applyRolePermissions(user) {
    document.querySelectorAll('.role-admin, .role-penguji, .role-peserta').forEach(el => el.classList.add('d-none'));

    if (user.role === 'admin') {
        document.querySelectorAll('.role-admin').forEach(el => el.classList.remove('d-none'));
        showPage('page-dashboard');
    } else if (user.role === 'penguji') {
        document.querySelectorAll('.role-penguji').forEach(el => el.classList.remove('d-none'));
        document.querySelector('.nav-link[data-page="page-penilaian"]').classList.add('active');
        showPage('page-penilaian');
    } else if (user.role === 'peserta') {
        document.querySelectorAll('.role-peserta').forEach(el => el.classList.remove('d-none'));
        const welcomeMsg = document.getElementById('peserta-welcome-message');
        if (welcomeMsg) welcomeMsg.textContent = `Selamat Datang, ${user.name}!`;
        showPage('page-peserta-dashboard');
    }
    document.querySelectorAll('.role-all').forEach(el => el.classList.remove('d-none'));
}

function initializeData() {
    if (!localStorage.getItem('peserta') && typeof initialData !== 'undefined') {
        saveToStorage('peserta', initialData.peserta || []);
        saveToStorage('penguji', initialData.penguji || []);
        saveToStorage('stations', initialData.stations || []);
        saveToStorage('scores', initialData.scores || []);
        saveToStorage('osce_schedule_params', initialData.scheduleParams || {});
        saveToStorage('feedback', initialData.feedback || []);
    }
}

function setupEventListeners() {
    document.getElementById('login-form').addEventListener('submit', login);
    document.querySelectorAll('a[data-page]').forEach(link => link.addEventListener('click', handleNavClick));
    document.getElementById('form-add-peserta').addEventListener('submit', addPeserta);
    document.getElementById('form-add-penguji').addEventListener('submit', addPenguji);
    document.getElementById('select-penguji').addEventListener('change', generateRubricForm);
    document.getElementById('select-peserta').addEventListener('change', generateRubricForm);
    document.getElementById('select-station').addEventListener('change', () => { displayRubricPreview(); generateRubricForm(); });
    document.getElementById('btn-export-csv').addEventListener('click', exportToCSV);
    document.getElementById('search-peserta').addEventListener('input', (e) => updatePesertaDropdown(e.target.value));
    document.getElementById('apply-collective-grade-btn').addEventListener('click', updateCollectivePassingGrade);
    document.getElementById('btn-export-collective-csv').addEventListener('click', exportCollectiveResultsToCSV);
    document.getElementById('form-cert-settings').addEventListener('submit', saveCertificateSettings);
    document.getElementById('cert-signature-file').addEventListener('change', previewCertificateSignature);
    document.getElementById('cert-clear-signature').addEventListener('click', clearCertificateSignature);
    document.getElementById('excluded-stations-checklist').addEventListener('change', handleExcludeStationChange);
    document.getElementById('cert-background-file').addEventListener('change', previewCertificateBackground);
    document.getElementById('cert-clear-background').addEventListener('click', clearCertificateBackground);
    document.getElementById('btn-timer-start').addEventListener('click', startDashboardTimer);
    document.getElementById('btn-timer-pause').addEventListener('click', pauseDashboardTimer);
    document.getElementById('btn-timer-stop').addEventListener('click', stopDashboardTimer);
    document.getElementById('timer-type-selector').addEventListener('change', updateTimerDurationSuggestion);
}

function handleNavClick(e) {
    e.preventDefault();
    if (stationTimer) clearInterval(stationTimer);
    if (liveMonitorInterval) { clearInterval(liveMonitorInterval); liveMonitorInterval = null; }
    if (dashboardTimerInterval) { stopDashboardTimer(); }
    const pageId = this.dataset.page;
    if (!pageId) return;
    if (!this.classList.contains('dropdown-toggle')) {
        document.querySelectorAll('.nav-link, .dropdown-item').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        if (this.closest('.nav-item.dropdown')) {
            this.closest('.nav-item.dropdown').querySelector('.nav-link').classList.add('active');
        }
    }
    showPage(pageId);
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    } else {
        console.error(`Page with id "${pageId}" not found.`);
        document.getElementById('page-dashboard').classList.add('active');
    }
    if (pageId !== 'page-dashboard' && dashboardTimerInterval) {
        stopDashboardTimer();
    }
    loadPageContent(pageId);
}

function loadPageContent(pageId) {
    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    switch(pageId) {
        case 'page-dashboard':
            updateDashboard();
            updateLiveMonitor();
            liveMonitorInterval = setInterval(updateLiveMonitor, 15000);
            updateTimerDurationSuggestion();
            break;
        case 'page-peserta': loadPeserta(); break;
        case 'page-penguji': loadPenguji(); break;
        case 'page-station': loadStations(); break;
        case 'page-penilaian': populatePenilaianDropdowns(); break;
        case 'page-hasil': 
            loadScores(); 
            displayStationRankings(); 
            renderStationAnalyticsChart(); 
            renderRubricPerformanceChart(); 
            const avgGpr100Value = renderGlobalPerformanceAnalysis(); // Calculate GPR first.
            loadCollectiveResults(avgGpr100Value); // Pass it to collective results.
            renderRubricDifficultyChart(); 
            renderSessionComparisonChart(); 
            renderScoreVsGprChart(); 
            loadRemedialRecommendations(); 
            break;
        case 'page-log-sistem': loadSystemLog(); break;
        case 'page-feedback-summary': loadFeedbackSummary(); break;
        case 'page-sertifikat-settings': loadCertificateSettingsPage(); break;
        case 'page-sertifikat-print': loadCertificatePrintPage(); break;
        case 'page-sertifikat-penguji': loadPengujiCertificatePage(); break;
        // Peserta Pages
        case 'page-peserta-dashboard': loadPesertaDashboard(); break;
        case 'page-peserta-hasil': loadPesertaHasil(); break;
        case 'page-peserta-sertifikat': loadPesertaSertifikat(); break;
    }
}
function showSyncStatus(htmlContent, isClosable = false) {
    document.getElementById('sync-status-content').innerHTML = htmlContent;
    const modalElement = document.getElementById('syncModal');
    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
    modalElement.setAttribute('data-bs-backdrop', isClosable ? 'true' : 'static');
    modalElement.setAttribute('data-bs-keyboard', isClosable ? 'true' : 'false');
    modalInstance.show();
}

// =================================================================
// DATA SYNC & STORAGE
// =================================================================
function pushToGoogleSheets() {
    if (!confirm('ADMIN: Ini akan MENIMPA semua data di Google Spreadsheet dengan data lokal saat ini. Lanjutkan?')) return;
    const dataToSync = {
        peserta: getFromStorage('peserta'),
        penguji: getFromStorage('penguji'),
        stations: getFromStorage('stations'),
        scores: getFromStorage('scores'),
        scheduleParams: getFromStorage('osce_schedule_params'),
        feedback: getFromStorage('feedback')
    };
    showSyncStatus('<div class="spinner-border text-info" role="status"></div><h4 class="mt-3">Mengirim Semua Data...</h4>');
    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        body: JSON.stringify({ type: 'full_sync', payload: dataToSync })
    })
    .then(res => res.json()).then(data => { if (data.status === 'success') { showSyncStatus(`<i class="fas fa-check-circle fa-3x text-success mb-3"></i><h4>Sinkronisasi Berhasil!</h4><p class="text-muted">${data.message}</p><button class="btn btn-primary" data-bs-dismiss="modal">Tutup</button>`, true); logActivity('SYNC_PUSH_ALL'); } else { throw new Error(data.message); } }).catch(error => showSyncStatus(`<i class="fas fa-times-circle fa-3x text-danger mb-3"></i><h4>Sinkronisasi Gagal!</h4><p class="text-muted">Error:</p><small class="bg-light p-2 d-block text-start">${error.toString()}</small><button class="btn btn-secondary mt-3" data-bs-dismiss="modal">Tutup</button>`, true));
}

function pushPengujiScores() { const user = JSON.parse(sessionStorage.getItem('osce_user')); if (!user || user.role !== 'penguji') return; const pengujiId = user.id; const allScores = getFromStorage('scores'); const myScores = allScores.filter(s => s.pengujiId === pengujiId); if (myScores.length === 0) return alert("Anda belum memiliki data penilaian untuk dikirim."); if (!confirm(`Anda akan mengirim ${myScores.length} data penilaian ke server. Lanjutkan?`)) return; showSyncStatus('<div class="spinner-border text-info" role="status"></div><h4 class="mt-3">Mengirim Data Nilai Anda...</h4>'); fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ type: 'penguji_sync', payload: { pengujiId, scores: myScores } }) }).then(res => res.json()).then(data => { if (data.status === 'success') { showSyncStatus(`<i class="fas fa-check-circle fa-3x text-success mb-3"></i><h4>Kirim Nilai Berhasil!</h4><p class="text-muted">${data.message}</p><button class="btn btn-primary" data-bs-dismiss="modal">Tutup</button>`, true); } else { throw new Error(data.message); } }).catch(error => showSyncStatus(`<i class="fas fa-times-circle fa-3x text-danger mb-3"></i><h4>Kirim Nilai Gagal!</h4><p class="text-muted">Error:</p><small class="bg-light p-2 d-block text-start">${error.toString()}</small><button class="btn btn-secondary mt-3" data-bs-dismiss="modal">Tutup</button>`, true)); }

function pullDataFromServer(options = {}) {
    const { timeout = 30000 } = options;
    const controller = new AbortController();
    const signal = controller.signal;
    return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
            controller.abort();
            reject(new Error('Request timeout. Server tidak merespons.'));
        }, timeout);
        fetch(SCRIPT_URL, { method: 'GET', mode: 'cors', signal })
            .then(res => {
                if (!res.ok) { throw new Error(`Server merespons dengan status: ${res.status}`); }
                return res.json();
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (response.status === 'success' && response.data) {
                    saveToStorage('peserta', response.data.peserta || []);
                    saveToStorage('penguji', response.data.penguji || []);
                    saveToStorage('stations', response.data.stations || []);
                    saveToStorage('scores', response.data.scores || []);
                    saveToStorage('osce_schedule_params', response.data.scheduleParams || {});
                    saveToStorage('feedback', response.data.feedback || []);
                    // Update credentials from server
                    if (response.data.credentials) {
                        USER_CREDENTIALS = { "admin": "admin123" }; // Keep admin as hardcoded fallback
                        response.data.credentials.forEach(cred => {
                            if (cred.username && cred.password) {
                                USER_CREDENTIALS[cred.username] = cred.password;
                            }
                        });
                    }
                    resolve(response.data);
                } else {
                    reject(new Error(response.message || 'Format data dari server tidak valid.'));
                }
            }).catch(error => {
                clearTimeout(timeoutId);
                if (error.name !== 'AbortError') {
                    reject(error);
                }
            });
    });
}

async function pullFromGoogleSheets() {
    if (!confirm('Ini akan MENIMPA semua data lokal dengan data dari Google Spreadsheet, TERMASUK PENGATURAN JADWAL DAN KREDENSIAL. Lanjutkan?')) return;
    showSyncStatus('<div class="spinner-border text-success" role="status"></div><h4 class="mt-3">Menarik Data dari Spreadsheet...</h4>');
    try {
        await pullDataFromServer({ timeout: 60000 });
        showSyncStatus(`<i class="fas fa-check-circle fa-3x text-success mb-3"></i><h4>Tarik Data Berhasil!</h4><p class="text-muted">Memuat ulang tampilan...</p>`, true);
        logActivity('SYNC_PULL_ALL');
        setTimeout(() => {
            syncModal.hide();
            loadPageContent(document.querySelector('.page.active').id);
        }, 1500);
    } catch (error) {
        showSyncStatus(`<i class="fas fa-times-circle fa-3x text-danger mb-3"></i><h4>Tarik Data Gagal!</h4><p class="text-muted">Error:</p><small class="bg-light p-2 d-block text-start">${error.toString()}</small><button class="btn btn-secondary mt-3" data-bs-dismiss="modal">Tutup</button>`, true);
    }
}


// =================================================================
// UTILITY & HELPER FUNCTIONS
// =================================================================
const getFromStorage = (key) => JSON.parse(localStorage.getItem(key)) || (key === 'osce_schedule_params' || key === 'osce_cert_settings' ? {} : []);
const saveToStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
const shuffleArray = (array) => { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } };
const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
const timeToDate = (timeStr, baseDate = new Date()) => { const [hours, minutes] = timeStr.split(':').map(Number); const newDate = new Date(baseDate); newDate.setHours(hours, minutes, 0, 0); return newDate; };
function calculateWeightedScore(scoreObject, station) { if (!station || !station.rubric || !scoreObject) return { achieved: 0, max: 0, percentage: 0 }; let achievedScore = 0; let maxPossibleScore = 0; scoreObject.scores.forEach(item => { const rubricItem = station.rubric.find(r => r.id === item.rubricId); if (rubricItem) { const weight = rubricItem.bobot || 1; achievedScore += item.score * weight; maxPossibleScore += rubricItem.maxScore * weight; } }); const percentage = maxPossibleScore > 0 ? (achievedScore / maxPossibleScore) * 100 : 0; return { achieved: achievedScore, max: maxPossibleScore, percentage }; }

// =================================================================
// CRUD: PESERTA (REVISED FOR PASSWORD)
// =================================================================
function addPeserta(e) {
    e.preventDefault();
    const nim = document.getElementById('peserta-nim').value.trim();
    const nama = document.getElementById('peserta-nama').value.trim();
    let password = document.getElementById('peserta-password').value.trim();
    if (!nim || !nama) return alert("NIM dan Nama tidak boleh kosong!");
    if (!password) password = nim; // Default password is NIM if left empty
    let peserta = getFromStorage('peserta');
    if (peserta.some(p => p.nim === nim)) return alert("NIM sudah terdaftar.");
    peserta.push({ id: Date.now(), nim, nama, password, sesi: null });
    saveToStorage('peserta', peserta);
    logActivity('CREATE_PESERTA', `NIM: ${nim}, Nama: ${nama}`);
    document.getElementById('form-add-peserta').reset();
    loadPeserta();
}
function loadPeserta() { const peserta = getFromStorage('peserta'); document.getElementById('table-peserta-body').innerHTML = peserta.sort((a,b) => (a.sesi || 999) - (b.sesi || 999) || a.nama.localeCompare(b.nama)).map(p => { const sesi = p.sesi || '<span class="text-muted fst-italic">Belum Dijadwalkan</span>'; return `<tr><td>${p.nim}</td><td>${p.nama}</td><td><b>${sesi}</b></td><td class="text-center"><button class="btn btn-sm btn-info me-2" onclick="printExamCard(${p.id})" title="Cetak Kartu Ujian"><i class="fas fa-id-card"></i> Kartu</button><button class="btn btn-sm btn-warning me-2" onclick="openEditPesertaModal(${p.id})" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="deleteItem('peserta', ${p.id}, loadPeserta)" title="Hapus"><i class="fas fa-trash-alt"></i></button></td></tr>`; }).join('') || `<tr><td colspan="4" class="text-center text-muted">Belum ada data peserta.</td></tr>`; }
function openEditPesertaModal(id) { const peserta = getFromStorage('peserta').find(p => p.id === id); if (peserta) { document.getElementById('edit-peserta-id').value = peserta.id; document.getElementById('edit-peserta-nim').value = peserta.nim; document.getElementById('edit-peserta-nama').value = peserta.nama; document.getElementById('edit-peserta-password').value = ""; editPesertaModal.show(); } }
function savePesertaChanges() {
    const id = parseInt(document.getElementById('edit-peserta-id').value);
    const nim = document.getElementById('edit-peserta-nim').value.trim();
    const nama = document.getElementById('edit-peserta-nama').value.trim();
    const newPassword = document.getElementById('edit-peserta-password').value.trim();
    if (!nim || !nama) return alert("NIM dan Nama tidak boleh kosong.");
    let pesertaList = getFromStorage('peserta');
    const index = pesertaList.findIndex(p => p.id === id);
    if (index > -1) {
        if (pesertaList.some(p => p.nim === nim && p.id !== id)) {
            return alert("NIM sudah digunakan peserta lain.");
        }
        pesertaList[index].nim = nim;
        pesertaList[index].nama = nama;
        if (newPassword) {
            pesertaList[index].password = newPassword;
        }
        saveToStorage('peserta', pesertaList);
        logActivity('UPDATE_PESERTA', `ID: ${id}, NIM: ${nim}, Nama: ${nama}`);
        loadPeserta();
        editPesertaModal.hide();
    }
}
// All other functions from the previous response follow here...
// (The rest of the script is identical to the one I provided before the "lanjutkan" prompt)

// =================================================================
// DASHBOARD GLOBAL TIMER FUNCTIONS
// =================================================================
function updateDashboardTimerDisplay() {
    const display = document.getElementById('dashboard-timer-display');
    const remainingMs = dashboardTimerEndTime - new Date().getTime();

    if (remainingMs <= 0) {
        display.textContent = "00:00";
        display.classList.remove('text-warning');
        display.classList.add('text-danger');
        document.getElementById('dashboard-timer-info').textContent = 'Waktu Habis!';
        stopDashboardTimer(); // Stop and reset everything
        alert("Waktu telah habis!");
        return;
    }

    const seconds = Math.floor((remainingMs / 1000) % 60);
    const minutes = Math.floor(remainingMs / (1000 * 60));
    
    display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

    if (remainingMs < 60000 && remainingMs > 0) {
        display.classList.add('text-warning');
        display.classList.remove('text-danger');
    } else {
        display.classList.remove('text-warning', 'text-danger');
    }
}
function updateTimerDurationSuggestion() {
    const selector = document.querySelector('input[name="timer-type"]:checked');
    if (!selector) return;

    const type = selector.value;
    const durationInput = document.getElementById('timer-duration-input');
    const suggestionText = document.getElementById('timer-duration-suggestion');
    
    const { stations, rotationDuration } = getScheduleParameters();

    if (type === 'rotation') {
        const finalDuration = rotationDuration > 0 ? rotationDuration : 10; // Fallback
        durationInput.value = finalDuration;
        suggestionText.textContent = `Durasi rotasi sesuai jadwal adalah ${finalDuration} menit.`;
    } else if (type === 'session') {
        if (stations.length > 0 && rotationDuration > 0) {
            const sessionDuration = rotationDuration * stations.length;
            durationInput.value = sessionDuration;
            suggestionText.textContent = `Total durasi sesi (${stations.length} stasiun x ${rotationDuration} mnt) adalah ${sessionDuration} menit.`;
        } else {
            durationInput.value = 60; // fallback
            suggestionText.textContent = 'Data stasiun/jadwal tidak ditemukan. Durasi default 60 menit.';
        }
    }
}
function startDashboardTimer() {
    if (dashboardTimerState !== 'stopped') return;

    const durationInput = document.getElementById('timer-duration-input');
    const durationInMinutes = parseInt(durationInput.value);

    if (isNaN(durationInMinutes) || durationInMinutes <= 0) {
        alert("Harap masukkan durasi yang valid (angka positif).");
        return;
    }
    
    const timerType = document.querySelector('input[name="timer-type"]:checked').value;
    const timerTypeLabel = timerType === 'rotation' ? 'Rotasi' : 'Sesi';

    dashboardTimerEndTime = new Date().getTime() + durationInMinutes * 60 * 1000;

    document.getElementById('dashboard-timer-info').textContent = `Timer ${timerTypeLabel} (${durationInMinutes} menit) sedang berjalan...`;

    dashboardTimerInterval = setInterval(updateDashboardTimerDisplay, 1000);
    dashboardTimerState = 'running';
    updateDashboardTimerDisplay();

    document.getElementById('btn-timer-start').disabled = true;
    document.getElementById('btn-timer-pause').disabled = false;
    document.getElementById('btn-timer-stop').disabled = false;
    durationInput.disabled = true;
    document.querySelectorAll('#timer-type-selector .btn-check').forEach(input => input.disabled = true);
    document.querySelectorAll('#timer-type-selector .btn-outline-primary').forEach(label => label.classList.add('disabled'));
}
function pauseDashboardTimer() {
    const pauseButton = document.getElementById('btn-timer-pause');
    const infoDisplay = document.getElementById('dashboard-timer-info');

    if (dashboardTimerState === 'running') {
        clearInterval(dashboardTimerInterval);
        dashboardTimerRemaining = dashboardTimerEndTime - new Date().getTime();
        dashboardTimerState = 'paused';
        pauseButton.innerHTML = '<i class="fas fa-play me-2"></i>Lanjutkan';
        pauseButton.classList.replace('btn-warning', 'btn-info');
        dashboardTimerInfoText = infoDisplay.textContent;
        infoDisplay.innerHTML += " <b>(Dijeda)</b>";
    } else if (dashboardTimerState === 'paused') {
        dashboardTimerEndTime = new Date().getTime() + dashboardTimerRemaining;
        dashboardTimerInterval = setInterval(updateDashboardTimerDisplay, 1000);
        dashboardTimerState = 'running';
        pauseButton.innerHTML = '<i class="fas fa-pause me-2"></i>Jeda';
        pauseButton.classList.replace('btn-info', 'btn-warning');
        infoDisplay.textContent = dashboardTimerInfoText;
    }
}
function stopDashboardTimer() {
    clearInterval(dashboardTimerInterval);
    dashboardTimerInterval = null;
    dashboardTimerState = 'stopped';
    dashboardTimerEndTime = null;
    dashboardTimerRemaining = 0;
    dashboardTimerInfoText = '';

    const display = document.getElementById('dashboard-timer-display');
    display.textContent = '00:00';
    display.classList.remove('text-warning', 'text-danger');
    document.getElementById('dashboard-timer-info').textContent = 'Menunggu...';
    
    const startBtn = document.getElementById('btn-timer-start');
    const pauseBtn = document.getElementById('btn-timer-pause');
    const stopBtn = document.getElementById('btn-timer-stop');

    startBtn.disabled = false;
    pauseBtn.disabled = true;
    stopBtn.disabled = true;

    pauseBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Jeda';
    if(pauseBtn.classList.contains('btn-info')) {
        pauseBtn.classList.replace('btn-info', 'btn-warning');
    }
    
    document.getElementById('timer-duration-input').disabled = false;
    document.querySelectorAll('#timer-type-selector .btn-check').forEach(input => input.disabled = false);
    document.querySelectorAll('#timer-type-selector .btn-outline-primary').forEach(label => label.classList.remove('disabled'));
    updateTimerDurationSuggestion();
}


// =================================================================
// MANAJEMEN JADWAL & PRINT
// =================================================================
function openGenerateScheduleModal() {
    const stations = getFromStorage('stations');
    if (stations.length === 0) {
        return alert("Tidak ada data stasiun. Harap buat stasiun terlebih dahulu untuk membuat jadwal.");
    }
    const existingParams = getFromStorage('osce_schedule_params');
    if (existingParams && existingParams.startDate) {
        document.getElementById('schedule-start-date').value = existingParams.startDate;
        document.getElementById('schedule-start-time').value = existingParams.startTime || '08:00';
        document.getElementById('schedule-end-time').value = existingParams.endTime || '17:00';
        document.getElementById('schedule-duration').value = existingParams.defaultDuration || 10;
        document.getElementById('schedule-break').value = existingParams.breakDuration || 15;
        document.getElementById('schedule-lunch-start').value = existingParams.lunchStartTime || '12:00';
        document.getElementById('schedule-lunch-end').value = existingParams.lunchEndTime || '13:00';
    }
    
    generateScheduleModal.show();
}
function generateExamSchedule() {
    let peserta = getFromStorage('peserta');
    const stations = getFromStorage('stations');
    if (peserta.length === 0) return alert("Tidak ada data peserta untuk dijadwalkan.");
    if (stations.length === 0) return alert("Tidak ada data stasiun. Harap buat stasiun terlebih dahulu.");
    const startDateInput = document.getElementById('schedule-start-date').value;
    if (!startDateInput) return alert("Harap tentukan Tanggal Mulai Ujian.");
    if (!confirm("Anda akan membuat jadwal ujian baru. Jadwal yang sudah ada akan ditimpa. Lanjutkan? (Jangan lupa sinkronkan data setelah ini)")) return;
    const scheduleParams = { startDate: startDateInput, startTime: document.getElementById('schedule-start-time').value, endTime: document.getElementById('schedule-end-time').value, defaultDuration: parseInt(document.getElementById('schedule-duration').value), breakDuration: parseInt(document.getElementById('schedule-break').value), lunchStartTime: document.getElementById('schedule-lunch-start').value, lunchEndTime: document.getElementById('schedule-lunch-end').value, };
    saveToStorage('osce_schedule_params', scheduleParams);
    peserta.forEach(p => { p.sesi = null; });
    let shuffledPeserta = [...peserta]; 
    shuffleArray(shuffledPeserta);
    const groupSize = stations.length;
    let sessionNumber = 1;
    for (let i = 0; i < shuffledPeserta.length; i += groupSize) {
        const sessionPeserta = shuffledPeserta.slice(i, i + groupSize);
        sessionPeserta.forEach(p => {
            const pesertaToUpdate = peserta.find(original => original.id === p.id);
            if(pesertaToUpdate) pesertaToUpdate.sesi = sessionNumber;
        });
        sessionNumber++;
    }
    saveToStorage('peserta', peserta);
    logActivity('GENERATE_SCHEDULE');
    alert(`Jadwal sesi berhasil dibuat untuk ${peserta.length} peserta. Total ${sessionNumber - 1} sesi dibuat. Harap sinkronkan data agar jadwal ini dapat diakses dari perangkat lain.`);
    generateScheduleModal.hide();
    if (document.getElementById('page-peserta').classList.contains('active')) loadPeserta();
    if (document.getElementById('page-dashboard').classList.contains('active')) updateDashboard();
}
function clearExamSchedule() {
    if (!confirm("Anda yakin ingin menghapus SEMUA jadwal sesi dari peserta dan parameter jadwal? Tindakan ini tidak dapat diurungkan.")) return;
    let peserta = getFromStorage('peserta');
    if (peserta.every(p => !p.sesi)) return alert("Tidak ada jadwal yang perlu dihapus.");
    peserta.forEach(p => { p.sesi = null; });
    saveToStorage('peserta', peserta);
    saveToStorage('osce_schedule_params', {}); // Menghapus parameter jadwal juga
    logActivity('CLEAR_SCHEDULE');
    alert("Semua jadwal sesi peserta dan pengaturan jadwal berhasil dihapus. Jangan lupa sinkronkan perubahan ini.");
    if (document.getElementById('page-peserta').classList.contains('active')) loadPeserta();
}
function getScheduleParameters() {
    const stations = getFromStorage('stations');
    const params = getFromStorage('osce_schedule_params') || {};
    const defaults = { startDate: new Date().toISOString().slice(0,10), startTime: '08:00', endTime: '17:00', defaultDuration: 10, breakDuration: 15, lunchStartTime: '12:00', lunchEndTime: '13:00' };
    const finalParams = { ...defaults, ...params };
    const rotationDuration = Math.max( finalParams.defaultDuration, ...stations.map(s => s.maxTime || 0) );
    return { stations, rotationDuration, ...finalParams };
}
function calculateFullSchedule() {
    const peserta = getFromStorage('peserta');
    const { stations, startDate, startTime, endTime, breakDuration, lunchStartTime, lunchEndTime, rotationDuration } = getScheduleParameters();
    if (stations.length === 0 || peserta.filter(p => p.sesi).length === 0 || !startDate) return [];
    const scheduleBySession = peserta.reduce((acc, p) => { if (!p.sesi) return acc; if (!acc[p.sesi]) acc[p.sesi] = []; acc[p.sesi].push(p); return acc; }, {});
    const fullSchedule = [];
    const baseDate = new Date(startDate + 'T00:00:00');
    let currentDayDate = new Date(baseDate);
    let currentTime = timeToDate(startTime, currentDayDate);
    const maxEndTime = timeToDate(endTime);
    const sortedSessionKeys = Object.keys(scheduleBySession).sort((a,b) => parseInt(a) - parseInt(b));
    sortedSessionKeys.forEach((sesiStr, sessionIndex) => {
        const sesi = parseInt(sesiStr);
        const sessionPeserta = scheduleBySession[sesi];
        const lunchBreakStart = timeToDate(lunchStartTime, currentDayDate);
        const lunchBreakEnd = timeToDate(lunchEndTime, currentDayDate);
        const sessionTotalDuration = stations.length * rotationDuration;
        let potentialSessionStartTime = new Date(currentTime);
        if (potentialSessionStartTime < lunchBreakEnd && new Date(potentialSessionStartTime.getTime() + sessionTotalDuration * 60000) > lunchBreakStart) {
             potentialSessionStartTime = new Date(lunchBreakEnd);
        }
        const potentialSessionEndTime = new Date(potentialSessionStartTime.getTime() + sessionTotalDuration * 60000);
        maxEndTime.setFullYear(currentDayDate.getFullYear(), currentDayDate.getMonth(), currentDayDate.getDate());
        if (potentialSessionEndTime > maxEndTime) {
            currentDayDate.setDate(currentDayDate.getDate() + 1);
            potentialSessionStartTime = timeToDate(startTime, currentDayDate);
            const newDayLunchStart = timeToDate(lunchStartTime, currentDayDate);
            const newDayLunchEnd = timeToDate(lunchEndTime, currentDayDate);
            if (potentialSessionStartTime < newDayLunchEnd && new Date(potentialSessionStartTime.getTime() + sessionTotalDuration * 60000) > newDayLunchStart) {
                potentialSessionStartTime = new Date(newDayLunchEnd);
            }
        }
        currentTime = new Date(potentialSessionStartTime);
        for (let i = 0; i < stations.length; i++) {
            const rotationStartTime = new Date(currentTime);
            const rotationEndTime = new Date(rotationStartTime.getTime() + rotationDuration * 60000);
            for (let j = 0; j < stations.length; j++) {
                const pesertaIndex = (i + j) % sessionPeserta.length;
                const p = sessionPeserta[pesertaIndex];
                const s = stations[j];
                if (p && s) {
                    fullSchedule.push({ date: new Date(currentDayDate), sesi: sesi, rotasi: i + 1, waktuMulai: formatTime(rotationStartTime), waktuSelesai: formatTime(rotationEndTime), station: s, peserta: p });
                }
            }
            currentTime = rotationEndTime;
        }
        const isLastSession = sessionIndex === sortedSessionKeys.length - 1;
        if (!isLastSession) currentTime.setMinutes(currentTime.getMinutes() + breakDuration);
    });
    return fullSchedule;
}
function printSchedule() {
    const fullSchedule = calculateFullSchedule();
    const { stations, rotationDuration, breakDuration, lunchStartTime, lunchEndTime } = getScheduleParameters();
    const penguji = getFromStorage('penguji');
    const settings = getFromStorage('osce_cert_settings') || {};
    const institutionName = settings.institutionName || 'D3 KEBIDANAN';
    if (fullSchedule.length === 0) return alert("Jadwal belum digenerate atau tidak ada data yang valid. Silakan generate jadwal terlebih dahulu.");
    const scheduleByDateAndSession = fullSchedule.reduce((acc, item) => { const dateKey = `${item.date.getFullYear()}-${String(item.date.getMonth() + 1).padStart(2, '0')}-${String(item.date.getDate()).padStart(2, '0')}`; if (!acc[dateKey]) acc[dateKey] = {}; if (!acc[dateKey][item.sesi]) acc[dateKey][item.sesi] = []; acc[dateKey][item.sesi].push(item); return acc; }, {});
    let printContent = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><title>Jadwal Rotasi Ujian OSCE</title><style>body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.4;font-size:10pt;}@page{size:A4 landscape;margin:1.5cm;}.header{text-align:center;margin-bottom:1em;}h1{font-size:20px;margin-bottom:0.2em;}h2{font-size:16px;margin-bottom:0.5em;font-weight:normal;}h3{font-size:14px;margin-top:1.5em;background-color:#e9ecef;padding:8px;border-radius:5px;text-align:left;}.day-header{font-size:18px;text-align:center;border-bottom:2px solid #333;padding-bottom:5px;margin:2em 0 1em 0;page-break-before:always;}.day-header:first-of-type{page-break-before:auto;}table{width:100%;border-collapse:collapse;margin-top:1em;}th,td{border:1px solid #ccc;padding:6px;text-align:center;vertical-align:middle;}th{background-color:#f2f2f2;font-weight:bold;}.session-block{margin-bottom:2em;page-break-inside:avoid;}.penguji-info{font-size:0.8em;color:#555;display:block;font-weight:normal;}.peserta-info{font-size:0.9em;}.peserta-info small{color:#666;}</style></head><body><div class="header"><h1>JADWAL ROTASI UJIAN OSCE</h1><h2>${institutionName.toUpperCase()}</h2><p style="font-size:12px;margin-top:0;">Durasi Rotasi:<b>${rotationDuration} menit</b> | Jeda Sesi:<b>${breakDuration} menit</b> | Istirahat Panjang (ISHOMA):<b>${lunchStartTime} - ${lunchEndTime}</b></p></div><hr>`;
    Object.keys(scheduleByDateAndSession).sort().forEach(dateKey => { const date = new Date(dateKey + 'T00:00:00'); const formattedDate = date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); printContent += `<h2 class="day-header">JADWAL UNTUK: ${formattedDate.toUpperCase()}</h2>`; const daySchedule = scheduleByDateAndSession[dateKey]; Object.keys(daySchedule).sort((a,b)=>a-b).forEach(sesi => { const sessionSchedule = daySchedule[sesi]; const rotations = sessionSchedule.reduce((acc, item) => { if (!acc[item.rotasi]) acc[item.rotasi] = { waktu: `${item.waktuMulai} - ${item.waktuSelesai}`, pesertaPerStation: {} }; acc[item.rotasi].pesertaPerStation[item.station.id] = item.peserta; return acc; }, {}); printContent += `<div class="session-block"><h3>SESI ${sesi}</h3><table><thead><tr><th>Waktu</th><th>Rotasi</th>`; stations.forEach(station => { const assignedPenguji = penguji.find(p => p.assignedStationId === station.id); printContent += `<th>${station.name}<span class="penguji-info">(${assignedPenguji ? assignedPenguji.nama : 'N/A'})</span></th>`; }); printContent += `</tr></thead><tbody>`; Object.keys(rotations).sort((a,b)=>a-b).forEach(rotasi => { const rotationData = rotations[rotasi]; printContent += `<tr><td><b>${rotationData.waktu}</b></td><td><b>${rotasi}</b></td>`; stations.forEach(station => { const p = rotationData.pesertaPerStation[station.id]; printContent += `<td><span class="peserta-info">${p ? p.nama : ''}<br><small>(${p ? p.nim : ''})</small></span></td>`; }); printContent += `</tr>`; }); printContent += `</tbody></table></div>`; }); });
    printContent += `</body></html>`; const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}
function exportScheduleToCSV() {
    const fullSchedule = calculateFullSchedule();
    if (fullSchedule.length === 0) return alert("Jadwal belum digenerate atau tidak ada data yang valid. Silakan generate jadwal terlebih dahulu.");
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Tanggal,Sesi,Rotasi,Waktu Mulai,Waktu Selesai,ID Stasiun,Nama Stasiun,NIM Peserta,Nama Peserta\n";
    fullSchedule.forEach(item => { const row = [ item.date.toISOString().slice(0, 10), item.sesi, item.rotasi, item.waktuMulai, item.waktuSelesai, item.station.id, `"${item.station.name}"`, item.peserta.nim, `"${item.peserta.nama}"` ].join(","); csvContent += row + "\n"; });
    const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `jadwal_osce_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

// =================================================================
// CRUD: PENGUJI & CREDENTIALS
// =================================================================
function addPenguji(e) { e.preventDefault(); const idPenguji = document.getElementById('penguji-id').value.trim(); const nama = document.getElementById('penguji-nama').value.trim(); const assignedStationId = document.getElementById('penguji-station').value; if (!idPenguji || !nama || !assignedStationId) return alert("ID, Nama Penguji, dan Station tidak boleh kosong."); let penguji = getFromStorage('penguji'); if (penguji.some(p => p.idPenguji === idPenguji)) return alert("Penguji dengan ID ini sudah terdaftar."); penguji.push({ id: Date.now(), idPenguji: idPenguji, nama: nama, assignedStationId: parseInt(assignedStationId) }); saveToStorage('penguji', penguji); logActivity('CREATE_PENGUJI', `ID Penguji: ${idPenguji}, Nama: ${nama}`); document.getElementById('form-add-penguji').reset(); loadPenguji(); }
function loadPenguji() {
    const penguji = getFromStorage('penguji');
    const stations = getFromStorage('stations');
    const tableBody = document.getElementById('table-penguji-body');
    const stationSelect = document.getElementById('penguji-station');
    stationSelect.innerHTML = '<option value="" selected disabled>-- Pilih Station --</option>';
    stations.forEach(s => { stationSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`; });
    tableBody.innerHTML = penguji.map(p => { const assignedStation = stations.find(s => s.id === p.assignedStationId); const stationName = assignedStation ? assignedStation.name : '<span class="text-danger fw-bold">Tidak Ditemukan</span>'; return `<tr><td>${p.idPenguji}</td><td>${p.nama}</td><td>${stationName}</td><td class="text-center"><button class="btn btn-sm btn-secondary me-2" onclick="openEditCredentialsModal(${p.id})" title="Ubah Username/Password"><i class="fas fa-key"></i></button><button class="btn btn-sm btn-warning me-2" onclick="openEditPengujiModal(${p.id})" title="Edit Detail"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="deleteItem('penguji', ${p.id}, loadPenguji)" title="Hapus"><i class="fas fa-trash-alt"></i></button></td></tr>`; }).join('') || `<tr><td colspan="4" class="text-center text-muted">Belum ada data penguji.</td></tr>`;
}
function openEditPengujiModal(id) { const penguji = getFromStorage('penguji').find(p => p.id === id); const stations = getFromStorage('stations'); if (penguji) { document.getElementById('edit-penguji-id').value = penguji.id; document.getElementById('edit-penguji-idPenguji').value = penguji.idPenguji; document.getElementById('edit-penguji-nama').value = penguji.nama; const stationSelect = document.getElementById('edit-penguji-station'); stationSelect.innerHTML = '<option value="">-- Tidak Ada --</option>'; stations.forEach(s => { stationSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`; }); stationSelect.value = penguji.assignedStationId || ""; editPengujiModal.show(); } }
function savePengujiChanges() { const id = parseInt(document.getElementById('edit-penguji-id').value); const nama = document.getElementById('edit-penguji-nama').value.trim(); const assignedStationId = document.getElementById('edit-penguji-station').value; if (!nama) return alert("Nama Lengkap tidak boleh kosong."); let pengujiList = getFromStorage('penguji'); const index = pengujiList.findIndex(p => p.id === id); if (index > -1) { pengujiList[index].nama = nama; pengujiList[index].assignedStationId = assignedStationId ? parseInt(assignedStationId) : null; saveToStorage('penguji', pengujiList); logActivity('UPDATE_PENGUJI', `ID: ${id}, Nama: ${nama}`); loadPenguji(); editPengujiModal.hide(); } }
function openEditCredentialsModal(id) {
    const penguji = getFromStorage('penguji').find(p => p.id === id);
    if (penguji) { document.getElementById('form-edit-credentials').reset(); document.getElementById('edit-credentials-penguji-id').value = penguji.id; document.getElementById('edit-credentials-nama').value = penguji.nama; document.getElementById('edit-credentials-old-username').value = penguji.idPenguji; editCredentialsModal.show(); }
}
async function saveCredentialsChanges() {
    const pengujiId = parseInt(document.getElementById('edit-credentials-penguji-id').value);
    const oldUsername = document.getElementById('edit-credentials-old-username').value;
    const newUsername = document.getElementById('edit-credentials-new-username').value.trim();
    const newPassword = document.getElementById('edit-credentials-new-password').value;
    const confirmPassword = document.getElementById('edit-credentials-confirm-password').value;
    const saveButton = document.querySelector('#editCredentialsModal .btn-primary');
    if (!newUsername && !newPassword) return alert("Tidak ada perubahan yang dimasukkan. Harap isi Username Baru atau Password Baru.");
    if (newPassword && newPassword !== confirmPassword) return alert("Password Baru dan Konfirmasi Password tidak cocok.");
    const finalUsername = newUsername || oldUsername;
    if (finalUsername !== oldUsername) { const allPenguji = getFromStorage('penguji'); if (allPenguji.some(p => p.idPenguji === finalUsername && p.id !== pengujiId)) return alert("Username baru sudah digunakan oleh penguji lain. Silakan pilih username lain."); }
    if (!confirm(`Anda akan mengubah kredensial untuk ${oldUsername}. Ini akan mengubah data di Google Sheets. Lanjutkan?`)) return;
    saveButton.disabled = true; saveButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
    const payload = { oldUsername: oldUsername, newUsername: newUsername || null, newPassword: newPassword || null };
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ type: 'update_credentials', payload: payload }) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message || 'Server mengembalikan error.');
        let pengujiList = getFromStorage('penguji'); const index = pengujiList.findIndex(p => p.id === pengujiId);
        if (index > -1) { if (payload.newUsername) pengujiList[index].idPenguji = payload.newUsername; saveToStorage('penguji', pengujiList); }
        const finalUsernameToUpdate = payload.newUsername || oldUsername;
        if (USER_CREDENTIALS[oldUsername]) { const oldPasswordValue = USER_CREDENTIALS[oldUsername]; delete USER_CREDENTIALS[oldUsername]; USER_CREDENTIALS[finalUsernameToUpdate] = payload.newPassword || oldPasswordValue; }
        logActivity('UPDATE_CREDENTIALS', `Old Username: ${oldUsername}, New Username: ${finalUsernameToUpdate}`);
        alert("Kredensial penguji telah berhasil diperbarui.");
        editCredentialsModal.hide(); loadPenguji();
    } catch (error) { alert(`Gagal memperbarui kredensial: ${error.message}`); } finally { saveButton.disabled = false; saveButton.innerHTML = 'Simpan Perubahan'; }
}


// =================================================================
// CRUD: STATION & RUBRIC PRINTING
// =================================================================
function openStationModal(id = null) {
    const form = document.getElementById('form-station');
    form.reset();
    document.getElementById('station-id').value = "";
    document.getElementById('rubric-inputs-container').innerHTML = "";
    const modalLabel = document.getElementById('stationModalLabel');
    if (id) {
        const station = getFromStorage('stations').find(s => s.id === id);
        if (station) {
            modalLabel.innerHTML = '<i class="fas fa-edit"></i> Edit Station';
            document.getElementById('station-id').value = station.id;
            document.getElementById('station-name').value = station.name;
            document.getElementById('station-time').value = station.maxTime || '';
            document.getElementById('station-passing-grade').value = station.passingGrade || '';
            document.getElementById('station-soal').value = station.soal || '';
            station.rubric.forEach(r => addRubricInput(r.criteria, r.maxScore, r.bobot));
        }
    } else {
        modalLabel.innerHTML = '<i class="fas fa-plus-circle"></i> Tambah Station Baru';
        addRubricInput();
    }
    stationModal.show();
}
function addRubricInput(criteria = "", maxScore = "", bobot = "1") {
    const container = document.getElementById('rubric-inputs-container');
    const div = document.createElement('div');
    div.className = "input-group mb-2";
    div.innerHTML = `<input type="text" class="form-control form-control-sm" placeholder="Kriteria Penilaian" value="${criteria}" required>
                     <input type="number" class="form-control form-control-sm" placeholder="Skor Max" style="max-width:100px;" value="${maxScore}" required min="1">
                     <input type="number" class="form-control form-control-sm" placeholder="Bobot" style="max-width:100px;" value="${bobot || 1}" required min="1">
                     <button class="btn btn-outline-danger btn-sm" type="button" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
    container.appendChild(div);
}
function saveStation() {
    const stationId = document.getElementById('station-id').value;
    const stationName = document.getElementById('station-name').value.trim();
    const maxTime = parseInt(document.getElementById('station-time').value) || 0;
    const passingGrade = parseInt(document.getElementById('station-passing-grade').value) || 75;
    const stationSoal = document.getElementById('station-soal').value.trim();
    if (!stationName) return alert("Nama station tidak boleh kosong.");
    const rubricInputs = document.querySelectorAll('#rubric-inputs-container .input-group');
    if (rubricInputs.length === 0) return alert("Station harus memiliki minimal satu kriteria.");
    const newRubric = [];
    let isValid = true;
    rubricInputs.forEach((inputGroup, index) => { const criteria = inputGroup.children[0].value.trim(); const maxScore = parseInt(inputGroup.children[1].value); const bobot = parseInt(inputGroup.children[2].value); if (criteria && maxScore > 0 && bobot > 0) { newRubric.push({ id: index + 1, criteria: criteria, maxScore: maxScore, bobot: bobot }); } else { isValid = false; } });
    if (!isValid) return alert("Pastikan semua kriteria terisi dengan benar (Kriteria tidak kosong, Skor Max > 0, Bobot > 0).");
    let stations = getFromStorage('stations');
    const newStationData = { name: stationName, maxTime, passingGrade, soal: stationSoal, rubric: newRubric };
    const isUpdate = !!stationId;
    if (isUpdate) { const index = stations.findIndex(s => s.id == stationId); if (index > -1) stations[index] = { ...stations[index], ...newStationData }; } else { stations.push({ id: Date.now(), ...newStationData }); }
    saveToStorage('stations', stations);
    logActivity(isUpdate ? 'UPDATE_STATION' : 'CREATE_STATION', `Nama: ${stationName}`);
    loadStations(); stationModal.hide();
}
function loadStations() { const stations = getFromStorage('stations'); const container = document.getElementById('station-list-container'); if (stations.length > 0) { container.innerHTML = stations.map(s => `<div class="card mb-3"><div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2"><span class="fw-bold">${s.name}</span><div class="d-flex align-items-center gap-2">${s.maxTime > 0 ? `<span class="badge bg-primary"><i class="fas fa-clock"></i> ${s.maxTime} menit</span>` : ''} <span class="badge bg-success"><i class="fas fa-check"></i> Lulus: ${s.passingGrade || 75}%</span> <button class="btn btn-sm btn-info" onclick="printRubric(${s.id})"><i class="fas fa-print"></i> Cetak Rubrik</button> <button class="btn btn-sm btn-warning" onclick="openStationModal(${s.id})"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-sm btn-danger" onclick="deleteItem('stations', ${s.id}, loadStations)"><i class="fas fa-trash-alt"></i> Hapus</button></div></div><ul class="list-group list-group-flush">${s.rubric.map(r => `<li class="list-group-item d-flex justify-content-between"><span>${r.criteria}</span> <div><span class="badge bg-secondary rounded-pill me-2">Maks: ${r.maxScore}</span><span class="badge bg-info rounded-pill">Bobot: ${r.bobot || 1}</span></div></li>`).join('')}</ul></div>`).join(''); } else { container.innerHTML = '<div class="text-center p-5"><p class="text-muted">Belum ada station yang ditambahkan.</p></div>'; } }
function printRubric(stationId) {
    const station = getFromStorage('stations').find(s => s.id === stationId); if (!station) return; const settings = getFromStorage('osce_cert_settings') || {}; const institutionName = settings.institutionName || 'PROGRAM STUDI D3 KEBIDANAN'; let printContent = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><title>Rubrik Penilaian - ${station.name}</title><style>body{font-family:'Segoe UI',sans-serif;font-size:11pt;margin:2cm;}h1,h2{text-align:center;}h1{font-size:18pt;}h2{font-size:14pt;font-weight:normal;margin-bottom:2em;}.soal-container{border:1px solid #ddd;padding:1em;margin-bottom:2em;background-color:#f9f9f9;white-space:pre-wrap;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:8px;text-align:left;}th{background-color:#f2f2f2;}.score-column{text-align:center;width:100px;}.check-column{text-align:center;width:80px;}@media print{body{margin:1.5cm;}}</style></head><body><h1>FORMULIR PENILAIAN UJIAN OSCE</h1><h2>STATION: ${station.name}<br>${institutionName.toUpperCase()}</h2>`;
    if (station.soal) printContent += `<h3>Skenario / Soal</h3><div class="soal-container">${station.soal}</div>`;
    printContent += `<h3>Rubrik Penilaian</h3><table><thead><tr><th>No.</th><th>Kriteria Penilaian</th><th class="score-column">Bobot</th><th class="score-column">Skor Maksimal</th><th class="check-column">Skor</th></tr></thead><tbody>`;
    station.rubric.forEach((r, index) => { printContent += `<tr><td style="text-align:center;">${index + 1}</td><td>${r.criteria}</td><td class="score-column">${r.bobot || 1}</td><td class="score-column">${r.maxScore}</td><td class="check-column"></td></tr>`; });
    printContent += `</tbody></table><div style="margin-top:2em;"><h4>Komentar / Feedback:</h4><div style="border:1px solid #ccc;height:150px;padding:5px;"></div></div><div style="margin-top:3em;display:flex;justify-content:space-between;"><div><p>Nama Peserta: .........................</p><p>NIM: .....................................</p></div><div><p>Nama Penguji: .........................</p><p>Tanda Tangan: .......................</p></div></div></body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}

// =================================================================
// DASHBOARD & CHARTS
// =================================================================
function updateDashboard() {
    const peserta = getFromStorage('peserta');
    const penguji = getFromStorage('penguji');
    const stations = getFromStorage('stations');
    const scores = getFromStorage('scores');
    const REQUIRED_STATIONS_FOR_COMPLETION = 9;
    document.getElementById('total-peserta').innerText = peserta.length;
    document.getElementById('total-penguji').innerText = penguji.length;
    document.getElementById('total-station').innerText = stations.length;
    const progressMap = new Map();
    scores.forEach(score => { const participantId = score.pesertaId; if (!progressMap.has(participantId)) progressMap.set(participantId, new Set()); progressMap.get(participantId).add(score.stationId); });
    let selesaiCount = 0, sedangCount = 0, belumCount = peserta.length;
    peserta.forEach(p => { const completedStationsSet = progressMap.get(p.id); const stationCount = completedStationsSet ? completedStationsSet.size : 0; if (stationCount >= REQUIRED_STATIONS_FOR_COMPLETION) selesaiCount++; else if (stationCount > 0) sedangCount++; });
    belumCount = peserta.length - selesaiCount - sedangCount;
    document.getElementById('peserta-selesai').innerText = selesaiCount;
    document.getElementById('peserta-sedang').innerText = sedangCount;
    document.getElementById('peserta-belum').innerText = belumCount;
    updateStatusUjianChart(selesaiCount, sedangCount, belumCount);
    updatePenilaianPerStationChart(stations, scores);
}
function updateLiveMonitor() {
    const container = document.getElementById('live-monitor-stations');
    const fullSchedule = calculateFullSchedule();
    const allScores = getFromStorage('scores');
    const allPenguji = getFromStorage('penguji');
    if (fullSchedule.length === 0) { container.innerHTML = `<div class="col-12 text-center text-muted p-5"><i class="fas fa-calendar-times fa-3x mb-3"></i><p>Jadwal ujian belum dibuat. Silakan generate jadwal terlebih dahulu.</p></div>`; return; }
    const now = new Date();
    let currentRotation = fullSchedule.find(item => { const startTime = timeToDate(item.waktuMulai, item.date); const endTime = timeToDate(item.waktuSelesai, item.date); return now >= startTime && now < endTime; });
    if (!currentRotation) currentRotation = fullSchedule.find(item => timeToDate(item.waktuMulai, item.date) > now);
    if (!currentRotation) { container.innerHTML = `<div class="col-12 text-center text-muted p-5"><i class="fas fa-coffee fa-3x mb-3"></i><p>Ujian telah selesai untuk hari ini atau tidak ada jadwal mendatang.</p></div>`; return; }
    const currentRotationItems = fullSchedule.filter(item => item.date.toISOString().slice(0, 10) === currentRotation.date.toISOString().slice(0, 10) && item.rotasi === currentRotation.rotasi && item.sesi === currentRotation.sesi);
    container.innerHTML = '';
    currentRotationItems.sort((a,b) => a.station.name.localeCompare(b.station.name)).forEach(item => {
        const { station, peserta } = item;
        const penguji = allPenguji.find(p => p.assignedStationId === station.id);
        const startTime = timeToDate(item.waktuMulai, item.date);
        const endTime = timeToDate(item.waktuSelesai, item.date);
        let status, statusClass, countdownHtml = '';
        const scoreExists = allScores.some(s => s.pesertaId === peserta.id && s.stationId === station.id);
        if (scoreExists) { status = 'Selesai Dinilai'; statusClass = 'bg-success'; } else if (now >= startTime && now < endTime) { status = 'Berlangsung'; statusClass = 'bg-primary'; const remainingSeconds = Math.round((endTime - now) / 1000); const mins = Math.floor(remainingSeconds / 60); const secs = remainingSeconds % 60; countdownHtml = `<div class="countdown text-primary">${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}</div>`; } else if (now >= endTime) { status = 'Waktu Habis'; statusClass = 'bg-danger'; } else { status = `Menunggu (${item.waktuMulai})`; statusClass = 'bg-secondary'; }
        const cardHtml = `<div class="col-xl-3 col-lg-4 col-md-6"><div class="card live-monitor-card h-100 shadow-sm"><div class="card-header fw-bold d-flex justify-content-between"><span><i class="fas fa-sitemap me-2"></i>${station.name}</span><span class="badge ${statusClass}">${status}</span></div><div class="card-body">${countdownHtml}<p class="mb-1"><i class="fas fa-user-graduate fa-fw me-2 text-muted"></i><strong>${peserta.nama}</strong></p><p class="text-muted small mb-2"><i class="far fa-id-card fa-fw me-2"></i>${peserta.nim}</p><p class="mb-0"><i class="fas fa-user-tie fa-fw me-2 text-muted"></i>${penguji ? penguji.nama : '<i>Penguji belum ditugaskan</i>'}</p></div></div></div>`;
        container.innerHTML += cardHtml;
    });
}
function updateStatusUjianChart(selesai, sedang, belum) { const ctx = document.getElementById('statusUjianChart').getContext('2d'); if (statusUjianChartInstance) statusUjianChartInstance.destroy(); statusUjianChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Selesai (>=9 Station)', 'Sedang', 'Belum'], datasets: [{ data: [selesai, sedang, belum], backgroundColor: ['rgba(25, 135, 84, 0.8)', 'rgba(255, 193, 7, 0.8)', 'rgba(220, 53, 69, 0.8)'], borderColor: ['#198754', '#ffc107', '#dc3545'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } }); }
function updatePenilaianPerStationChart(stations, scores) { const ctx = document.getElementById('penilaianPerStationChart').getContext('2d'); const scoreCounts = scores.reduce((acc, score) => { acc[score.stationId] = (acc[score.stationId] || 0) + 1; return acc; }, {}); const labels = stations.map(s => s.name); const data = stations.map(s => scoreCounts[s.id] || 0); if (penilaianPerStationChartInstance) penilaianPerStationChartInstance.destroy(); penilaianPerStationChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Jml Penilaian', data: data, backgroundColor: 'rgba(217, 70, 137, 0.6)', borderColor: 'rgba(217, 70, 137, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } }); }

// =================================================================
// PENILAIAN (REVISED FOR SMART ASSESSMENT)
// =================================================================
function updatePesertaDropdown(searchTerm = '') { const term = searchTerm.toLowerCase(); const selectPeserta = document.getElementById('select-peserta'); const allPeserta = getFromStorage('peserta'); const currentlySelected = selectPeserta.value; const sourcePeserta = allPeserta; const filteredPeserta = sourcePeserta.filter(p => term ? (p.nama.toLowerCase().includes(term) || p.nim.toLowerCase().includes(term)) : true); if (filteredPeserta.length > 0) { selectPeserta.innerHTML = '<option value="">-- Pilih Peserta --</option>'; filteredPeserta.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(p => { const option = document.createElement('option'); option.value = p.id; const sesiInfo = p.sesi ? ` (Sesi ${p.sesi})` : ''; option.textContent = `${p.nama} (${p.nim})${sesiInfo}`; selectPeserta.appendChild(option); }); } else { selectPeserta.innerHTML = `<option value="">Tidak ada peserta yang ditemukan.</option>`; } if (filteredPeserta.some(p => p.id == currentlySelected)) { selectPeserta.value = currentlySelected; } }
function findCurrentScheduleForPenguji(pengujiId) {
    const penguji = getFromStorage('penguji').find(p => p.id === pengujiId);
    if (!penguji || !penguji.assignedStationId) return null;
    const fullSchedule = calculateFullSchedule();
    const now = new Date();
    const currentScheduleEntry = fullSchedule.find(item => { const startTime = timeToDate(item.waktuMulai, item.date); const endTime = timeToDate(item.waktuSelesai, item.date); return item.station.id === penguji.assignedStationId && now >= startTime && now < endTime; });
    return currentScheduleEntry || null;
}
function populatePenilaianDropdowns() {
    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    const selectPenguji = document.getElementById('select-penguji');
    const selectStation = document.getElementById('select-station');
    const autoParticipantContainer = document.getElementById('auto-participant-info');
    const manualSelectionContainer = document.getElementById('manual-peserta-selection');
    autoParticipantContainer.innerHTML = ''; autoParticipantContainer.classList.add('d-none');
    const stations = getFromStorage('stations');
    selectStation.innerHTML = `<option value="">-- Pilih Station --</option>`;
    stations.forEach(item => selectStation.innerHTML += `<option value="${item.id}">${item.name}</option>`);
    const allPenguji = getFromStorage('penguji');
    selectPenguji.innerHTML = `<option value="">-- Pilih Penguji --</option>`;
    allPenguji.forEach(item => selectPenguji.innerHTML += `<option value="${item.id}">${item.nama}</option>`);
    document.getElementById('search-peserta').value = '';
    updatePesertaDropdown();
    if (user.role === 'penguji') {
        selectPenguji.value = user.id; selectPenguji.disabled = true;
        selectStation.value = user.assignedStationId || ""; selectStation.disabled = true;
        manualSelectionContainer.classList.add('d-none');
        const currentSchedule = findCurrentScheduleForPenguji(user.id);
        if (currentSchedule && currentSchedule.peserta) {
            const p = currentSchedule.peserta;
            autoParticipantContainer.innerHTML = `<div class="alert alert-success"><h5 class="alert-heading"><i class="fas fa-user-clock me-2"></i>Peserta Sesuai Jadwal</h5><p class="mb-1"><strong>Nama:</strong> ${p.nama}</p><p class="mb-0"><strong>NIM:</strong> ${p.nim}</p><hr><button class="btn btn-sm btn-outline-secondary" onclick="showManualSelection()">Nilai Peserta Lain (Manual)</button></div>`;
            autoParticipantContainer.classList.remove('d-none');
            document.getElementById('select-peserta').value = p.id;
        } else {
             autoParticipantContainer.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>Saat ini tidak ada peserta yang dijadwalkan di stasiun Anda. Silakan pilih peserta secara manual di bawah ini.</div>`;
            autoParticipantContainer.classList.remove('d-none');
            manualSelectionContainer.classList.remove('d-none');
        }
    } else {
        selectPenguji.disabled = false; selectStation.disabled = false;
        manualSelectionContainer.classList.remove('d-none');
    }
    displayRubricPreview(); generateRubricForm();
}
function showManualSelection() { document.getElementById('manual-peserta-selection').classList.remove('d-none'); document.getElementById('auto-participant-info').classList.add('d-none'); }
function displayRubricPreview() {
    const stationId = document.getElementById('select-station').value;
    const soalContainer = document.getElementById('station-soal-display');
    const previewContainer = document.getElementById('rubric-preview-container');
    soalContainer.innerHTML = ''; previewContainer.innerHTML = '';
    if (!stationId) return; const station = getFromStorage('stations').find(s => s.id == stationId); if (!station) return;
    if (station.soal) { soalContainer.innerHTML = `<div class="card border-primary mb-3"><div class="card-header bg-primary text-white"><i class="fas fa-file-alt me-2"></i> <strong>Soal / Skenario untuk Station: ${station.name}</strong></div><div class="card-body" style="white-space: pre-wrap; background-color: #f8f9fa; max-height: 250px; overflow-y: auto;">${station.soal}</div></div>`; }
    const rubricList = station.rubric.map((r, index) => `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${index + 1}. ${r.criteria}</span><div><span class="badge bg-secondary rounded-pill me-2">Skor Maks: ${r.maxScore}</span><span class="badge bg-info rounded-pill">Bobot: ${r.bobot || 1}</span></div></li>`).join('');
    previewContainer.innerHTML = `<div class="accordion" id="rubricPreviewAccordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRubricPreview"><i class="fas fa-tasks me-2"></i> Tampilkan/Sembunyikan Rubrik Penilaian</button></h2><div id="collapseRubricPreview" class="accordion-collapse collapse" data-bs-parent="#rubricPreviewAccordion"><div class="accordion-body p-0"><ul class="list-group list-group-flush">${rubricList}</ul><div class="card-footer text-end"><button class="btn btn-sm btn-outline-primary" onclick="printRubric(${station.id})"><i class="fas fa-print"></i> Cetak Formulir Rubrik</button></div></div></div></div></div>`;
}
function generateRubricForm() {
    const pengujiId = document.getElementById('select-penguji').value; const pesertaId = document.getElementById('select-peserta').value; const stationId = document.getElementById('select-station').value;
    const formContainer = document.getElementById('form-penilaian-rubrik'); const timerContainer = document.getElementById('timer-container'); const scheduleInfoContainer = document.getElementById('schedule-time-info');
    if (stationTimer) clearInterval(stationTimer); timerContainer.classList.add('d-none'); scheduleInfoContainer.classList.add('d-none');
    if (!pengujiId || !pesertaId || !stationId) { formContainer.innerHTML = '<div class="text-center text-muted p-5"><i class="fas fa-mouse-pointer fa-3x mb-3"></i><p>Pilih Penguji, Peserta, dan Station untuk memulai.</p></div>'; return; }
    const station = getFromStorage('stations').find(s => s.id == stationId); if (!station) return;
    if (station.maxTime && station.maxTime > 0) startTimer(station.maxTime);
    const scheduledTime = getParticipantScheduleInfo(parseInt(pesertaId), parseInt(stationId)); if (scheduledTime) { const formattedDate = scheduledTime.date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); scheduleInfoContainer.innerHTML = `<i class="fas fa-calendar-day me-2"></i>Terjadwal pada <b>${formattedDate}</b>, pukul <b>${scheduledTime.startTime} - ${scheduledTime.endTime}</b>.`; scheduleInfoContainer.classList.remove('d-none'); }
    let formHtml = `<form id="form-submit-penilaian">`;
    station.rubric.forEach((r, index) => { formHtml += `<div class="rubric-item mb-3"><p class="mb-2"><b>${index + 1}. ${r.criteria}</b> (Maks: ${r.maxScore}, Bobot: ${r.bobot || 1})</p><div class="btn-group" role="group">`; for (let i = 0; i <= r.maxScore; i++) { formHtml += `<input type="radio" class="btn-check" name="score_${r.id}" id="score_${r.id}_${i}" value="${i}" autocomplete="off" required><label class="btn btn-outline-primary" for="score_${r.id}_${i}">${i}</label>`; } formHtml += `</div></div>`; });
    formHtml += `<hr class="my-4"><div class="card border-info"><div class="card-header bg-info-subtle"><h6 class="mb-0"><i class="fas fa-globe-asia"></i> Global Performance Rating</h6></div><div class="card-body"><p class="card-text"><small>Beri tanda (‚úì) pada kolom yang disediakan sesuai dengan penilaian Anda secara umum terhadap kemampuan Peserta Ujian.</small></p><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="global_performance" id="gp_1" value="1" required><label class="btn btn-outline-danger" for="gp_1">Tidak Lulus (1)</label><input type="radio" class="btn-check" name="global_performance" id="gp_2" value="2" required><label class="btn btn-outline-warning" for="gp_2">Borderline (2)</label><input type="radio" class="btn-check" name="global_performance" id="gp_3" value="3" required><label class="btn btn-outline-success" for="gp_3">Lulus (3)</label><input type="radio" class="btn-check" name="global_performance" id="gp_4" value="4" required><label class="btn btn-outline-primary" for="gp_4">Superior (4)</label></div></div></div>`;
    formHtml += `<div class="mt-4"><label for="komentar" class="form-label fw-bold">Komentar</label><textarea id="komentar" class="form-control" rows="3"></textarea></div><button type="submit" class="btn btn-success mt-4 w-100 fs-5"><i class="fas fa-save"></i> Simpan Penilaian</button></form>`;
    formContainer.innerHTML = formHtml;
    document.getElementById('form-submit-penilaian').addEventListener('submit', saveScore);
}
function getParticipantScheduleInfo(pesertaId, stationId) { const fullSchedule = calculateFullSchedule(); const scheduleEntry = fullSchedule.find(item => item.peserta.id === pesertaId && item.station.id === stationId); if (scheduleEntry) { return { startTime: scheduleEntry.waktuMulai, endTime: scheduleEntry.waktuSelesai, date: scheduleEntry.date }; } return null; }
function startTimer(minutes) { const timerContainer = document.getElementById('timer-container'); const timerDisplay = document.getElementById('timer-display'); const timerProgress = document.getElementById('timer-progress'); const timerStatus = document.getElementById('timer-status'); timerContainer.classList.remove('d-none'); const totalSeconds = minutes * 60; let remainingSeconds = totalSeconds; stationTimer = setInterval(() => { remainingSeconds--; const mins = Math.floor(remainingSeconds / 60); const secs = remainingSeconds % 60; timerDisplay.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; const percentage = (remainingSeconds / totalSeconds) * 100; timerProgress.style.width = `${percentage}%`; timerProgress.classList.remove('bg-warning', 'bg-danger'); timerDisplay.classList.remove('timer-warning', 'timer-danger'); timerStatus.classList.add('d-none'); if (remainingSeconds <= 0) { clearInterval(stationTimer); timerDisplay.textContent = "00:00"; timerProgress.style.width = '100%'; timerProgress.classList.add('bg-danger'); timerDisplay.classList.add('timer-danger'); timerStatus.textContent = "WAKTU HABIS!"; timerStatus.classList.remove('d-none'); timerStatus.classList.add('timer-danger'); } else if (remainingSeconds <= 60) { timerProgress.classList.add('bg-warning'); timerDisplay.classList.add('timer-warning'); timerStatus.textContent = "Waktu Hampir Habis"; timerStatus.classList.remove('d-none'); timerStatus.classList.add('timer-warning'); } }, 1000); }
async function saveScore(e) { e.preventDefault(); const form = e.target; const saveButton = form.querySelector('button[type="submit"]'); const originalButtonHTML = saveButton.innerHTML; saveButton.disabled = true; saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...`; const pengujiId = document.getElementById('select-penguji').value; const pesertaId = document.getElementById('select-peserta').value; const stationId = document.getElementById('select-station').value; const station = getFromStorage('stations').find(s => s.id == stationId); let scoresData = []; station.rubric.forEach(r => { const checkedRadio = form.querySelector(`input[name="score_${r.id}"]:checked`); if (checkedRadio) scoresData.push({ rubricId: r.id, score: parseInt(checkedRadio.value) }); }); if (scoresData.length !== station.rubric.length) { alert("Harap isi semua kriteria!"); saveButton.disabled = false; saveButton.innerHTML = originalButtonHTML; return; } const globalPerformanceRadio = form.querySelector('input[name="global_performance"]:checked'); if (!globalPerformanceRadio) { alert("Harap pilih Global Performance Rating!"); saveButton.disabled = false; saveButton.innerHTML = originalButtonHTML; return; } let allScores = getFromStorage('scores'); const existingScoreIndex = allScores.findIndex(s => s.pesertaId == pesertaId && s.stationId == stationId && s.pengujiId == pengujiId); if (existingScoreIndex > -1) { if (!confirm("Anda sudah pernah menilai peserta ini di station ini. Timpa data?")) { saveButton.disabled = false; saveButton.innerHTML = originalButtonHTML; return; } allScores.splice(existingScoreIndex, 1); } const newScore = { id: Date.now(), pengujiId: parseInt(pengujiId), pesertaId: parseInt(pesertaId), stationId: parseInt(stationId), scores: scoresData, komentar: document.getElementById('komentar').value, globalPerformance: parseInt(globalPerformanceRadio.value) }; allScores.push(newScore); saveToStorage('scores', allScores); logActivity('SUBMIT_SCORE', `PesertaID: ${pesertaId}, StationID: ${stationId}`); if (stationTimer) clearInterval(stationTimer); const user = JSON.parse(sessionStorage.getItem('osce_user')); if (user && user.role === 'penguji') { saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mengirim ke server...`; try { const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ type: 'add_single_score', payload: newScore }) }); if (!response.ok) throw new Error(`Server merespons dengan status ${response.status}`); const result = await response.json(); if (result.status !== 'success') throw new Error(result.message || 'Server mengembalikan error.'); saveButton.classList.replace('btn-success', 'btn-primary'); saveButton.innerHTML = `<i class="fas fa-check-circle"></i> Terkirim!`; } catch (error) { console.error("Gagal mengirim skor tunggal:", error); saveButton.classList.replace('btn-success', 'btn-warning'); saveButton.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Gagal Kirim`; alert("Penilaian berhasil disimpan di perangkat ini, tetapi GAGAL dikirim ke server. Cek koneksi internet Anda dan gunakan tombol 'Kirim Nilai' di navigasi untuk mengirim semua nilai nanti."); } } else { saveButton.innerHTML = `<i class="fas fa-check-circle"></i> Disimpan!`; alert("Penilaian berhasil disimpan!"); } setTimeout(() => { document.getElementById('select-peserta').value = ""; populatePenilaianDropdowns(); }, 2500); }

// =================================================================
// HASIL & LAPORAN
// =================================================================
function loadScores() {
    const scores = getFromStorage('scores'); const peserta = getFromStorage('peserta'); const penguji = getFromStorage('penguji'); const stations = getFromStorage('stations');
    const tableBody = document.getElementById('table-hasil-body'); tableBody.innerHTML = "";
    const scoresByPeserta = scores.reduce((acc, score) => { if (!acc[score.pesertaId]) acc[score.pesertaId] = []; acc[score.pesertaId].push(score); return acc; }, {});
    Object.keys(scoresByPeserta).forEach(pesertaId => {
        const p = peserta.find(p => p.id == pesertaId); if (!p) return;
        const participantScores = scoresByPeserta[pesertaId];
        const lastScore = participantScores.sort((a,b) => b.id - a.id)[0];
        const u = penguji.find(u => u.id === lastScore.pengujiId); const s = stations.find(s => s.id === lastScore.stationId);
        if (!u || !s) return;
        const { achieved, max, percentage } = calculateWeightedScore(lastScore, s);
        const otherStationsCount = participantScores.length - 1;
        const stationDisplayName = otherStationsCount > 0 ? `${s.name} (+${otherStationsCount} lainnya)` : s.name;
        tableBody.innerHTML += `<tr><td>${p.nim}</td><td>${p.nama}</td><td>${stationDisplayName}</td><td>${u.nama}</td><td><div class="progress" role="progressbar" style="height:22px;font-size:0.8rem;"><div class="progress-bar fw-bold" style="width:${percentage.toFixed(1)}%;" aria-valuenow="${achieved}" aria-valuemin="0" aria-valuemax="${max}">${achieved}/${max} (${percentage.toFixed(1)}%)</div></div></td><td class="text-center"><button class="btn btn-sm btn-info me-2" onclick="showParticipantDetails(${p.id})" title="Lihat Detail Nilai"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-danger" onclick="deleteAllScoresForParticipant(${p.id})" title="Hapus Semua Nilai Peserta Ini"><i class="fas fa-trash-alt"></i></button></td></tr>`;
    });
    if (tableBody.innerHTML === "") tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted p-4">Belum ada data penilaian.</td></tr>`;
}
function deleteAllScoresForParticipant(pesertaId) {
    if (!confirm("Anda yakin ingin menghapus SEMUA data nilai untuk peserta ini? Tindakan ini tidak dapat diurungkan.")) return;
    let scores = getFromStorage('scores');
    scores = scores.filter(s => s.pesertaId !== parseInt(pesertaId));
    saveToStorage('scores', scores);
    logActivity('DELETE_ALL_SCORES_FOR_PARTICIPANT', `PesertaID: ${pesertaId}`);
    loadScores(); loadCollectiveResults(); renderStationAnalyticsChart(); renderRubricPerformanceChart(); renderRubricDifficultyChart(); renderSessionComparisonChart(); renderScoreVsGprChart(); loadRemedialRecommendations(); displayStationRankings();
}
function updateCollectivePassingGrade() { 
    const grade = document.getElementById('collective-passing-grade').value; 
    if (grade === '' || grade < 0 || grade > 100) return alert("Batas lulus tidak valid. Masukkan angka antara 0 dan 100."); 
    const numericGrade = parseInt(grade);
    saveToStorage('osce_collective_passing_grade', numericGrade); 
    alert(`Batas lulus kolektif berhasil diubah menjadi ${numericGrade}%. Tabel akan dimuat ulang.`); 
    loadCollectiveResults(); 
}
function handleExcludeStationChange(event) { if (event.target.type !== 'checkbox') return; const container = document.getElementById('station-checkbox-container'); const checkedCheckboxes = container.querySelectorAll('input[type="checkbox"]:checked'); const newExcludedIds = Array.from(checkedCheckboxes).map(cb => parseInt(cb.value)); saveToStorage('osce_excluded_stations', newExcludedIds); loadCollectiveResults(); }
function loadCollectiveResults(gprDefault = null) {
    let savedPassingGrade = getFromStorage('osce_collective_passing_grade');
    let collectivePassingGrade;

    if (savedPassingGrade !== null && typeof savedPassingGrade !== 'undefined') {
        collectivePassingGrade = savedPassingGrade;
    } else {
        const defaultGrade = (gprDefault !== null && !isNaN(gprDefault)) ? Math.round(gprDefault) : 75;
        collectivePassingGrade = defaultGrade;
        saveToStorage('osce_collective_passing_grade', collectivePassingGrade);
    }
    document.getElementById('collective-passing-grade').value = collectivePassingGrade;

    const peserta = getFromStorage('peserta'); const scores = getFromStorage('scores'); const stations = getFromStorage('stations');
    const tableBody = document.getElementById('table-collective-hasil-body'); tableBody.innerHTML = "";
    const excludedStationIds = getFromStorage('osce_excluded_stations') || [];
    const checkboxContainer = document.getElementById('station-checkbox-container');
    const displayContainer = document.getElementById('excluded-stations-display');
    checkboxContainer.innerHTML = '';
    stations.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => { const isChecked = excludedStationIds.includes(s.id); checkboxContainer.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${s.id}" id="exclude-station-${s.id}" ${isChecked ? 'checked' : ''}><label class="form-check-label small" for="exclude-station-${s.id}">${s.name}</label></div>`; });
    const excludedStationNames = stations.filter(s => excludedStationIds.includes(s.id)).map(s => s.name);
    displayContainer.textContent = excludedStationNames.length > 0 ? excludedStationNames.join(', ') : 'Tidak ada';
    let participantAverages = []; let passCount = 0; let failCount = 0;
    peserta.forEach(p => {
        const participantScores = scores.filter(s => s.pesertaId === p.id);
        const validScores = participantScores.filter(s => !excludedStationIds.includes(s.stationId));
        if (validScores.length === 0) return;
        let totalPercentageSum = 0;
        validScores.forEach(score => { const station = stations.find(s => s.id === score.stationId); if (station) { const { percentage } = calculateWeightedScore(score, station); totalPercentageSum += percentage; } });
        const averageScore = totalPercentageSum / validScores.length;
        participantAverages.push(averageScore);
        const isPassed = averageScore >= collectivePassingGrade;
        if (isPassed) passCount++; else failCount++;
        const statusLulus = isPassed ? '<span class="badge bg-success fs-6">Lulus</span>' : '<span class="badge bg-danger fs-6">Tidak Lulus</span>';
        tableBody.innerHTML += `<tr><td>${p.nim}</td><td><strong>${p.nama}</strong></td><td class="text-center">${validScores.length}</td><td class="text-center"><div class="progress" role="progressbar" style="height:22px;font-size:0.9rem;"><div class="progress-bar ${isPassed ? 'bg-success' : 'bg-danger'}" style="width:${averageScore.toFixed(1)}%;" aria-valuenow="${averageScore.toFixed(1)}" aria-valuemin="0" aria-valuemax="100">${averageScore.toFixed(2)}%</div></div></td><td class="text-center">${statusLulus}</td></tr>`;
    });
    if (tableBody.innerHTML === "") tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted p-4">Belum ada data nilai valid untuk ditampilkan.</td></tr>`;
    const cohortAverageScoreEl = document.getElementById('cohort-average-score'); const cohortPassCountEl = document.getElementById('cohort-pass-count'); const cohortFailCountEl = document.getElementById('cohort-fail-count');
    if (participantAverages.length > 0) { const totalCohortScore = participantAverages.reduce((sum, avg) => sum + avg, 0); const cohortAverage = totalCohortScore / participantAverages.length; cohortAverageScoreEl.innerHTML = `${cohortAverage.toFixed(2)}<small>%</small>`; cohortPassCountEl.innerText = passCount; cohortFailCountEl.innerText = failCount; } else { cohortAverageScoreEl.innerText = 'N/A'; cohortPassCountEl.innerText = 'N/A'; cohortFailCountEl.innerText = 'N/A'; }
}
function exportCollectiveResultsToCSV() {
    const collectivePassingGrade = getFromStorage('osce_collective_passing_grade') || 75;
    const peserta = getFromStorage('peserta'); const scores = getFromStorage('scores'); const stations = getFromStorage('stations');
    const excludedStationIds = getFromStorage('osce_excluded_stations') || [];
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "NIM,Nama Peserta,Jumlah Station Dikerjakan (Valid),Rata-Rata Nilai (%),Status Kelulusan\n";
    peserta.forEach(p => {
        const participantScores = scores.filter(s => s.pesertaId === p.id);
        const validScores = participantScores.filter(s => !excludedStationIds.includes(s.stationId));
        if (validScores.length > 0) {
            let totalPercentageSum = 0;
            validScores.forEach(score => { const station = stations.find(s => s.id === score.stationId); if (station) { const { percentage } = calculateWeightedScore(score, station); totalPercentageSum += percentage; } });
            const averageScore = totalPercentageSum / validScores.length;
            const statusLulus = averageScore >= collectivePassingGrade ? "Lulus" : "Tidak Lulus";
            const row = [ p.nim, `"${p.nama}"`, validScores.length, averageScore.toFixed(2), statusLulus ].join(",");
            csvContent += row + "\n";
        }
    });
    if (csvContent.split('\n').length <= 2) return alert("Tidak ada data hasil kolektif untuk diekspor.");
    const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `hasil_kolektif_osce_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
function displayStationRankings() {
    const stations = getFromStorage('stations'); const scores = getFromStorage('scores'); const peserta = getFromStorage('peserta');
    const container = document.getElementById('station-ranking-container'); container.innerHTML = '';
    if (scores.length === 0) { container.innerHTML = '<div class="col-12 text-center text-muted p-4"><p>Belum ada data penilaian untuk ditampilkan.</p></div>'; return; }
    stations.forEach(station => {
        const stationScores = scores.filter(sc => sc.stationId === station.id); if (stationScores.length === 0) return;
        const scoresByPeserta = stationScores.map(sc => { const p = peserta.find(p => p.id === sc.pesertaId); const { achieved } = calculateWeightedScore(sc, station); return { nama: p ? p.nama : 'Peserta Dihapus', totalScore: achieved }; });
        scoresByPeserta.sort((a, b) => b.totalScore - a.totalScore);
        const maxScoreValue = scoresByPeserta.length > 0 ? scoresByPeserta[0].totalScore : 0;
        const topScorers = scoresByPeserta.filter(p => p.totalScore === maxScoreValue && p.totalScore > 0);
        const topScorersHtml = topScorers.length > 0 ? topScorers.map(ts => `<li class="list-group-item">${ts.nama}</li>`).join('') : '<li class="list-group-item text-muted">Belum ada</li>';
        const cardHtml = `<div class="col-md-6 col-lg-4 mb-4"><div class="card h-100"><div class="card-header bg-light"><i class="fas fa-sitemap"></i> ${station.name}</div><div class="card-body text-center"><h6 class="card-subtitle mb-2 text-muted">Nilai Tertinggi (berbobot)</h6><p class="card-text fs-1 fw-bold text-primary">${maxScoreValue}</p><h6 class="card-subtitle mb-2 text-muted">Diraih oleh:</h6></div><ul class="list-group list-group-flush text-center">${topScorersHtml}</ul></div></div>`;
        container.innerHTML += cardHtml;
    });
    if (container.innerHTML === '') container.innerHTML = '<div class="col-12 text-center text-muted p-4"><p>Belum ada data penilaian untuk ditampilkan.</p></div>';
}

// =================================================================
// BORDERLINE REGRESSION METHOD (BRM) & FEEDBACK
// =================================================================
function linearRegression(data) { if (!data || data.length < 2) return null; let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0; const n = data.length; data.forEach(([x, y]) => { sumX += x; sumY += y; sumXY += x * y; sumXX += x * x; }); const denominator = (n * sumXX - sumX * sumX); if (denominator === 0) return null; const slope = (n * sumXY - sumX * sumY) / denominator; const intercept = (sumY - slope * sumX) / n; return { slope, intercept }; }
function calculateBrmPassingScores() { const stations = getFromStorage('stations'); const scores = getFromStorage('scores'); const brmScores = {}; stations.forEach(station => { const stationScoresData = scores.filter(s => s.stationId === station.id && s.globalPerformance).map(s => { const { percentage } = calculateWeightedScore(s, station); return [s.globalPerformance, percentage]; }); const regression = linearRegression(stationScoresData); if (regression) { const brmPassingScore = regression.intercept + regression.slope * 2.0; brmScores[station.id] = Math.max(0, Math.min(100, brmPassingScore)); } else { brmScores[station.id] = station.passingGrade || 75; } }); return brmScores; }
function generateParticipantFeedback(pesertaId) {
    const participantScores = getFromStorage('scores').filter(s => s.pesertaId === pesertaId);
    if (participantScores.length === 0) return { weakStations: [], recommendations: [] };
    const stations = getFromStorage('stations'); const brmPassingScores = calculateBrmPassingScores();
    const weakStations = []; const recommendationSet = new Set();
    const recommendationMap = { 'komunikasi|empati|rapport|bercakap': 'Tingkatkan kemampuan komunikasi interpersonal dan empati terhadap pasien.', 'prosedur|teknik|aseptik|steril|langkah': 'Perhatikan kembali langkah-langkah prosedur dan teknik aseptik untuk memastikan keamanan dan efektivitas.', 'anamnesis|pemeriksaan|diagnosis|fisik': 'Perdalam kemampuan dalam melakukan anamnesis yang terstruktur dan pemeriksaan fisik yang akurat.', 'edukasi|konseling|informasi|penjelasan': 'Fokus pada cara memberikan edukasi dan informasi yang jelas dan mudah dipahami oleh pasien.', 'manajemen|tatalaksana|terapi|rencana': 'Tingkatkan kemampuan dalam merencanakan dan mengelola tatalaksana pasien secara komprehensif.' };
    const recommendationKeys = Object.keys(recommendationMap);
    participantScores.forEach(score => {
        const station = stations.find(s => s.id === score.stationId); if (!station) return;
        const { percentage } = calculateWeightedScore(score, station);
        const passingScore = brmPassingScores[station.id] || station.passingGrade || 75;
        if (percentage < passingScore) {
            weakStations.push(station.name);
            score.scores.forEach(item => {
                const rubric = station.rubric.find(r => r.id === item.rubricId);
                if (rubric && rubric.maxScore > 0) {
                    const itemPercentage = (item.score / rubric.maxScore) * 100;
                    if (itemPercentage < 60) {
                        const criteriaText = rubric.criteria.toLowerCase();
                        for (const key of recommendationKeys) { if (new RegExp(key).test(criteriaText)) { recommendationSet.add(recommendationMap[key]); break; } }
                    }
                }
            });
        }
    });
    return { weakStations, recommendations: Array.from(recommendationSet) };
}


// =================================================================
// REVISED ANALYTICS & REPORTING FUNCTIONS
// =================================================================
function renderStationAnalyticsChart() {
    const stations = getFromStorage('stations'); const scores = getFromStorage('scores'); const chartCanvas = document.getElementById('station-analytics-chart'); const fallbackMessage = document.getElementById('station-analytics-fallback');
    if (scores.length === 0 || stations.length === 0) { chartCanvas.classList.add('d-none'); fallbackMessage.classList.remove('d-none'); if (stationAnalyticsChartInstance) stationAnalyticsChartInstance.destroy(); return; }
    chartCanvas.classList.remove('d-none'); fallbackMessage.classList.add('d-none');
    const brmPassingScores = calculateBrmPassingScores();
    const analyticsData = stations.map(station => {
        const stationScores = scores.filter(s => s.stationId === station.id);
        if (stationScores.length === 0) return { name: station.name, avgScore: 0, passRate: 0, brm: brmPassingScores[station.id] || 0 };
        const passingGrade = station.passingGrade || 75; let totalPercentage = 0; let passedCount = 0;
        stationScores.forEach(score => { const { percentage } = calculateWeightedScore(score, station); totalPercentage += percentage; if (percentage >= passingGrade) passedCount++; });
        return { name: station.name, avgScore: totalPercentage / stationScores.length, passRate: (passedCount / stationScores.length) * 100, brm: brmPassingScores[station.id] || 0 };
    }).sort((a, b) => a.name.localeCompare(b.name));
    const ctx = chartCanvas.getContext('2d'); if (stationAnalyticsChartInstance) stationAnalyticsChartInstance.destroy();
    stationAnalyticsChartInstance = new Chart(ctx, { data: { labels: analyticsData.map(d => d.name), datasets: [{ type: 'bar', label: 'Rerata Nilai (%)', data: analyticsData.map(d => d.avgScore.toFixed(2)), backgroundColor: 'rgba(217, 70, 137, 0.7)', borderColor: 'rgba(217, 70, 137, 1)', order: 2, }, { type: 'line', label: 'Batas Lulus (BRM)', data: analyticsData.map(d => d.brm.toFixed(2)), backgroundColor: 'rgba(255, 99, 132, 1)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 3, pointRadius: 5, fill: false, order: 1, }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' }, title: { display: true, text: 'Persentase' } } }, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: context => { let label = context.dataset.label || ''; if (label) label += ': '; label += `${context.raw}%`; return label; } } } } } });
}
function renderRubricPerformanceChart() {
    const scores = getFromStorage('scores'); const stations = getFromStorage('stations'); const chartCanvas = document.getElementById('rubric-performance-chart'); const fallbackMessage = document.getElementById('rubric-performance-fallback');
    if (scores.length === 0 || stations.length === 0) { chartCanvas.classList.add('d-none'); fallbackMessage.classList.remove('d-none'); if (rubricPerformanceChartInstance) rubricPerformanceChartInstance.destroy(); return; }
    chartCanvas.classList.remove('d-none'); fallbackMessage.classList.add('d-none');
    const rubricStats = {};
    stations.forEach(s => { s.rubric.forEach(r => { const key = `${s.id}-${r.id}`; rubricStats[key] = { criteria: r.criteria, stationName: s.name, passed: 0, failed: 0, maxScore: r.maxScore, passingGrade: s.passingGrade || 75 }; }); });
    scores.forEach(score => {
        const station = stations.find(s => s.id === score.stationId); if (!station) return; const passingGrade = station.passingGrade || 75;
        score.scores.forEach(item => {
            const rubricItem = station.rubric.find(r => r.id === item.rubricId); if (!rubricItem) return;
            const key = `${station.id}-${item.rubricId}`;
            const percentage = rubricItem.maxScore > 0 ? (item.score / rubricItem.maxScore) * 100 : 0;
            if (percentage >= passingGrade) rubricStats[key].passed++; else rubricStats[key].failed++;
        });
    });
    const sortedRubrics = Object.values(rubricStats).filter(r => r.passed > 0 || r.failed > 0).sort((a,b) => (b.failed / (b.failed + b.passed)) - (a.failed / (a.failed + a.passed)));
    const labels = sortedRubrics.map(r => `${r.stationName.substring(0,10)}..: ${r.criteria.substring(0, 20)}..`);
    const passedData = sortedRubrics.map(r => r.passed); const failedData = sortedRubrics.map(r => r.failed);
    const ctx = chartCanvas.getContext('2d'); if (rubricPerformanceChartInstance) rubricPerformanceChartInstance.destroy();
    rubricPerformanceChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'Gagal', data: failedData, backgroundColor: 'rgba(220, 53, 69, 0.7)', }, { label: 'Lolos', data: passedData, backgroundColor: 'rgba(25, 135, 84, 0.7)', } ] }, options: { indexAxis: 'y', responsive: true, scales: { x: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }, y: { stacked: true } }, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function(context) { const label = context.dataset.label || ''; const value = context.raw; const total = context.chart.data.datasets.reduce((sum, ds) => sum + ds.data[context.dataIndex], 0); const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0; return `${label}: ${value} (${percentage}%)`; } } } } } });
}
function renderRubricDifficultyChart() {
    const scores = getFromStorage('scores'); const stations = getFromStorage('stations'); const chartCanvas = document.getElementById('rubric-difficulty-chart'); const fallbackMessage = document.getElementById('rubric-difficulty-fallback');
    if (scores.length === 0 || stations.length === 0) { chartCanvas.classList.add('d-none'); fallbackMessage.classList.remove('d-none'); if (rubricDifficultyChartInstance) rubricDifficultyChartInstance.destroy(); return; }
    chartCanvas.classList.remove('d-none'); fallbackMessage.classList.add('d-none');
    const rubricStats = {};
    scores.forEach(score => { const station = stations.find(s => s.id === score.stationId); if (!station) return; score.scores.forEach(item => { const rubricItem = station.rubric.find(r => r.id === item.rubricId); if (!rubricItem) return; const key = `${station.id}-${rubricItem.id}`; if (!rubricStats[key]) rubricStats[key] = { criteria: `${station.name}: ${rubricItem.criteria}`, totalScore: 0, totalMaxScore: 0, count: 0 }; rubricStats[key].totalScore += item.score; rubricStats[key].totalMaxScore += rubricItem.maxScore; rubricStats[key].count++; }); });
    const performanceData = Object.values(rubricStats).map(stat => ({ criteria: stat.criteria, avgPercentage: (stat.totalScore / stat.totalMaxScore) * 100 || 0 })).sort((a, b) => a.avgPercentage - b.avgPercentage).slice(0, 15);
    const ctx = chartCanvas.getContext('2d'); if (rubricDifficultyChartInstance) rubricDifficultyChartInstance.destroy();
    rubricDifficultyChartInstance = new Chart(ctx, { type: 'bar', data: { labels: performanceData.map(d => d.criteria), datasets: [{ label: 'Rata-rata Skor Kriteria (%)', data: performanceData.map(d => d.avgPercentage.toFixed(2)), backgroundColor: 'rgba(220, 53, 69, 0.7)', borderColor: 'rgba(220, 53, 69, 1)', borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => `Rata-rata: ${context.raw}%` } } } } });
}
function renderGlobalPerformanceAnalysis() {
    const scores = getFromStorage('scores'); const chartCanvas = document.getElementById('global-performance-chart'); const fallbackMessage = document.getElementById('global-performance-fallback');
    const avgDisplay = document.getElementById('avg-global-performance'); const avgDisplay100 = document.getElementById('avg-global-performance-100');
    const REQUIRED_STATIONS_FOR_ANALYSIS = 9;
    const scoresByPeserta = scores.reduce((acc, score) => { if (!acc[score.pesertaId]) acc[score.pesertaId] = []; acc[score.pesertaId].push(score); return acc; }, {});
    const completedPesertaScores = Object.values(scoresByPeserta).filter(pScores => pScores.length >= REQUIRED_STATIONS_FOR_ANALYSIS);
    if (completedPesertaScores.length === 0) { chartCanvas.classList.add('d-none'); fallbackMessage.classList.remove('d-none'); if(globalPerformanceChartInstance) globalPerformanceChartInstance.destroy(); avgDisplay.textContent = 'N/A'; avgDisplay100.textContent = 'N/A'; return null; }
    chartCanvas.classList.remove('d-none'); fallbackMessage.classList.add('d-none');
    let totalGlobalPerfSum = 0; const performanceCounts = { 1: 0, 2: 0, 3: 0, 4: 0 };
    completedPesertaScores.forEach(pScores => { const participantGlobalPerfSum = pScores.reduce((sum, score) => sum + (score.globalPerformance || 0), 0); const participantAvgPerf = participantGlobalPerfSum / pScores.length; totalGlobalPerfSum += participantAvgPerf; if (participantAvgPerf < 1.5) performanceCounts[1]++; else if (participantAvgPerf < 2.5) performanceCounts[2]++; else if (participantAvgPerf < 3.5) performanceCounts[3]++; else performanceCounts[4]++; });
    const overallAvg = totalGlobalPerfSum / completedPesertaScores.length; avgDisplay.textContent = overallAvg.toFixed(2);
    const overallAvg100 = (overallAvg / 4) * 100; avgDisplay100.textContent = overallAvg100.toFixed(2);
    const ctx = chartCanvas.getContext('2d'); if (globalPerformanceChartInstance) globalPerformanceChartInstance.destroy();
    globalPerformanceChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Tidak Lulus', 'Borderline', 'Lulus', 'Superior'], datasets: [{ label: 'Jumlah Peserta', data: [performanceCounts[1], performanceCounts[2], performanceCounts[3], performanceCounts[4]], backgroundColor: [ 'rgba(220, 53, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(25, 135, 84, 0.7)', 'rgba(217, 70, 137, 0.7)' ], borderColor: [ 'rgb(220, 53, 69)', 'rgb(255, 193, 7)', 'rgb(25, 135, 84)', 'rgb(217, 70, 137)' ], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Distribusi Global Performance Peserta (Selesai)' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
    return overallAvg100;
}
function renderSessionComparisonChart() {
    const chartCanvas = document.getElementById('session-comparison-chart'); const fallbackMessage = document.getElementById('session-comparison-fallback');
    const peserta = getFromStorage('peserta'); const scores = getFromStorage('scores'); const stations = getFromStorage('stations');
    const scheduledPeserta = peserta.filter(p => p.sesi);
    if (scheduledPeserta.length === 0 || scores.length === 0) { chartCanvas.classList.add('d-none'); fallbackMessage.classList.remove('d-none'); if (sessionComparisonChartInstance) sessionComparisonChartInstance.destroy(); return; }
    chartCanvas.classList.remove('d-none'); fallbackMessage.classList.add('d-none');
    const sessionData = {};
    scores.forEach(score => {
        const p = peserta.find(p => p.id === score.pesertaId); const station = stations.find(s => s.id === score.stationId); if (!p || !p.sesi || !station) return;
        if (!sessionData[p.sesi]) sessionData[p.sesi] = { totalPercent: 0, scoreCount: 0 };
        const { percentage } = calculateWeightedScore(score, station); sessionData[p.sesi].totalPercent += percentage; sessionData[p.sesi].scoreCount++;
    });
    const sortedSessions = Object.keys(sessionData).sort((a,b) => parseInt(a) - parseInt(b));
    const labels = sortedSessions.map(sesi => `Sesi ${sesi}`);
    const data = sortedSessions.map(sesi => { const { totalPercent, scoreCount } = sessionData[sesi]; return scoreCount > 0 ? (totalPercent / scoreCount).toFixed(2) : 0; });
    const ctx = chartCanvas.getContext('2d'); if (sessionComparisonChartInstance) sessionComparisonChartInstance.destroy();
    sessionComparisonChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Rata-rata Nilai Sesi (%)', data: data, backgroundColor: 'rgba(25, 135, 84, 0.7)', borderColor: 'rgba(25, 135, 84, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => `Rata-rata: ${context.raw}%` } } } } });
}
function renderScoreVsGprChart() {
    const scores = getFromStorage('scores'); const stations = getFromStorage('stations'); const peserta = getFromStorage('peserta');
    const excludedStationIds = getFromStorage('osce_excluded_stations') || [];
    const chartCanvas = document.getElementById('score-vs-gpr-chart'); const fallbackMessage = document.getElementById('score-vs-gpr-fallback');
    const REQUIRED_STATIONS_FOR_ANALYSIS = 9;
    const scoresByPeserta = scores.reduce((acc, score) => { if (!acc[score.pesertaId]) acc[score.pesertaId] = []; acc[score.pesertaId].push(score); return acc; }, {});
    const scatterData = [];
    for (const pesertaId in scoresByPeserta) {
        const p = peserta.find(p => p.id == pesertaId); if (!p) continue;
        const participantScores = scoresByPeserta[pesertaId];
        const analyzableScores = participantScores.filter(s => !excludedStationIds.includes(s.stationId) && s.globalPerformance );
        if (analyzableScores.length < REQUIRED_STATIONS_FOR_ANALYSIS) continue;
        let totalGpr = 0; analyzableScores.forEach(s => { totalGpr += s.globalPerformance; });
        const avgGpr = totalGpr / analyzableScores.length;
        let totalPercentageSum = 0;
        analyzableScores.forEach(score => { const station = stations.find(s => s.id === score.stationId); if (station) { const { percentage } = calculateWeightedScore(score, station); totalPercentageSum += percentage; } });
        const avgCollectiveScore = totalPercentageSum / analyzableScores.length;
        if (avgGpr > 0 && avgCollectiveScore > 0) scatterData.push({ x: avgGpr, y: avgCollectiveScore, label: p.nama });
    }
    if (scatterData.length < 2) { chartCanvas.classList.add('d-none'); fallbackMessage.classList.remove('d-none'); if (scoreVsGprChartInstance) scoreVsGprChartInstance.destroy(); return; }
    chartCanvas.classList.remove('d-none'); fallbackMessage.classList.add('d-none');
    const ctx = chartCanvas.getContext('2d'); if (scoreVsGprChartInstance) scoreVsGprChartInstance.destroy();
    scoreVsGprChartInstance = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Peserta', data: scatterData, backgroundColor: 'rgba(217, 70, 137, 0.6)' }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { const dataPoint = context.raw; return [ `Peserta: ${dataPoint.label}`, `Nilai Rata-rata: ${dataPoint.y.toFixed(2)}%`, `Rata-rata GPR: ${dataPoint.x.toFixed(2)}` ]; } } } }, scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Rata-Rata Global Performance Rating' }, min: 1, max: 4, ticks: { stepSize: 0.5 } }, y: { title: { display: true, text: 'Rata-Rata Nilai Kolektif (%)' }, min: 0, max: 100, ticks: { callback: value => value + '%' } } } } });
}
function loadRemedialRecommendations() {
    const tableBody = document.getElementById('table-remedial-body'); const peserta = getFromStorage('peserta'); const stations = getFromStorage('stations');
    const scores = getFromStorage('scores'); const brmPassingScores = calculateBrmPassingScores();
    tableBody.innerHTML = ''; const recommendations = {};
    scores.forEach(score => {
        const station = stations.find(s => s.id === score.stationId); if (!station) return;
        const { percentage } = calculateWeightedScore(score, station);
        const passingGrade = brmPassingScores[station.id] || station.passingGrade || 75;
        if (percentage < passingGrade) {
            if (!recommendations[score.pesertaId]) { const p = peserta.find(p => p.id === score.pesertaId); if (p) recommendations[score.pesertaId] = { nim: p.nim, nama: p.nama, stations: [] }; }
            if (recommendations[score.pesertaId]) recommendations[score.pesertaId].stations.push({ name: station.name, score: percentage.toFixed(2) });
        }
    });
    if (Object.keys(recommendations).length === 0) { tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-success p-4"><i class="fas fa-check-circle me-2"></i>Tidak ada peserta yang memerlukan remedial saat ini.</td></tr>`; return; }
    Object.values(recommendations).sort((a,b) => a.nama.localeCompare(b.nama)).forEach(rec => { const stationListHtml = rec.stations.map(s => `<span class="badge bg-danger me-1 mb-1">${s.name} (${s.score}%)</span>`).join(' '); tableBody.innerHTML += `<tr><td>${rec.nim}</td><td><strong>${rec.nama}</strong></td><td>${stationListHtml}</td></tr>`; });
}
function getStationAverages() {
    const scores = getFromStorage('scores'); const stations = getFromStorage('stations'); const stationAverages = {};
    scores.forEach(score => {
        const station = stations.find(s => s.id === score.stationId);
        if (station) { if (!stationAverages[station.id]) stationAverages[station.id] = { totalPercent: 0, count: 0 }; const { percentage } = calculateWeightedScore(score, station); stationAverages[station.id].totalPercent += percentage; stationAverages[station.id].count++; }
    });
    const finalAverages = {}; for (const stationId in stationAverages) finalAverages[stationId] = stationAverages[stationId].totalPercent / stationAverages[stationId].count;
    return finalAverages;
}
function showParticipantDetails(pesertaId) {
    const p = getFromStorage('peserta').find(item => item.id === pesertaId); if (!p) return;
    const allScores = getFromStorage('scores').filter(s => s.pesertaId === pesertaId);
    const stations = getFromStorage('stations'); const penguji = getFromStorage('penguji');
    const modalBody = document.getElementById('participantDetailModalBody');
    document.getElementById('participantDetailModalLabel').innerHTML = `<i class="fas fa-user-graduate"></i> Detail Hasil Peserta: <strong>${p.nama}</strong>`;
    const globalPerfMap = {1: 'Tidak Lulus', 2: 'Borderline', 3: 'Lulus', 4: 'Superior'};
    const stationAverages = getStationAverages();
    const { weakStations, recommendations } = generateParticipantFeedback(pesertaId);
    let feedbackHtml = '';
    if (allScores.length > 0) {
        feedbackHtml = `<div class="col-12 mt-4"><div class="card border-warning"><div class="card-header bg-warning-subtle"><i class="fas fa-lightbulb me-2"></i><strong>Feedback & Rekomendasi</strong></div><div class="card-body">`;
        if (weakStations.length === 0) { feedbackHtml += '<p class="text-success"><i class="fas fa-check-circle me-2"></i>Selamat! Performa Anda konsisten dan baik di semua stasiun yang telah dinilai.</p>'; } else { feedbackHtml += '<h6><i class="fas fa-bullseye text-danger me-2"></i>Station yang Perlu Ditingkatkan:</h6><ul class="list-group list-group-flush mb-3">'; weakStations.forEach(ws => { feedbackHtml += `<li class="list-group-item">${ws}</li>` }); feedbackHtml += '</ul>'; if (recommendations.length > 0) { feedbackHtml += '<h6><i class="fas fa-tasks text-primary me-2"></i>Rekomendasi Perbaikan:</h6><ul class="list-group list-group-flush">'; recommendations.forEach(rec => { feedbackHtml += `<li class="list-group-item">${rec}</li>` }); feedbackHtml += '</ul>'; } }
        feedbackHtml += '</div></div></div>';
    }
    let content = `<div class="row"><div class="col-md-4"><div class="card mb-3"><div class="card-body"><h5 class="card-title">${p.nama}</h5><p class="card-text text-muted">${p.nim}</p><hr><p><strong>Total Station Diikuti:</strong> ${allScores.length} / ${stations.length}</p></div></div></div><div class="col-md-8"><div class="card"><div class="card-header">Grafik Perbandingan Performa (%)</div><div class="card-body"><canvas id="participantProgressChart"></canvas></div></div></div>${feedbackHtml}</div><h4 class="mt-4">Rincian Nilai</h4><div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Station</th><th>Penguji</th><th>Skor (Berbobot)</th><th>Persentase</th><th>Global Perf.</th><th>Status</th><th>Komentar</th></tr></thead><tbody>`;
    const chartLabels = [], chartDataParticipant = [], chartDataCohort = [];
    const brmPassingScores = calculateBrmPassingScores();
    allScores.sort((a,b) => stations.findIndex(s=>s.id===a.stationId) - stations.findIndex(s=>s.id===b.stationId)).forEach(score => {
        const s = stations.find(st => st.id === score.stationId); const u = penguji.find(uj => uj.id === score.pengujiId); if (!s || !u) return;
        const { achieved, max, percentage } = calculateWeightedScore(score, s);
        const passingGrade = brmPassingScores[s.id] || s.passingGrade || 75;
        const statusLulus = percentage >= passingGrade ? '<span class="badge bg-success">Lulus</span>' : '<span class="badge bg-danger">Tidak Lulus</span>';
        const globalPerfText = score.globalPerformance ? `${globalPerfMap[score.globalPerformance]} (${score.globalPerformance})` : 'N/A';
        chartLabels.push(s.name); chartDataParticipant.push(percentage.toFixed(2)); chartDataCohort.push((stationAverages[s.id] || 0).toFixed(2));
        content += `<tr><td>${s.name}</td><td>${u.nama}</td><td>${achieved} / ${max}</td><td>${percentage.toFixed(2)}%</td><td>${globalPerfText}</td><td>${statusLulus}</td><td>${score.komentar || '-'}</td></tr>`;
    });
    if (allScores.length === 0) content += `<tr><td colspan="7" class="text-center text-muted">Belum ada data nilai untuk peserta ini.</td></tr>`;
    content += `</tbody></table></div>`; modalBody.innerHTML = content;
    document.getElementById('print-participant-result-btn').onclick = () => printParticipantResult(pesertaId);
    const ctx = document.getElementById('participantProgressChart').getContext('2d'); if(participantProgressChartInstance) participantProgressChartInstance.destroy();
    participantProgressChartInstance = new Chart(ctx, { type: 'radar', data: { labels: chartLabels, datasets: [{ label: 'Nilai Peserta', data: chartDataParticipant, backgroundColor: 'rgba(217, 70, 137, 0.2)', borderColor: 'rgba(217, 70, 137, 1)', borderWidth: 2 }, { label: 'Rata-rata Angkatan', data: chartDataCohort, backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }] }, options: { scales: { r: { beginAtZero: true, max: 100 } }, plugins: { legend: { position: 'top' } } } });
    participantDetailModal.show();
}
function printParticipantResult(pesertaId) {
    const p = getFromStorage('peserta').find(item => item.id === pesertaId); if (!p) return;
    const allScores = getFromStorage('scores').filter(s => s.pesertaId === pesertaId);
    const stations = getFromStorage('stations'); const penguji = getFromStorage('penguji');
    const globalPerfMap = {1: 'Tidak Lulus', 2: 'Borderline', 3: 'Lulus', 4: 'Superior'};
    const settings = getFromStorage('osce_cert_settings') || {};
    const institutionName = settings.institutionName || 'PROGRAM STUDI D3 KEBIDANAN';
    const brmPassingScores = calculateBrmPassingScores(); const { weakStations, recommendations } = generateParticipantFeedback(pesertaId);
    let feedbackHtml = '';
    if (allScores.length > 0) {
        feedbackHtml = `<h3>Feedback & Rekomendasi</h3>`;
        if (weakStations.length === 0) { feedbackHtml += '<p><strong>Selamat!</strong> Performa Anda konsisten dan baik di semua stasiun yang telah dinilai.</p>'; } else { feedbackHtml += '<p><strong>Station yang Perlu Ditingkatkan:</strong> ' + weakStations.join(', ') + '.</p>'; if (recommendations.length > 0) { feedbackHtml += '<p><strong>Rekomendasi Perbaikan:</strong></p><ul>'; recommendations.forEach(rec => { feedbackHtml += `<li>${rec}</li>`}); feedbackHtml += '</ul>'; } }
    }
    let totalPercentageSum = 0; let completedStations = 0; let detailRows = '';
    allScores.forEach(score => {
        const s = stations.find(st => st.id === score.stationId); const u = penguji.find(uj => uj.id === score.pengujiId); if (!s || !u) return;
        const { achieved, max, percentage } = calculateWeightedScore(score, s);
        const passingGrade = brmPassingScores[s.id] || s.passingGrade || 75;
        const statusLulus = percentage >= passingGrade ? "Lulus" : "Tidak Lulus";
        const globalPerfText = score.globalPerformance ? `${globalPerfMap[score.globalPerformance]} (${score.globalPerformance})` : 'N/A';
        totalPercentageSum += percentage; completedStations++;
        detailRows += `<tr><td>${s.name}</td><td>${achieved} / ${max}</td><td>${percentage.toFixed(2)}%</td><td>${globalPerfText}</td><td>${statusLulus}</td><td>${score.komentar || '-'}</td></tr>`;
    });
    const averageScore = completedStations > 0 ? (totalPercentageSum / completedStations).toFixed(2) : 0;
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Laporan Hasil Ujian - ${p.nama}</title><style>body{font-family:'Times New Roman',Times,serif;font-size:12pt;}.container{width:80%;margin:auto;}h1,h2,h3{text-align:center;}h1{font-size:16pt;margin-bottom:5px;}h2{font-size:14pt;font-weight:normal;margin-top:0;margin-bottom:20px;}h3{text-align:left;font-size:13pt;margin-top:1.5em;border-bottom:1px solid #ccc;padding-bottom:5px;}.info-table{width:100%;margin-bottom:20px;border:none;}.info-table td{padding:5px;border:none;}.results-table{width:100%;border-collapse:collapse;margin-top:1em;}.results-table th,.results-table td{border:1px solid black;padding:8px;text-align:left;}.results-table th{background-color:#f2f2f2;}ul{padding-left:20px;}@page{size:A4;margin:2cm;}</style></head><body><div class="container"><h1>LAPORAN HASIL UJIAN OSCE</h1><h2>${institutionName.toUpperCase()}</h2><hr><table class="info-table"><tr><td style="width:150px;"><strong>Nama Peserta</strong></td><td>: ${p.nama}</td></tr><tr><td><strong>NIM</strong></td><td>: ${p.nim}</td></tr><tr><td><strong>Nilai Rata-rata</strong></td><td>: <strong>${averageScore}%</strong></td></tr><tr><td><strong>Jumlah Station</strong></td><td>: ${completedStations} / ${stations.length}</td></tr></table><h3>Rincian Nilai per Station</h3><table class="results-table"><thead><tr><th>Nama Station</th><th>Skor (Berbobot)</th><th>Persentase</th><th>Global Perf.</th><th>Status</th><th>Komentar</th></tr></thead><tbody>${detailRows || `<tr><td colspan="6" style="text-align:center;">Belum ada data nilai.</td></tr>`}</tbody></table>${feedbackHtml}<div style="margin-top:50px;text-align:right;"><p>${settings.certCity || 'Kupang'}, ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p><br><br><br><p>(........................................)</p><p>Koordinator Ujian</p></div></div></body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}


// =================================================================
// CERTIFICATE MANAGEMENT
// =================================================================
const CERT_SETTINGS_KEY = 'osce_cert_settings';
function loadCertificateSettingsPage() {
    const settings = getFromStorage(CERT_SETTINGS_KEY) || {};
    document.getElementById('cert-institution-name').value = settings.institutionName || 'Program Studi D3 Kebidanan, Poltekkes Kemenkes Kupang';
    document.getElementById('cert-format').value = settings.certFormat || 'UN/KEP-WKB/X/2025';
    document.getElementById('cert-start-number').value = settings.startNumber || 1;
    document.getElementById('cert-exam-date').value = settings.examDate || '25 - 26 Oktober 2025';
    document.getElementById('cert-venue').value = settings.venue || 'Kampus Poltekkes Prodi Kebidanan';
    document.getElementById('cert-city').value = settings.certCity || 'Kupang';
    document.getElementById('cert-date').value = settings.certDate || new Date().toISOString().slice(0, 10);
    document.getElementById('cert-signature-person').value = settings.signaturePerson || 'kaprodi';
    document.getElementById('cert-kaprodi-name').value = settings.kaprodiName || '';
    document.getElementById('cert-kaprodi-title').value = settings.kaprodiTitle || 'Ketua Program Studi';
    document.getElementById('cert-kaprodi-nip').value = settings.kaprodiNip || '';
    document.getElementById('cert-koordinator-name').value = settings.koordinatorName || '';
    document.getElementById('cert-koordinator-title').value = settings.koordinatorTitle || 'Koordinator OSCE';
    document.getElementById('cert-koordinator-nip').value = settings.koordinatorNip || '';
    const previewImg = document.getElementById('cert-signature-preview');
    const placeholder = document.getElementById('cert-signature-placeholder');
    const clearBtn = document.getElementById('cert-clear-signature');
    if (settings.signatureImage) { previewImg.src = settings.signatureImage; previewImg.style.display = 'block'; placeholder.style.display = 'none'; clearBtn.classList.remove('d-none'); } else { previewImg.src = ''; previewImg.style.display = 'none'; placeholder.style.display = 'block'; clearBtn.classList.add('d-none'); }
    const bgPreviewImg = document.getElementById('cert-background-preview');
    const bgPlaceholder = document.getElementById('cert-background-placeholder');
    const bgClearBtn = document.getElementById('cert-clear-background');
    if (settings.backgroundImage) { bgPreviewImg.src = settings.backgroundImage; bgPreviewImg.style.display = 'block'; bgPlaceholder.style.display = 'none'; bgClearBtn.classList.remove('d-none'); } else { bgPreviewImg.src = ''; bgPreviewImg.style.display = 'none'; bgPlaceholder.style.display = 'block'; bgClearBtn.classList.add('d-none'); }
}
function saveCertificateSettings(e) {
    e.preventDefault();
    const signatureImageSrc = document.getElementById('cert-signature-preview').src;
    const backgroundImageSrc = document.getElementById('cert-background-preview').src;
    const settings = {
        institutionName: document.getElementById('cert-institution-name').value,
        certFormat: document.getElementById('cert-format').value,
        startNumber: parseInt(document.getElementById('cert-start-number').value),
        examDate: document.getElementById('cert-exam-date').value,
        venue: document.getElementById('cert-venue').value,
        certCity: document.getElementById('cert-city').value,
        certDate: document.getElementById('cert-date').value,
        signaturePerson: document.getElementById('cert-signature-person').value,
        signatureImage: signatureImageSrc.startsWith('data:image') ? signatureImageSrc : null,
        backgroundImage: backgroundImageSrc.startsWith('data:image') ? backgroundImageSrc : null,
        kaprodiName: document.getElementById('cert-kaprodi-name').value,
        kaprodiTitle: document.getElementById('cert-kaprodi-title').value,
        kaprodiNip: document.getElementById('cert-kaprodi-nip').value,
        koordinatorName: document.getElementById('cert-koordinator-name').value,
        koordinatorTitle: document.getElementById('cert-koordinator-title').value,
        koordinatorNip: document.getElementById('cert-koordinator-nip').value,
    };
    saveToStorage(CERT_SETTINGS_KEY, settings);
    alert('Pengaturan berhasil disimpan!');
}
function previewCertificateSignature(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = function(e) { const previewImg = document.getElementById('cert-signature-preview'); const placeholder = document.getElementById('cert-signature-placeholder'); const clearBtn = document.getElementById('cert-clear-signature'); previewImg.src = e.target.result; previewImg.style.display = 'block'; placeholder.style.display = 'none'; clearBtn.classList.remove('d-none'); }
    reader.readAsDataURL(file);
}
function clearCertificateSignature() { document.getElementById('cert-signature-file').value = ''; const previewImg = document.getElementById('cert-signature-preview'); const placeholder = document.getElementById('cert-signature-placeholder'); const clearBtn = document.getElementById('cert-clear-signature'); previewImg.src = ''; previewImg.style.display = 'none'; placeholder.style.display = 'block'; clearBtn.classList.add('d-none'); }
function previewCertificateBackground(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = function(e) { const previewImg = document.getElementById('cert-background-preview'); const placeholder = document.getElementById('cert-background-placeholder'); const clearBtn = document.getElementById('cert-clear-background'); previewImg.src = e.target.result; previewImg.style.display = 'block'; placeholder.style.display = 'none'; clearBtn.classList.remove('d-none'); }
    reader.readAsDataURL(file);
}
function clearCertificateBackground() { document.getElementById('cert-background-file').value = ''; const previewImg = document.getElementById('cert-background-preview'); const placeholder = document.getElementById('cert-background-placeholder'); const clearBtn = document.getElementById('cert-clear-background'); previewImg.src = ''; previewImg.style.display = 'none'; placeholder.style.display = 'block'; clearBtn.classList.add('d-none'); }
function loadCertificatePrintPage() {
    const collectivePassingGrade = getFromStorage('osce_collective_passing_grade') || 75;
    const peserta = getFromStorage('peserta').sort((a, b) => a.nama.localeCompare(b.nama));
    const scores = getFromStorage('scores'); const stations = getFromStorage('stations');
    const tableBody = document.getElementById('table-sertifikat-body'); tableBody.innerHTML = "";
    const excludedStationIds = getFromStorage('osce_excluded_stations') || [];
    if (peserta.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted p-4">Belum ada data peserta.</td></tr>`; return; }
    peserta.forEach(p => {
        const participantScores = scores.filter(s => s.pesertaId === p.id);
        const validScores = participantScores.filter(s => !excludedStationIds.includes(s.stationId));
        let averageScore = 0; let statusLulus = '<span class="badge bg-secondary">Belum Ujian</span>'; let progressHtml = 'N/A';
        if (validScores.length > 0) {
            let totalPercentageSum = 0;
            validScores.forEach(score => { const station = stations.find(s => s.id === score.stationId); if (station) { const { percentage } = calculateWeightedScore(score, station); totalPercentageSum += percentage; } });
            averageScore = totalPercentageSum / validScores.length;
            statusLulus = averageScore >= collectivePassingGrade ? '<span class="badge bg-success fs-6">Lulus</span>' : '<span class="badge bg-danger fs-6">Tidak Lulus</span>';
            progressHtml = `<div class="progress" role="progressbar" style="height:22px;font-size:0.9rem;"><div class="progress-bar ${averageScore >= collectivePassingGrade ? 'bg-success' : 'bg-danger'}" style="width:${averageScore.toFixed(1)}%;" aria-valuenow="${averageScore.toFixed(1)}" aria-valuemin="0" aria-valuemax="100">${averageScore.toFixed(2)}%</div></div>`;
        }
        tableBody.innerHTML += `<tr><td>${p.nim}</td><td><strong>${p.nama}</strong></td><td class="text-center">${progressHtml}</td><td class="text-center">${statusLulus}</td><td class="text-center"><button class="btn btn-sm btn-primary" onclick="printCertificate(${p.id})"><i class="fas fa-print"></i> Cetak Sertifikat</button></td></tr>`;
    });
}
function printCertificate(pesertaId) {
    const settings = getFromStorage(CERT_SETTINGS_KEY); if (!settings || !settings.certFormat) return alert("Pengaturan sertifikat belum diatur. Silakan atur di menu 'Pengaturan' terlebih dahulu.");
    const allPeserta = getFromStorage('peserta').sort((a,b) => a.nama.localeCompare(b.nama));
    const p = allPeserta.find(item => item.id === pesertaId); if (!p) return;
    const participantIndex = allPeserta.findIndex(item => item.id === pesertaId);
    const certNumber = (settings.startNumber || 1) + participantIndex;
    const formattedCertNumber = String(certNumber).padStart(3, '0') + '/' + settings.certFormat;
    const formattedCertDate = new Date(settings.certDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    let signatoryName, signatoryTitle, signatoryId;
    if (settings.signaturePerson === 'koordinator') { signatoryName = settings.koordinatorName || 'Koordinator OSCE'; signatoryTitle = settings.koordinatorTitle || 'Koordinator OSCE'; signatoryId = settings.koordinatorNip ? `NIP. ${settings.koordinatorNip}` : ''; } else { signatoryName = settings.kaprodiName || 'Ketua Program Studi'; signatoryTitle = settings.kaprodiTitle || `Ketua ${settings.institutionName || 'Program Studi'}`; signatoryId = settings.kaprodiNip ? `NIP. ${settings.kaprodiNip}` : ''; }
    let signatureElement = '<div class="signature-space"></div>';
    if (settings.signatureImage) signatureElement = `<div class="signature-image-container"><img src="${settings.signatureImage}" class="signature-image" alt="Tanda Tangan"></div>`;
    const backgroundStyle = settings.backgroundImage ? `url('${settings.backgroundImage}')` : `url('')`;
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Sertifikat - ${p.nama}</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Tinos',serif;color:#333;margin:0;}@page{size:A4 landscape;margin:0;}.certificate-container{width:297mm;height:210mm;box-sizing:border-box;position:relative;background-image:${backgroundStyle};background-size:cover;background-position:center;background-repeat:no-repeat;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.content-block{position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);width:90%;}h1{font-family:'Merriweather',serif;font-size:42pt;color:#1a335f;margin:0;text-transform:uppercase;}.cert-number{font-size:11pt;margin-top:5px;margin-bottom:15px;letter-spacing:1px;}.given-to{font-size:14pt;margin:0 0 5px 0;}.participant-name{font-family:'Merriweather',serif;font-size:30pt;font-weight:700;color:#b9863c;margin:5px 0 20px 0;}.main-text{font-size:13pt;line-height:1.6;max-width:75%;margin:10px auto;}.footer{position:absolute;bottom:90px;right:140px;width:350px;}.signature-block{text-align:center;width:100%;}.signature-block p{margin:0;line-height:1.5;font-size:12pt;}.signature-block .signatory-title{margin-top:8px;}.signature-space{height:75px;}.signature-image-container{height:75px;display:flex;align-items:center;justify-content:center;margin-bottom:5px;}.signature-image{max-height:100%;max-width:200px;height:auto;}.signature-line{width:80%;margin:2px auto 0 auto;border-bottom:1px solid #333;}.official-id{font-size:11pt;}</style></head><body><div class="certificate-container"><div class="content-block"><h1>Sertifikat</h1><p class="cert-number">Nomor: ${formattedCertNumber}</p><p class="given-to">Diberikan kepada:</p><p class="participant-name">${p.nama.toUpperCase()}</p><p class="main-text">Sebagai <strong>Peserta</strong> dalam kegiatan Objective Structured Clinical Examination (OSCE) yang diselenggarakan oleh <strong>${settings.institutionName || 'Program Studi D3 Kebidanan'}</strong> pada tanggal <strong>${settings.examDate}</strong>.</p></div><div class="footer"><div class="signature-block"><p>${settings.certCity}, ${formattedCertDate}</p><p class="signatory-title">${signatoryTitle}</p>${signatureElement}<p><strong>${signatoryName}</strong></p><p class="signature-line"></p><p class="official-id">${signatoryId}</p></div></div></div></body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}
function loadPengujiCertificatePage() {
    const penguji = getFromStorage('penguji'); const stations = getFromStorage('stations');
    const tableBody = document.getElementById('table-sertifikat-penguji-body'); tableBody.innerHTML = '';
    if (penguji.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Belum ada data penguji.</td></tr>`; return; }
    penguji.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(p => { const assignedStation = stations.find(s => s.id === p.assignedStationId); const stationName = assignedStation ? assignedStation.name : '<span class="text-muted fst-italic">Tidak Ditugaskan</span>'; tableBody.innerHTML += `<tr><td>${p.idPenguji}</td><td><strong>${p.nama}</strong></td><td>${stationName}</td><td class="text-center"><button class="btn btn-sm btn-primary" onclick="printPengujiCertificate(${p.id})"><i class="fas fa-print"></i> Cetak Sertifikat</button></td></tr>`; });
}
function generatePengujiCertificateHTML(pengujiId, allPengujiSorted) {
    const settings = getFromStorage(CERT_SETTINGS_KEY); if (!settings || !settings.certFormat) return null;
    const p = allPengujiSorted.find(item => item.id === pengujiId); if (!p) return null;
    const pengujiIndex = allPengujiSorted.findIndex(item => item.id === pengujiId);
    const certNumber = (settings.startNumber || 1) + pengujiIndex;
    const formattedCertNumber = String(certNumber).padStart(3, '0') + '/PENGUJI/' + settings.certFormat;
    const formattedCertDate = new Date(settings.certDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    let signatoryName, signatoryTitle, signatoryId;
    if (settings.signaturePerson === 'koordinator') { signatoryName = settings.koordinatorName || 'Koordinator OSCE'; signatoryTitle = settings.koordinatorTitle || 'Koordinator OSCE'; signatoryId = settings.koordinatorNip ? `NIP. ${settings.koordinatorNip}` : ''; } else { signatoryName = settings.kaprodiName || 'Ketua Program Studi'; signatoryTitle = settings.kaprodiTitle || `Ketua ${settings.institutionName || 'Program Studi'}`; signatoryId = settings.kaprodiNip ? `NIP. ${settings.kaprodiNip}` : ''; }
    let signatureElement = '<div class="signature-space"></div>';
    if (settings.signatureImage) signatureElement = `<div class="signature-image-container"><img src="${settings.signatureImage}" class="signature-image" alt="Tanda Tangan"></div>`;
    const backgroundStyle = settings.backgroundImage ? `url('${settings.backgroundImage}')` : `url('')`;
    return `<div class="certificate-container" style="background-image: ${backgroundStyle};"><div class="content-block"><h1>Sertifikat</h1><p class="cert-number">Nomor: ${formattedCertNumber}</p><p class="given-to">Diberikan kepada:</p><p class="participant-name">${p.nama.toUpperCase()}</p><p class="main-text">Sebagai <strong>Penguji</strong> dalam kegiatan Objective Structured Clinical Examination (OSCE) yang diselenggarakan oleh <strong>${settings.institutionName || 'Program Studi D3 Kebidanan'}</strong> pada tanggal <strong>${settings.examDate}</strong>.</p></div><div class="footer"><div class="signature-block"><p>${settings.certCity}, ${formattedCertDate}</p><p class="signatory-title">${signatoryTitle}</p>${signatureElement}<p><strong>${signatoryName}</strong></p><p class="signature-line"></p><p class="official-id">${signatoryId}</p></div></div></div>`;
}
function printPengujiCertificate(pengujiId) {
    const settings = getFromStorage(CERT_SETTINGS_KEY); if (!settings || !settings.certFormat) return alert("Pengaturan sertifikat belum diatur. Silakan atur di menu 'Pengaturan' terlebih dahulu.");
    const allPenguji = getFromStorage('penguji').sort((a, b) => a.nama.localeCompare(b.nama));
    const p = allPenguji.find(item => item.id === pengujiId); if (!p) return alert('Data penguji tidak ditemukan.');
    const certBodyHTML = generatePengujiCertificateHTML(pengujiId, allPenguji); if (!certBodyHTML) return;
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Sertifikat Penguji - ${p.nama}</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Tinos',serif;color:#333;margin:0;}@page{size:A4 landscape;margin:0;}.certificate-container{width:297mm;height:210mm;box-sizing:border-box;position:relative;background-size:cover;background-position:center;background-repeat:no-repeat;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.content-block{position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);width:90%;}h1{font-family:'Merriweather',serif;font-size:42pt;color:#1a335f;margin:0;text-transform:uppercase;}.cert-number{font-size:11pt;margin-top:5px;margin-bottom:15px;letter-spacing:1px;}.given-to{font-size:14pt;margin:0 0 5px 0;}.participant-name{font-family:'Merriweather',serif;font-size:30pt;font-weight:700;color:#b9863c;margin:5px 0 20px 0;}.main-text{font-size:13pt;line-height:1.6;max-width:75%;margin:10px auto;}.footer{position:absolute;bottom:90px;right:140px;width:350px;}.signature-block{text-align:center;width:100%;}.signature-block p{margin:0;line-height:1.5;font-size:12pt;}.signature-block .signatory-title{margin-top:8px;}.signature-space{height:75px;}.signature-image-container{height:75px;display:flex;align-items:center;justify-content:center;margin-bottom:5px;}.signature-image{max-height:100%;max-width:200px;height:auto;}.signature-line{width:80%;margin:2px auto 0 auto;border-bottom:1px solid #333;}.official-id{font-size:11pt;}</style></head><body>${certBodyHTML}</body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}
function printAllPengujiCertificates() {
    const allPenguji = getFromStorage('penguji').sort((a,b) => a.nama.localeCompare(b.nama));
    if (allPenguji.length === 0) return alert("Tidak ada data penguji untuk dicetak.");
    const settings = getFromStorage(CERT_SETTINGS_KEY); if (!settings || !settings.certFormat) return alert("Pengaturan sertifikat belum diatur. Silakan atur di menu 'Pengaturan' terlebih dahulu.");
    if (!confirm(`Anda akan mencetak sertifikat untuk ${allPenguji.length} penguji. Lanjutkan?`)) return;
    let allCertsHTML = '';
    allPenguji.forEach(p => { const certHtml = generatePengujiCertificateHTML(p.id, allPenguji); if (certHtml) allCertsHTML += certHtml; });
    if (!allCertsHTML) return alert("Gagal membuat sertifikat. Periksa pengaturan umum.");
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Sertifikat Penguji OSCE</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Tinos',serif;color:#333;margin:0;}@page{size:A4 landscape;margin:0;}.certificate-container{width:297mm;height:210mm;box-sizing:border-box;position:relative;background-size:cover;background-position:center;background-repeat:no-repeat;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;page-break-after:always;}.certificate-container:last-child{page-break-after:auto;}.content-block{position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);width:90%;}h1{font-family:'Merriweather',serif;font-size:42pt;color:#1a335f;margin:0;text-transform:uppercase;}.cert-number{font-size:11pt;margin-top:5px;margin-bottom:15px;letter-spacing:1px;}.given-to{font-size:14pt;margin:0 0 5px 0;}.participant-name{font-family:'Merriweather',serif;font-size:30pt;font-weight:700;color:#b9863c;margin:5px 0 20px 0;}.main-text{font-size:13pt;line-height:1.6;max-width:75%;margin:10px auto;}.footer{position:absolute;bottom:90px;right:140px;width:350px;}.signature-block{text-align:center;width:100%;}.signature-block p{margin:0;line-height:1.5;font-size:12pt;}.signature-block .signatory-title{margin-top:8px;}.signature-space{height:75px;}.signature-image-container{height:75px;display:flex;align-items:center;justify-content:center;margin-bottom:5px;}.signature-image{max-height:100%;max-width:200px;height:auto;}.signature-line{width:80%;margin:2px auto 0 auto;border-bottom:1px solid #333;}.official-id{font-size:11pt;}</style></head><body>${allCertsHTML}</body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}

// =================================================================
// SYSTEM LOGGING
// =================================================================
const LOG_KEY = 'osce_system_log';
const MAX_LOG_ENTRIES = 500;
function logActivity(action, details = '', userOverride = null) {
    try {
        let logs = getFromStorage(LOG_KEY) || [];
        const userSession = sessionStorage.getItem('osce_user');
        const user = userOverride ? { name: userOverride } : (userSession ? JSON.parse(userSession) : null);
        const userName = user ? (user.name || user.role) : 'Sistem';
        const logEntry = { timestamp: new Date().toISOString(), user: userName, action: action, details: details };
        logs.unshift(logEntry);
        if (logs.length > MAX_LOG_ENTRIES) logs.length = MAX_LOG_ENTRIES;
        saveToStorage(LOG_KEY, logs);
    } catch (error) { console.error("Gagal menulis log:", error); }
}
function loadSystemLog() {
    const logContainer = document.getElementById('log-container'); if (!logContainer) return;
    const logs = getFromStorage(LOG_KEY) || [];
    if (logs.length === 0) { logContainer.innerHTML = '<a href="#" class="list-group-item list-group-item-action disabled text-center text-muted">Belum ada aktivitas yang tercatat.</a>'; return; }
    const logIconMap = { 'CREATE': { icon: 'fa-plus-circle', color: 'text-success' }, 'UPDATE': { icon: 'fa-edit', color: 'text-warning' }, 'DELETE': { icon: 'fa-trash-alt', color: 'text-danger' }, 'LOGIN': { icon: 'fa-sign-in-alt', color: 'text-success' }, 'LOGOUT': { icon: 'fa-sign-out-alt', color: 'text-danger' }, 'SYNC': { icon: 'fa-sync-alt', color: 'text-info' }, 'BACKUP': { icon: 'fa-download', color: 'text-dark' }, 'RESTORE': { icon: 'fa-upload', color: 'text-primary' }, 'SUBMIT_SCORE': { icon: 'fa-save', color: 'text-primary' }, 'SCHEDULE': { icon: 'fa-calendar-alt', color: 'text-secondary' }, 'CLEAR': { icon: 'fa-eraser', color: 'text-danger' } };
    logContainer.innerHTML = logs.map(log => {
        const actionPrefix = log.action.split('_')[0]; const iconInfo = logIconMap[actionPrefix] || { icon: 'fa-info-circle', color: 'text-muted' };
        const formattedDate = new Date(log.timestamp).toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        return `<div class="list-group-item list-group-item-action"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 ${iconInfo.color}"><i class="fas ${iconInfo.icon} fa-fw me-2"></i>${log.action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h6><small class="text-muted">${formattedDate}</small></div><p class="mb-1 small">${log.details || 'Tidak ada detail.'}</p><small class="text-muted">Oleh: <strong>${log.user}</strong></small></div>`;
    }).join('');
}
function clearSystemLog() { if (!confirm("Anda yakin ingin menghapus semua catatan log? Tindakan ini tidak dapat diurungkan.")) return; saveToStorage(LOG_KEY, []); logActivity('CLEAR_LOG', 'Semua log telah dibersihkan.'); loadSystemLog(); alert("Log sistem berhasil dibersihkan."); }


// =================================================================
// BACKUP, RESTORE, IMPORT, EXPORT
// =================================================================
function backupLocalData() { const dataToBackup = { peserta: getFromStorage('peserta'), penguji: getFromStorage('penguji'), stations: getFromStorage('stations'), scores: getFromStorage('scores'), scheduleParams: getFromStorage('osce_schedule_params'), feedback: getFromStorage('feedback'), systemLog: getFromStorage(LOG_KEY), certSettings: getFromStorage(CERT_SETTINGS_KEY), backupDate: new Date().toISOString() }; const jsonString = JSON.stringify(dataToBackup, null, 2); const blob = new Blob([jsonString], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `osce_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); logActivity('BACKUP_DATA'); alert("Backup berhasil diunduh!"); }
function handleRestoreFile(event) { const file = event.target.files[0]; if (!file) return; if (!confirm("Ini akan MENIMPA semua data lokal saat ini dengan data dari file backup. Anda yakin?")) { event.target.value = null; return; } const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.peserta && data.penguji && data.stations && data.scores) { saveToStorage('peserta', data.peserta); saveToStorage('penguji', data.penguji); saveToStorage('stations', data.stations); saveToStorage('scores', data.scores); saveToStorage('osce_schedule_params', data.scheduleParams || {}); saveToStorage('feedback', data.feedback || []); saveToStorage(CERT_SETTINGS_KEY, data.certSettings || {}); if (data.systemLog) saveToStorage(LOG_KEY, data.systemLog); logActivity('RESTORE_DATA', `Data dipulihkan dari file: ${file.name}`); alert("Data berhasil dipulihkan dari file backup!"); loadPageContent(document.querySelector('.page.active').id); } else { alert("File backup tidak valid atau formatnya salah."); } } catch (error) { alert("Gagal membaca file backup. Error: " + error.message); } finally { event.target.value = null; } }; reader.readAsText(file); }
function importCSV(type, event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const text = e.target.result; const rows = text.trim().split('\n').slice(1); if (rows.length === 0) return alert("File CSV kosong atau tidak ada data."); let existingData = getFromStorage(type); const keyField = type === 'peserta' ? 'nim' : 'idPenguji'; let newItems = []; let duplicates = 0; rows.forEach(row => { const cols = row.split(',').map(s => s.trim().replace(/"/g, '')); if (cols.length < 2 || !cols[0] || !cols[1]) return; const idValue = cols[0]; const nameValue = cols[1]; if (!existingData.some(item => item[keyField] == idValue)) { const newItem = { id: Date.now() + newItems.length, nama: nameValue }; newItem[keyField] = idValue; if (type === 'peserta') { newItem.sesi = null; newItem.password = cols.length >= 3 && cols[2] ? cols[2].trim() : idValue; } if (type === 'penguji' && cols.length >= 3 && cols[2]) { const stationName = cols[2].trim(); const stations = getFromStorage('stations'); const station = stations.find(s => s.name.toLowerCase()=== stationName.toLowerCase()); if (station) newItem.assignedStationId = station.id; } newItems.push(newItem); } else { duplicates++; } }); if (newItems.length > 0) { if (confirm(`${newItems.length} data baru akan diimpor. ${duplicates} data duplikat dilewati. Lanjutkan?`)) { saveToStorage(type, [...existingData, ...newItems]); logActivity(`IMPORT_${type.toUpperCase()}`, `${newItems.length} data baru diimpor dari CSV.`); alert(`Impor berhasil! ${newItems.length} data baru ditambahkan.`); if (type === 'peserta') loadPeserta(); if (type === 'penguji') loadPenguji(); } } else { alert(`Tidak ada data baru untuk diimpor. ${duplicates} data duplikat ditemukan dan dilewati.`); } event.target.value = null; }; reader.readAsText(file); }
function triggerFileUpload(inputId) { document.getElementById(inputId).click(); }
function exportToCSV() {
    const scores = getFromStorage('scores'); if (scores.length === 0) return alert("Tidak ada data untuk diekspor.");
    const peserta = getFromStorage('peserta'); const penguji = getFromStorage('penguji'); const stations = getFromStorage('stations');
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "NIM,Nama Peserta,Station,Nama Penguji,Total Skor (Berbobot),Skor Maksimum (Berbobot),Persentase,Status Kelulusan,Global Performance,Komentar,Rincian Skor (Kriteria:Skor:Bobot)\n";
    scores.forEach(score => {
        const p = peserta.find(p => p.id === score.pesertaId); const u = penguji.find(u => u.id === score.pengujiId); const s = stations.find(s => s.id === score.stationId); if (!p || !u || !s) return;
        const { achieved, max, percentage } = calculateWeightedScore(score, s);
        const passingGrade = s.passingGrade || 75; const statusLulus = percentage >= passingGrade ? "Lulus" : "Tidak Lulus";
        const rincianSkor = score.scores.map(item => { const rubricItem = s.rubric.find(r => r.id === item.rubricId); const criteriaText = rubricItem ? rubricItem.criteria.replace(/,/g, "") : "N/A"; const bobot = rubricItem ? (rubricItem.bobot || 1) : 1; return `${criteriaText}:${item.score}:${bobot}`; }).join("; ");
        const row = [ p.nim, `"${p.nama}"`, `"${s.name}"`, `"${u.nama}"`, achieved, max, `${percentage.toFixed(2)}%`, statusLulus, score.globalPerformance || 'N/A', `"${(score.komentar || "").replace(/"/g, '""')}"`, `"${rincianSkor}"` ].join(",");
        csvContent += row + "\n";
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `hasil_ujian_osce_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
// =================================================================
// DATA CLEANUP & DELETION (REVISED FOR FEEDBACK)
// =================================================================
function deleteItem(key, id, callback) {
    if (!confirm("Yakin ingin menghapus item ini? Tindakan ini tidak dapat diurungkan.")) return;
    let data = getFromStorage(key);
    const itemToDelete = data.find(item => item.id === id);
    if (itemToDelete) {
        const detail = itemToDelete.nama || itemToDelete.nim || `ID ${id}`;
        logActivity(`DELETE_${key.toUpperCase()}`, `Item: ${detail}`);
    }
    data = data.filter(item => item.id !== id);
    saveToStorage(key, data);
    cleanupRelatedData(key, id);
    callback();
    // Refresh results page if active
    if(document.getElementById('page-hasil').classList.contains('active')) {
        const avgGpr100Value = renderGlobalPerformanceAnalysis();
        loadCollectiveResults(avgGpr100Value);
        displayStationRankings(); renderStationAnalyticsChart(); renderRubricPerformanceChart(); renderRubricDifficultyChart(); 
        renderSessionComparisonChart(); renderScoreVsGprChart(); loadRemedialRecommendations();
    }
}
function cleanupRelatedData(masterKey, masterId) {
    let scores = getFromStorage('scores');
    let feedback = getFromStorage('feedback');
    const relationMap = {
        peserta: 'pesertaId',
        stations: 'stationId',
        penguji: 'pengujiId'
    };
    if (relationMap[masterKey]) {
        scores = scores.filter(score => score[relationMap[masterKey]] !== masterId);
        saveToStorage('scores', scores);
    }
    if (masterKey === 'peserta') {
        feedback = feedback.filter(f => f.pesertaId !== masterId);
        saveToStorage('feedback', feedback);
    }
    if (masterKey === 'stations') {
        let penguji = getFromStorage('penguji');
        penguji.forEach(p => { if (p.assignedStationId === masterId) p.assignedStationId = null; });
        saveToStorage('penguji', penguji);
        // Also clean up feedback for the deleted station
        feedback.forEach(f => {
            f.feedbackItems = f.feedbackItems.filter(item => item.stationId !== masterId);
        });
        saveToStorage('feedback', feedback.filter(f => f.feedbackItems.length > 0));

        alert("Jadwal sesi semua peserta mungkin perlu digenerate ulang jika stasiun ini adalah bagian dari rotasi.");
    }
}

// =================================================================
// PARTICIPANT PAGES (REVISED FOR ACCURATE PASSING STATUS)
// =================================================================
function loadPesertaDashboard() {
    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    if (!user || user.role !== 'peserta') return;

    const allScores = getFromStorage('scores').filter(s => s.pesertaId === user.id);
    const totalStations = getFromStorage('stations').length;
    const completedStations = allScores.length;
    
    document.getElementById('peserta-progress-station').textContent = `${completedStations}/${totalStations}`;
    
    // **REVISED LOGIC**: Use the saved collective passing grade for consistency
    const collectivePassingGrade = getFromStorage('osce_collective_passing_grade') || 75; // Fallback to 75
    const excludedStationIds = getFromStorage('osce_excluded_stations') || [];
    const validScores = allScores.filter(s => !excludedStationIds.includes(s.stationId));
    
    const avgScoreEl = document.getElementById('peserta-avg-score');
    const statusEl = document.getElementById('peserta-status');

    if (validScores.length > 0) {
        let totalPercentageSum = 0;
        validScores.forEach(score => {
            const station = getFromStorage('stations').find(s => s.id === score.stationId);
            if (station) {
                const { percentage } = calculateWeightedScore(score, station);
                totalPercentageSum += percentage;
            }
        });
        const averageScore = totalPercentageSum / validScores.length;
        avgScoreEl.innerHTML = `${averageScore.toFixed(2)}<small>%</small>`;
        const isPassed = averageScore >= collectivePassingGrade;
        statusEl.textContent = isPassed ? 'Lulus' : 'Tidak Lulus';
        statusEl.parentElement.parentElement.parentElement.classList.remove('border-warning', 'border-success', 'border-danger');
        statusEl.parentElement.parentElement.parentElement.classList.add(isPassed ? 'border-success' : 'border-danger');
    } else {
        avgScoreEl.textContent = 'N/A';
        statusEl.textContent = 'Belum Dinilai';
        statusEl.parentElement.parentElement.parentElement.classList.remove('border-success', 'border-danger');
        statusEl.parentElement.parentElement.parentElement.classList.add('border-warning');
    }

    loadFeedbackFormForParticipant(user.id);
}


function loadPesertaHasil() {
    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    if (!user || user.role !== 'peserta') return;
    
    const container = document.getElementById('peserta-hasil-content');
    const p = getFromStorage('peserta').find(item => item.id === user.id);
    const allScores = getFromStorage('scores').filter(s => s.pesertaId === user.id);
    const stations = getFromStorage('stations');

    if (allScores.length === 0) {
        container.innerHTML = `<div class="alert alert-info text-center"><i class="fas fa-clock me-2"></i>Hasil penilaian Anda akan muncul di sini setelah dinilai oleh penguji.</div>`;
        return;
    }

    const modalBody = document.createElement('div');
    modalBody.id = 'participantDetailModalBody';
    container.innerHTML = '';
    container.appendChild(modalBody);
    
    showParticipantDetails(user.id);
    participantDetailModal.hide();
    const modalFooter = modalBody.querySelector('.modal-footer');
    if(modalFooter) modalFooter.remove();
    const modalTitle = document.getElementById('participantDetailModalLabel');
    modalTitle.textContent = `Hasil & Umpan Balik Ujian Anda`;
    modalBody.prepend(modalTitle);
    modalTitle.className = 'h2 mb-4';
    // Remove the now-redundant button from the modal-body since it's a page now.
    const printBtnOnPage = modalBody.querySelector('#print-participant-result-btn');
    if (printBtnOnPage) {
        const newPrintButton = document.createElement('button');
        newPrintButton.className = 'btn btn-primary mb-4';
        newPrintButton.innerHTML = '<i class="fas fa-print"></i> Cetak Hasil Lengkap';
        newPrintButton.onclick = () => printParticipantResult(user.id);
        modalBody.insertBefore(newPrintButton, modalBody.querySelector('.row'));
        printBtnOnPage.remove();
    }
}


function loadPesertaSertifikat() {
    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    if (!user || user.role !== 'peserta') return;

    const container = document.getElementById('peserta-sertifikat-content');
    const collectivePassingGrade = getFromStorage('osce_collective_passing_grade') || 75;
    const excludedStationIds = getFromStorage('osce_excluded_stations') || [];
    const allScores = getFromStorage('scores').filter(s => s.pesertaId === user.id);
    const validScores = allScores.filter(s => !excludedStationIds.includes(s.stationId));
    
    const REQUIRED_STATIONS_FOR_COMPLETION = 9;

    if (validScores.length < REQUIRED_STATIONS_FOR_COMPLETION) {
        container.innerHTML = `<i class="fas fa-clock fa-3x text-info mb-3"></i><h4>Sertifikat Belum Tersedia</h4><p class="text-muted">Sertifikat akan dapat diunduh setelah Anda menyelesaikan minimal ${REQUIRED_STATIONS_FOR_COMPLETION} stasiun ujian dan memenuhi kriteria kelulusan.</p>`;
        return;
    }

    let totalPercentageSum = 0;
    validScores.forEach(score => {
        const station = getFromStorage('stations').find(s => s.id === score.stationId);
        if (station) {
            const { percentage } = calculateWeightedScore(score, station);
            totalPercentageSum += percentage;
        }
    });
    const averageScore = totalPercentageSum / validScores.length;

    if (averageScore >= collectivePassingGrade) {
        container.innerHTML = `<i class="fas fa-check-circle fa-3x text-success mb-3"></i><h4>Selamat, Anda Lulus!</h4><p class="text-muted">Anda telah memenuhi kriteria kelulusan. Silakan unduh sertifikat Anda.</p><button class="btn btn-primary btn-lg mt-3" onclick="printCertificate(${user.id})"><i class="fas fa-download me-2"></i> Unduh Sertifikat</button>`;
    } else {
        container.innerHTML = `<i class="fas fa-times-circle fa-3x text-danger mb-3"></i><h4>Mohon Maaf</h4><p class="text-muted">Berdasarkan hasil ujian, Anda belum memenuhi kriteria kelulusan untuk saat ini. Silakan hubungi koordinator ujian untuk informasi lebih lanjut.</p>`;
    }
}


// =================================================================
// FEEDBACK SYSTEM
// =================================================================
function loadFeedbackFormForParticipant(pesertaId) {
    const container = document.getElementById('peserta-feedback-container');
    const allFeedback = getFromStorage('feedback');
    const hasSubmitted = allFeedback.some(f => f.pesertaId === pesertaId);

    if (hasSubmitted) {
        container.innerHTML = `<div class="alert alert-success text-center"><i class="fas fa-check-circle me-2"></i>Terima kasih! Anda telah mengirimkan umpan balik.</div>`;
        return;
    }

    const scores = getFromStorage('scores').filter(s => s.pesertaId === pesertaId);
    const REQUIRED_STATIONS_FOR_COMPLETION = 9;
    if (scores.length < REQUIRED_STATIONS_FOR_COMPLETION) {
        container.innerHTML = `<div class="alert alert-info text-center"><i class="fas fa-info-circle me-2"></i>Formulir umpan balik akan tersedia di sini setelah Anda menyelesaikan ujian.</div>`;
        return;
    }

    const stations = getFromStorage('stations');
    const attendedStationIds = new Set(scores.map(s => s.stationId));
    let formHtml = `
        <div class="card border-primary">
            <div class="card-header bg-primary text-white"><i class="fas fa-comment-dots me-2"></i><strong>Umpan Balik Pasca Ujian</strong></div>
            <div class="card-body">
                <p>Ujian Anda telah selesai. Mohon berikan umpan balik Anda untuk setiap stasiun yang telah diikuti untuk membantu kami meningkatkan kualitas OSCE di masa mendatang.</p>
                <form id="form-submit-feedback">`;

    attendedStationIds.forEach(stationId => {
        const station = stations.find(s => s.id === stationId);
        if (station) {
            formHtml += `
                <div class="mb-4 p-3 border rounded">
                    <h6 class="fw-bold">${station.name}</h6>
                    <label class="form-label">Tingkat Kepuasan:</label>
                    <div class="star-rating mb-2">
                        <input type="radio" id="5-stars-${station.id}" name="rating-${station.id}" value="5" required/><label for="5-stars-${station.id}" class="star">‚òÖ</label>
                        <input type="radio" id="4-stars-${station.id}" name="rating-${station.id}" value="4" /><label for="4-stars-${station.id}" class="star">‚òÖ</label>
                        <input type="radio" id="3-stars-${station.id}" name="rating-${station.id}" value="3" /><label for="3-stars-${station.id}" class="star">‚òÖ</label>
                        <input type="radio" id="2-stars-${station.id}" name="rating-${station.id}" value="2" /><label for="2-stars-${station.id}" class="star">‚òÖ</label>
                        <input type="radio" id="1-star-${station.id}" name="rating-${station.id}" value="1" /><label for="1-star-${station.id}" class="star">‚òÖ</label>
                    </div>
                    <label for="comment-${station.id}" class="form-label">Komentar/Saran (Opsional):</label>
                    <textarea id="comment-${station.id}" class="form-control form-control-sm" rows="2" placeholder="Masukkan komentar Anda untuk stasiun ini..."></textarea>
                </div>`;
        }
    });

    formHtml += `<button type="submit" class="btn btn-success w-100"><i class="fas fa-paper-plane me-2"></i>Kirim Umpan Balik</button></form></div></div>`;
    container.innerHTML = formHtml;
    document.getElementById('form-submit-feedback').addEventListener('submit', submitFeedback);
}

async function submitFeedback(e) {
    e.preventDefault();
    const form = e.target;
    const submitButton = form.querySelector('button[type="submit"]');
    const originalButtonHTML = submitButton.innerHTML;

    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...`;

    const user = JSON.parse(sessionStorage.getItem('osce_user'));
    if (!user) {
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonHTML;
        return;
    }
    
    const feedbackItems = [];
    const scores = getFromStorage('scores').filter(s => s.pesertaId === user.id);
    const attendedStationIds = new Set(scores.map(s => s.stationId));

    let allRatingsFilled = true;
    attendedStationIds.forEach(stationId => {
        const rating = form.querySelector(`input[name="rating-${stationId}"]:checked`);
        const comment = form.querySelector(`#comment-${stationId}`).value.trim();
        if (rating) {
            feedbackItems.push({
                stationId: parseInt(stationId),
                rating: parseInt(rating.value),
                comment: comment
            });
        } else {
            allRatingsFilled = false;
        }
    });

    if (!allRatingsFilled) {
        alert("Harap berikan rating (bintang) untuk semua stasiun.");
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonHTML;
        return;
    }

    const allFeedback = getFromStorage('feedback');
    const newFeedback = {
        id: Date.now(),
        pesertaId: user.id,
        submittedAt: new Date().toISOString(),
        feedbackItems: feedbackItems
    };

    allFeedback.push(newFeedback);
    saveToStorage('feedback', allFeedback);
    logActivity('SUBMIT_FEEDBACK', `Peserta ID: ${user.id}`);

    try {
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mengirim ke server...`;
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            body: JSON.stringify({ type: 'add_feedback', payload: newFeedback })
        });

        if (!response.ok) throw new Error(`Server merespons dengan status ${response.status}`);
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message || 'Server mengembalikan error.');

        submitButton.innerHTML = `<i class="fas fa-check-circle"></i> Terkirim!`;
        alert("Umpan balik berhasil dikirim. Terima kasih atas partisipasi Anda!");

    } catch (error) {
        console.error("Gagal mengirim umpan balik ke server:", error);
        submitButton.classList.replace('btn-success', 'btn-warning');
        submitButton.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Gagal Kirim`;
        alert("Umpan balik berhasil disimpan di perangkat ini, tetapi GAGAL dikirim ke server. Data akan disinkronkan oleh admin nanti. Terima kasih!");
    }
    
    setTimeout(() => {
        loadPesertaDashboard();
    }, 2000);
}


function loadFeedbackSummary() {
    renderFeedbackRatingChart();
    renderFeedbackCompletionChart();
    const container = document.getElementById('feedback-comments-container');
    const allFeedback = getFromStorage('feedback');
    const stations = getFromStorage('stations');

    if (allFeedback.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">Belum ada umpan balik yang dikirimkan oleh peserta.</p>';
        return;
    }

    const commentsByStation = {};
    allFeedback.forEach(f => {
        f.feedbackItems.forEach(item => {
            if (!commentsByStation[item.stationId]) {
                commentsByStation[item.stationId] = [];
            }
            if (item.comment) {
                commentsByStation[item.stationId].push(item.comment);
            }
        });
    });

    let accordionHtml = '<div class="accordion" id="accordionFeedbackComments">';
    stations.forEach(station => {
        const comments = commentsByStation[station.id] || [];
        if (comments.length > 0) {
            accordionHtml += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${station.id}">
                            ${station.name} <span class="badge bg-secondary ms-2">${comments.length} komentar</span>
                        </button>
                    </h2>
                    <div id="collapse-${station.id}" class="accordion-collapse collapse" data-bs-parent="#accordionFeedbackComments">
                        <div class="accordion-body">
                            <ul class="list-group">
                                ${comments.map(c => `<li class="list-group-item">"${c}"</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>`;
        }
    });
    accordionHtml += '</div>';
    
    container.innerHTML = accordionHtml;
}

function renderFeedbackRatingChart() {
    const chartCanvas = document.getElementById('feedback-rating-chart');
    const fallback = document.getElementById('feedback-rating-fallback');
    const allFeedback = getFromStorage('feedback');
    const stations = getFromStorage('stations');

    if (allFeedback.length === 0) {
        chartCanvas.style.display = 'none';
        fallback.classList.remove('d-none');
        if(feedbackRatingChartInstance) feedbackRatingChartInstance.destroy();
        return;
    }

    chartCanvas.style.display = 'block';
    fallback.classList.add('d-none');

    const ratingsByStation = {}; 
    allFeedback.forEach(f => {
        f.feedbackItems.forEach(item => {
            if (!ratingsByStation[item.stationId]) {
                ratingsByStation[item.stationId] = { total: 0, count: 0 };
            }
            ratingsByStation[item.stationId].total += item.rating;
            ratingsByStation[item.stationId].count++;
        });
    });

    const chartData = stations.map(station => {
        const data = ratingsByStation[station.id];
        return {
            name: station.name,
            avgRating: data ? (data.total / data.count) : 0
        }
    }).filter(d => d.avgRating > 0).sort((a,b) => a.name.localeCompare(b.name));

    const ctx = chartCanvas.getContext('2d');
    if (feedbackRatingChartInstance) feedbackRatingChartInstance.destroy();
    
    feedbackRatingChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(d => d.name),
            datasets: [{
                label: 'Rata-rata Rating',
                data: chartData.map(d => d.avgRating.toFixed(2)),
                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            scales: { x: { beginAtZero: true, max: 5, ticks: { stepSize: 1 } } },
            plugins: { legend: { display: false } }
        }
    });
}

function renderFeedbackCompletionChart() {
    const chartCanvas = document.getElementById('feedback-completion-chart');
    const fallback = document.getElementById('feedback-completion-fallback');
    const allFeedback = getFromStorage('feedback');
    const allScores = getFromStorage('scores');
    
    const REQUIRED_STATIONS_FOR_COMPLETION = 9;
    const scoresByPeserta = allScores.reduce((acc, score) => {
        if (!acc[score.pesertaId]) acc[score.pesertaId] = new Set();
        acc[score.pesertaId].add(score.stationId);
        return acc;
    }, {});

    const completedPesertaIds = Object.keys(scoresByPeserta).filter(id => scoresByPeserta[id].size >= REQUIRED_STATIONS_FOR_COMPLETION);

    if (completedPesertaIds.length === 0) {
        chartCanvas.style.display = 'none';
        fallback.classList.remove('d-none');
        if(feedbackCompletionChartInstance) feedbackCompletionChartInstance.destroy();
        return;
    }

    chartCanvas.style.display = 'block';
    fallback.classList.add('d-none');

    const submittedCount = allFeedback.filter(f => completedPesertaIds.includes(String(f.pesertaId))).length;
    const notSubmittedCount = completedPesertaIds.length - submittedCount;

    const ctx = chartCanvas.getContext('2d');
    if (feedbackCompletionChartInstance) feedbackCompletionChartInstance.destroy();

    feedbackCompletionChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Sudah Mengisi', 'Belum Mengisi'],
            datasets: [{
                data: [submittedCount, notSubmittedCount],
                backgroundColor: ['rgba(25, 135, 84, 0.8)', 'rgba(220, 53, 69, 0.8)'],
                borderColor: ['#198754', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } }
        }
    });
}


// =================================================================
// PRINTING FUNCTIONS
// =================================================================
function printElement(elementId, title) {
    const sourceElement = document.getElementById(elementId);
    if (!sourceElement) { console.error("Elemen untuk dicetak tidak ditemukan:", elementId); return; }
    const printContentNode = sourceElement.cloneNode(true);
    const canvas = sourceElement.querySelector('canvas');
    if (canvas && canvas.style.display !== 'none') {
        const image = new Image(); image.src = canvas.toDataURL('image/png');
        image.style.maxWidth = '100%'; image.style.height = 'auto';
        const canvasClone = printContentNode.querySelector('canvas');
        if (canvasClone) canvasClone.parentNode.replaceChild(image, canvasClone);
    }
    if (elementId === 'station-ranking-container') { Array.from(printContentNode.children).forEach(col => { col.style.width = '100%'; col.style.marginBottom = '20px'; col.className = ''; }); printContentNode.className = ''; }
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><title>${title}</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"><style>@page{size:A4;margin:2cm;}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.card-header{border-bottom:1px solid #dee2e6!important;}.card{border:1px solid #dee2e6!important;margin-bottom:1.5rem;}h1,.print-title{font-size:20pt;text-align:center;margin-bottom:1rem;}img{max-width:100%;height:auto;}</style></head><body><h1 class="print-title">${title}</h1>${printContentNode.innerHTML}</body></html>`);
    printWindow.document.close(); printWindow.focus();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
}
function generateExamCardHTML(p) {
    if (!p || !p.sesi) return '';
    const fullSchedule = calculateFullSchedule();
    const participantSchedule = fullSchedule.filter(item => item.peserta.id === p.id).sort((a,b) => a.date - b.date || a.rotasi - b.rotasi);
    if (participantSchedule.length === 0) return '';
    let scheduleRows = '';
    participantSchedule.forEach(item => { scheduleRows += `<tr><td>${item.date.toLocaleDateString('id-ID')}</td><td style="text-align:center;">${item.rotasi}</td><td style="text-align:center;">${item.waktuMulai} - ${item.waktuSelesai}</td><td>${item.station.name}</td></tr>`; });
    const settings = getFromStorage(CERT_SETTINGS_KEY) || {};
    const institutionName = settings.institutionName || 'D3 KEBIDANAN';
    return `<div class="card-container"><div class="header"><h1>KARTU UJIAN OSCE</h1><h2>${institutionName.toUpperCase()}</h2></div><table class="info-table"><tr><td>Nama Peserta</td><td>: ${p.nama}</td></tr><tr><td>NIM</td><td>: ${p.nim}</td></tr><tr><td>Sesi Ujian</td><td>: ${p.sesi}</td></tr></table><table class="schedule-table"><thead><tr><th>Tanggal</th><th style="text-align:center;">Rotasi Ke</th><th style="text-align:center;">Waktu</th><th>Nama Station</th></tr></thead><tbody>${scheduleRows}</tbody></table><p style="margin-top:2em;font-size:9pt;text-align:center;"><em>* Harap hadir 15 menit sebelum sesi ujian dimulai. Bawa kartu identitas diri.</em></p></div>`;
}
function printAllExamCards() {
    const allPeserta = getFromStorage('peserta'); const scheduledPeserta = allPeserta.filter(p => p.sesi);
    if (scheduledPeserta.length === 0) return alert('Tidak ada peserta yang memiliki jadwal ujian. Silakan generate jadwal terlebih dahulu.');
    if (!confirm(`Anda akan mencetak kartu ujian untuk ${scheduledPeserta.length} peserta. Ini dapat membuka banyak halaman di dialog cetak Anda. Lanjutkan?`)) return;
    let allCardsHTML = '';
    scheduledPeserta.sort((a, b) => (a.sesi - b.sesi) || a.nama.localeCompare(b.nama)).forEach(p => { allCardsHTML += generateExamCardHTML(p); });
    if (allCardsHTML === '') return alert('Gagal menghasilkan kartu ujian. Periksa kembali data jadwal.');
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Semua Kartu Ujian OSCE</title><style>@page{size:A4 portrait;margin:1cm;}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-size:11pt;margin:0;}.card-container{border:2px solid #000;padding:1.5cm;margin:0 auto;width:100%;max-width:18cm;box-sizing:border-box;page-break-inside:avoid;page-break-after:always;}body > .card-container:last-child{page-break-after:auto;}.header{text-align:center;margin-bottom:1.5em;}h1{font-size:16pt;margin-bottom:0.2em;}h2{font-size:12pt;margin:0;font-weight:normal;}.info-table{width:100%;margin-bottom:1.5em;border-collapse:collapse;}.info-table td{padding:4px 0;vertical-align:top;}.info-table td:first-child{width:120px;font-weight:bold;}.schedule-table{width:100%;border-collapse:collapse;}.schedule-table th,.schedule-table td{border:1px solid #999;padding:8px;text-align:left;}.schedule-table th{background-color:#e9ecef;}</style></head><body>${allCardsHTML}</body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
}
function printExamCard(pesertaId) {
    const p = getFromStorage('peserta').find(item => item.id === pesertaId);
    if (!p) return alert('Data peserta tidak ditemukan.');
    if (!p.sesi) return alert('Peserta ini belum memiliki jadwal sesi. Silakan generate jadwal terlebih dahulu.');
    const cardHTML = generateExamCardHTML(p);
    if (!cardHTML) return alert('Tidak ditemukan detail jadwal untuk peserta ini.');
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Kartu Ujian OSCE - ${p.nama}</title><style>@page{size:A4 portrait;margin:1cm;}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-size:11pt;margin:0;}.card-container{border:2px solid #000;padding:1.5cm;margin:0 auto;width:100%;max-width:18cm;box-sizing:border-box;}.header{text-align:center;margin-bottom:1.5em;}h1{font-size:16pt;margin-bottom:0.2em;}h2{font-size:12pt;margin:0;font-weight:normal;}.info-table{width:100%;margin-bottom:1.5em;border-collapse:collapse;}.info-table td{padding:4px 0;vertical-align:top;}.info-table td:first-child{width:120px;font-weight:bold;}.schedule-table{width:100%;border-collapse:collapse;}.schedule-table th,.schedule-table td{border:1px solid #999;padding:8px;text-align:left;}.schedule-table th{background-color:#e9ecef;}</style></head><body>${cardHTML}</body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
}
function printExamReport() {
    const settings = getFromStorage(CERT_SETTINGS_KEY);
    if (!settings.examDate || !settings.venue || !settings.kaprodiName) return alert("Data tidak lengkap. Harap isi Tanggal Ujian, Lokasi, dan Nama Ketua Prodi di halaman Pengaturan.");
    const peserta = getFromStorage('peserta'); const scores = getFromStorage('scores'); const attendedPesertaIds = new Set(scores.map(s => s.pesertaId));
    const pesertaTidakHadirList = peserta.filter(p => !attendedPesertaIds.has(p.id));
    const totalPeserta = peserta.length; const pesertaHadir = attendedPesertaIds.size; const pesertaTidakHadirCount = pesertaTidakHadirList.length;
    let absentListHtml = '<p>Daftar peserta yang tidak hadir: Tidak ada.</p>';
    if (pesertaTidakHadirList.length > 0) { absentListHtml = `<p>Daftar nama peserta yang tidak hadir:</p><ol style="margin-left:2em;">`; pesertaTidakHadirList.forEach(p => { absentListHtml += `<li>${p.nama} (${p.nim})</li>`; }); absentListHtml += `</ol>`; }
    const formattedDate = new Date(settings.certDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    const institutionName = settings.institutionName || 'Program Studi D3 Kebidanan, Poltekkes Kemenkes Kupang';
    const kaprodiTitle = settings.kaprodiTitle || 'Ketua Program Studi';
    const kaprodiNip = settings.kaprodiNip ? `NIP. ${settings.kaprodiNip}` : '';
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Berita Acara Pelaksanaan Ujian OSCE</title><style>body{font-family:'Times New Roman',Times,serif;font-size:12pt;line-height:1.5;}.container{width:80%;margin:auto;}.header{text-align:center;}h1{font-size:14pt;margin-bottom:5px;text-transform:uppercase;text-decoration:underline;}p{text-align:justify;margin-top:1.5em;margin-bottom:1.5em;}table.details{margin-left:2em;}table.details td{padding:2px 5px;}.signature-block{margin-top:5em;float:right;text-align:center;}@page{size:A4;margin:2.5cm;}</style></head><body><div class="container"><div class="header"><h1>BERITA ACARA PELAKSANAAN UJIAN OSCE</h1></div><p>Pada hari ini, ${settings.examDate}, telah dilaksanakan Ujian Objective Structured Clinical Examination (OSCE) yang diselenggarakan oleh ${institutionName}.</p><p>Ujian ini dilaksanakan sesuai dengan jadwal yang telah ditentukan dan berlangsung di ${settings.venue}.</p><p>Adapun rincian pelaksanaan ujian adalah sebagai berikut:</p><table class="details"><tr><td>Jumlah peserta yang terdaftar</td><td>:</td><td>${totalPeserta} orang</td></tr><tr><td>Jumlah peserta yang hadir</td><td>:</td><td>${pesertaHadir} orang</td></tr><tr><td>Jumlah peserta yang tidak hadir</td><td>:</td><td>${pesertaTidakHadirCount} orang</td></tr></table>${absentListHtml}<p>Ujian berjalan dengan tertib dan lancar sesuai dengan prosedur dan standar operasional yang telah ditetapkan. Seluruh stasiun OSCE telah digunakan sebagaimana mestinya dan proses penilaian dilakukan oleh para dosen/penguji sesuai dengan rubrik penilaian yang berlaku.</p><p>Demikian berita acara ini dibuat dengan sebenarnya untuk dapat digunakan sebagaimana mestinya.</p><div class="signature-block"><p>${settings.certCity}, ${formattedDate}</p><p>${kaprodiTitle}</p><br><br><br><br><p><strong>${settings.kaprodiName}</strong></p><p>${kaprodiNip}</p></div></div></body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}
function printExaminerAttendance() {
    const settings = getFromStorage(CERT_SETTINGS_KEY); if (!settings.koordinatorName) return alert("Harap isi Nama Koordinator OSCE di halaman Pengaturan terlebih dahulu.");
    const penguji = getFromStorage('penguji'); const stations = getFromStorage('stations'); const scores = getFromStorage('scores');
    if (penguji.length === 0) return alert("Tidak ada data penguji untuk dicetak.");
    const stationMap = new Map(stations.map(s => [s.id, s.name]));
    penguji.sort((a,b) => (stationMap.get(a.assignedStationId) || 'zzzz').localeCompare(stationMap.get(b.assignedStationId) || 'zzzz'));
    let tableRows = '';
    penguji.forEach((p, index) => { const gradedCount = new Set(scores.filter(s => s.pengujiId === p.id).map(s => s.pesertaId)).size; tableRows += `<tr><td style="text-align:center;">${index + 1}</td><td>${p.nama}</td><td>${p.idPenguji}</td><td>${stationMap.get(p.assignedStationId) || '<i style="color:gray;">Belum Ditugaskan</i>'}</td><td style="text-align:center;">${gradedCount}</td><td style="width:25%;">${index + 1}. ......................................</td></tr>`; });
    const formattedDate = new Date(settings.certDate || new Date()).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    const institutionName = settings.institutionName || 'PRODI D3 KEBIDANAN';
    const koordinatorTitle = settings.koordinatorTitle || 'Koordinator OSCE';
    const koordinatorNip = settings.koordinatorNip ? `NIP. ${settings.koordinatorNip}` : '';
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Daftar Hadir Penguji OSCE</title><style>body{font-family:'Times New Roman',Times,serif;font-size:12pt;}.container{width:90%;margin:auto;}.header{text-align:center;}h1{font-size:14pt;margin-bottom:5px;text-transform:uppercase;}h2{font-size:13pt;font-weight:normal;margin-top:0;}table{width:100%;border-collapse:collapse;margin-top:1.5em;}th,td{border:1px solid black;padding:8px;vertical-align:top;}th{text-align:center;background-color:#f2f2f2;}.signature-block{margin-top:3em;float:right;text-align:center;}@page{size:A4;margin:2cm;}</style></head><body><div class="container"><div class="header"><h1>DAFTAR HADIR PENGUJI</h1><h2>UJIAN OBJECTIVE STRUCTURED CLINICAL EXAMINATION (OSCE)<br>${institutionName.toUpperCase()}</h2></div><table><thead><tr><th>NO</th><th>NAMA LENGKAP & GELAR</th><th>NIDN/ID</th><th>STASIUN</th><th>JML. DINILAI</th><th>TANDA TANGAN</th></tr></thead><tbody>${tableRows}</tbody></table><div class="signature-block"><p>${settings.certCity || 'Kupang'}, ${formattedDate}</p><p>${koordinatorTitle}</p><br><br><br><br><p><strong>${settings.koordinatorName}</strong></p><p>${koordinatorNip}</p></div></div></body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}
function printStudentAttendance() {
    const settings = getFromStorage(CERT_SETTINGS_KEY); const peserta = getFromStorage('peserta');
    const scheduledPeserta = peserta.filter(p => p.sesi);
    if (scheduledPeserta.length === 0) return alert("Tidak ada peserta yang memiliki jadwal. Silakan generate jadwal terlebih dahulu.");
    if (!settings.koordinatorName) return alert("Harap isi Nama Koordinator OSCE di halaman Pengaturan terlebih dahulu.");
    const pesertaBySession = scheduledPeserta.reduce((acc, p) => { const sesi = p.sesi || 'Unscheduled'; if (!acc[sesi]) acc[sesi] = []; acc[sesi].push(p); return acc; }, {});
    const sortedSessionKeys = Object.keys(pesertaBySession).sort((a,b) => parseInt(a) - parseInt(b));
    let allSessionsHtml = '';
    sortedSessionKeys.forEach(sesi => {
        const sessionPeserta = pesertaBySession[sesi].sort((a, b) => a.nama.localeCompare(b.nama)); let tableRows = '';
        sessionPeserta.forEach((p, index) => { tableRows += `<tr><td style="text-align:center;">${index + 1}</td><td>${p.nim}</td><td>${p.nama}</td><td style="width:35%;"></td></tr>`; });
        allSessionsHtml += `<div class="session-block"><h3>SESI ${sesi}</h3><table><thead><tr><th>NO</th><th>NIM</th><th>NAMA LENGKAP</th><th>TANDA TANGAN</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
    });
    const formattedDate = new Date(settings.certDate || new Date()).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    const institutionName = settings.institutionName || 'PRODI D3 KEBIDANAN';
    const koordinatorTitle = settings.koordinatorTitle || 'Koordinator OSCE';
    const koordinatorNip = settings.koordinatorNip ? `NIP. ${settings.koordinatorNip}` : '';
    const printContent = `<!DOCTYPE html><html lang="id"><head><title>Daftar Hadir Peserta OSCE</title><style>body{font-family:'Times New Roman',Times,serif;font-size:12pt;}.container{width:90%;margin:auto;}.header{text-align:center;}h1{font-size:14pt;margin-bottom:5px;text-transform:uppercase;}h2{font-size:13pt;font-weight:normal;margin-top:0;}h3{font-size:12pt;margin-top:1em;margin-bottom:0.5em;text-decoration:underline;}.session-block{page-break-inside:avoid;margin-bottom:2em;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid black;padding:8px;vertical-align:top;}th{text-align:center;background-color:#f2f2f2;}.signature-block{margin-top:3em;float:right;text-align:center;}@page{size:A4;margin:2cm;}</style></head><body><div class="container"><div class="header"><h1>DAFTAR HADIR PESERTA</h1><h2>UJIAN OBJECTIVE STRUCTURED CLINICAL EXAMINATION (OSCE)<br>${institutionName.toUpperCase()}</h2></div>${allSessionsHtml}<div class="signature-block"><p>${settings.certCity || 'Kupang'}, ${formattedDate}</p><p>${koordinatorTitle}</p><br><br><br><br><p><strong>${settings.koordinatorName}</strong></p><p>${koordinatorNip}</p></div></div></body></html>`;
    const printWindow = window.open('', '_blank'); printWindow.document.write(printContent); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500);
}

</script>
</body>
</html>
